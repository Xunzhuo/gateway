
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>TLS Passthrough &#8212; Envoy Gateway  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Design Docs" href="../design_docs.html" />
    <link rel="prev" title="Secure Gateways" href="secure-gateways.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="tls-passthrough">
<h1>TLS Passthrough<a class="headerlink" href="#tls-passthrough" title="Permalink to this heading">¶</a></h1>
<p>This guide will walk through the steps required to configure TLS Passthrough via Envoy Gateway. Unlike configuring
Secure Gateways, where the Gateway terminates the client TLS connection, TLS Passthrough allows the application itself
to terminate the TLS connection, while the Gateway routes the requests to the application based on SNI headers.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>OpenSSL to generate TLS assets.</p></li>
</ul>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h2>
<p>Follow the steps from the <a class="reference internal" href="quickstart.html"><span class="doc std std-doc">Quickstart Guide</span></a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p>
</section>
<section id="tls-certificates">
<h2>TLS Certificates<a class="headerlink" href="#tls-certificates" title="Permalink to this heading">¶</a></h2>
<p>Generate the certificates and keys used by the Service to terminate client TLS connections.
For the application, we’ll deploy a sample echoserver app, with the certificates loaded in the application Pod.</p>
<p><strong>Note:</strong> These certificates will not be used by the Gateway, but will remain in the application scope.</p>
<p>Create a root certificate and private key to sign certificates:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-sha256<span class="w"> </span>-nodes<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-subj<span class="w"> </span><span class="s1">&#39;/O=example Inc./CN=example.com&#39;</span><span class="w"> </span>-keyout<span class="w"> </span>example.com.key<span class="w"> </span>-out<span class="w"> </span>example.com.crt
</pre></div>
</div>
<p>Create a certificate and a private key for <code class="docutils literal notranslate"><span class="pre">passthrough.example.com</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-out<span class="w"> </span>passthrough.example.com.csr<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>passthrough.example.com.key<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=passthrough.example.com/O=some organization&quot;</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-sha256<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-CA<span class="w"> </span>example.com.crt<span class="w"> </span>-CAkey<span class="w"> </span>example.com.key<span class="w"> </span>-set_serial<span class="w"> </span><span class="m">0</span><span class="w"> </span>-in<span class="w"> </span>passthrough.example.com.csr<span class="w"> </span>-out<span class="w"> </span>passthrough.example.com.crt
</pre></div>
</div>
<p>Store the cert/keys in A Secret:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>tls<span class="w"> </span>server-certs<span class="w"> </span>--key<span class="o">=</span>passthrough.example.com.key<span class="w"> </span>--cert<span class="o">=</span>passthrough.example.com.crt
</pre></div>
</div>
</section>
<section id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this heading">¶</a></h2>
<p>Deploy TLS Passthrough application Deployment, Service and TLSRoute:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/envoyproxy/gateway/v0.2.0/examples/kubernetes/tls-passthrough.yaml
</pre></div>
</div>
<p>Patch the Gateway from the Quickstart guide to include a TLS listener that listens on port <code class="docutils literal notranslate"><span class="pre">6443</span></code> and is configured for
TLS mode Passthrough:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>patch<span class="w"> </span>gateway<span class="w"> </span>eg<span class="w"> </span>--type<span class="o">=</span>json<span class="w"> </span>--patch<span class="w"> </span><span class="s1">&#39;[{</span>
<span class="s1">   &quot;op&quot;: &quot;add&quot;,</span>
<span class="s1">   &quot;path&quot;: &quot;/spec/listeners/-&quot;,</span>
<span class="s1">   &quot;value&quot;: {</span>
<span class="s1">      &quot;name&quot;: &quot;tls&quot;,</span>
<span class="s1">      &quot;protocol&quot;: &quot;TLS&quot;,</span>
<span class="s1">      &quot;hostname&quot;: &quot;passthrough.example.com&quot;,</span>
<span class="s1">      &quot;tls&quot;: {&quot;mode&quot;: &quot;Passthrough&quot;}, </span>
<span class="s1">      &quot;port&quot;: 6443,</span>
<span class="s1">    },</span>
<span class="s1">}]&#39;</span>
</pre></div>
</div>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">¶</a></h2>
<section id="clusters-without-external-loadbalancer-support">
<h3>Clusters without External LoadBalancer Support<a class="headerlink" href="#clusters-without-external-loadbalancer-support" title="Permalink to this heading">¶</a></h3>
<p>Get the name of the Envoy service created the by the example Gateway:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">ENVOY_SERVICE</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>-n<span class="w"> </span>envoy-gateway-system<span class="w"> </span>--selector<span class="o">=</span>gateway.envoyproxy.io/owning-gateway-namespace<span class="o">=</span>default,gateway.envoyproxy.io/owning-gateway-name<span class="o">=</span>eg<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.items[0].metadata.name}&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Port forward to the Envoy service:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>-n<span class="w"> </span>envoy-gateway-system<span class="w"> </span>port-forward<span class="w"> </span>service/<span class="si">${</span><span class="nv">ENVOY_SERVICE</span><span class="si">}</span><span class="w"> </span><span class="m">6043</span>:6443<span class="w"> </span><span class="p">&amp;</span>
</pre></div>
</div>
<p>Curl the example app through Envoy proxy:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-v<span class="w"> </span>--resolve<span class="w"> </span><span class="s2">&quot;passthrough.example.com:6043:127.0.0.1&quot;</span><span class="w"> </span>https://passthrough.example.com:6043<span class="w"> </span><span class="se">\</span>
--cacert<span class="w"> </span>passthrough.example.com.crt
</pre></div>
</div>
</section>
<section id="clusters-with-external-loadbalancer-support">
<h3>Clusters with External LoadBalancer Support<a class="headerlink" href="#clusters-with-external-loadbalancer-support" title="Permalink to this heading">¶</a></h3>
<p>You can also test the same functionality by sending traffic to the External IP of the Gateway:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">GATEWAY_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gateway/eg<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Curl the example app through the Gateway, e.g. Envoy proxy:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-v<span class="w"> </span>-HHost:passthrough.example.com<span class="w"> </span>--resolve<span class="w"> </span><span class="s2">&quot;passthrough.example.com:6443:</span><span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
--cacert<span class="w"> </span>example.com.crt<span class="w"> </span>https://passthrough.example.com:6443/get
</pre></div>
</div>
</section>
</section>
<section id="clean-up">
<h2>Clean-Up<a class="headerlink" href="#clean-up" title="Permalink to this heading">¶</a></h2>
<p>Follow the steps from the <a class="reference internal" href="quickstart.html"><span class="doc std std-doc">Quickstart Guide</span></a> to uninstall Envoy Gateway and the example manifest.</p>
<p>Delete the Secret:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>delete<span class="w"> </span>secret/server-certs
</pre></div>
</div>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Permalink to this heading">¶</a></h2>
<p>Checkout the <a class="reference internal" href="../dev/README.html"><span class="doc std std-doc">Developer Guide</span></a> to get involved in the project.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Envoy Gateway</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/compatibility.html">Compatibility Matrix</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_docs.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs.html">Design Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_docs.html">About the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_involved.html">Getting Involved</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../user_docs.html">User Guides</a><ul>
      <li>Previous: <a href="secure-gateways.html" title="previous chapter">Secure Gateways</a></li>
      <li>Next: <a href="../design_docs.html" title="next chapter">Design Docs</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Envoy Gateway Project Authors | <a href="https://github.com/envoyproxy/gateway">GitHub</a> | <a href="/latest">Latest Docs</a>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/user/tls-passthrough.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>