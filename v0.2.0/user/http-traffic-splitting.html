
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>HTTPRoute Traffic Splitting &#8212; Envoy Gateway  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="HTTP Request Headers" href="http-request-headers.html" />
    <link rel="prev" title="HTTP Redirects" href="http-redirect.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="httproute-traffic-splitting">
<h1>HTTPRoute Traffic Splitting<a class="headerlink" href="#httproute-traffic-splitting" title="Permalink to this heading">¶</a></h1>
<p>The <a class="reference external" href="https://gateway-api.sigs.k8s.io/api-types/httproute/">HTTPRoute</a> resource allows one or more <a class="reference external" href="https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef">backendRefs</a> to be provided. Requests will be routed to these upstreams
if they match the rules of the HTTPRoute. If an invalid backendRef is configured, then HTTP responses will be returned
with status code <code class="docutils literal notranslate"><span class="pre">500</span></code> for all requests that would have been sent to that backend.</p>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h2>
<p>Follow the steps from the <a class="reference internal" href="quickstart.html"><span class="doc std std-doc">Quickstart Guide</span></a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p>
</section>
<section id="single-backendref">
<h2>Single backendRef<a class="headerlink" href="#single-backendref" title="Permalink to this heading">¶</a></h2>
<p>When a single backendRef is configured in a HTTPRoute, it will receive 100% of the traffic.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-headers</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - backends.example</span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>httproute/http-headers<span class="w"> </span>-o<span class="w"> </span>yaml
</pre></div>
</div>
<p>Get the Gateway’s address:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">GATEWAY_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gateway/eg<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Querying <code class="docutils literal notranslate"><span class="pre">backends.example/get</span></code> should result in a <code class="docutils literal notranslate"><span class="pre">200</span></code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-vvv<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: backends.example&quot;</span><span class="w"> </span><span class="s2">&quot;http://</span><span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span><span class="s2">:8080/get&quot;</span>
<span class="go">...</span>
<span class="go">&gt; GET /get HTTP/1.1</span>
<span class="go">&gt; Host: backends.example</span>
<span class="go">&gt; User-Agent: curl/7.81.0</span>
<span class="go">&gt; Accept: */*</span>
<span class="go">&gt; add-header: something</span>
<span class="go">&gt; </span>
<span class="go">* Mark bundle as not supporting multiuse</span>
<span class="go">&lt; HTTP/1.1 200 OK</span>
<span class="go">&lt; content-type: application/json</span>
<span class="go">&lt; x-content-type-options: nosniff</span>
<span class="go">&lt; content-length: 474</span>
<span class="go">&lt; x-envoy-upstream-service-time: 0</span>
<span class="go">&lt; server: envoy</span>
<span class="go">&lt; </span>
<span class="go">...</span>
<span class="go"> &quot;namespace&quot;: &quot;default&quot;,</span>
<span class="go"> &quot;ingress&quot;: &quot;&quot;,</span>
<span class="go"> &quot;service&quot;: &quot;&quot;,</span>
<span class="go"> &quot;pod&quot;: &quot;backend-79665566f5-s589f&quot;</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="multiple-backendrefs">
<h2>Multiple backendRefs<a class="headerlink" href="#multiple-backendrefs" title="Permalink to this heading">¶</a></h2>
<p>If multiple backendRefs are configured, then traffic will be split between the backendRefs equally unless a weight is
configured.</p>
<p>First, create a second instance of the example app from the quickstart:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">---</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: ServiceAccount</span>
<span class="s">metadata:</span>
<span class="s">  name: backend-2</span>
<span class="s">---</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: backend-2</span>
<span class="s">  labels:</span>
<span class="s">    app: backend-2</span>
<span class="s">    service: backend-2</span>
<span class="s">spec:</span>
<span class="s">  ports:</span>
<span class="s">    - name: http</span>
<span class="s">      port: 3000</span>
<span class="s">      targetPort: 3000</span>
<span class="s">  selector:</span>
<span class="s">    app: backend-2</span>
<span class="s">---</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: backend-2</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: backend-2</span>
<span class="s">      version: v1</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        app: backend-2</span>
<span class="s">        version: v1</span>
<span class="s">    spec:</span>
<span class="s">      serviceAccountName: backend-2</span>
<span class="s">      containers:</span>
<span class="s">        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e</span>
<span class="s">          imagePullPolicy: IfNotPresent</span>
<span class="s">          name: backend-2</span>
<span class="s">          ports:</span>
<span class="s">            - containerPort: 3000</span>
<span class="s">          env:</span>
<span class="s">            - name: POD_NAME</span>
<span class="s">              valueFrom:</span>
<span class="s">                fieldRef:</span>
<span class="s">                  fieldPath: metadata.name</span>
<span class="s">            - name: NAMESPACE</span>
<span class="s">              valueFrom:</span>
<span class="s">                fieldRef:</span>
<span class="s">                  fieldPath: metadata.namespace</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Then create an HTTPRoute that uses both the app from the quickstart and the second instance that was just created</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-headers</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - backends.example</span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend-2</span>
<span class="s">      port: 3000</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Querying <code class="docutils literal notranslate"><span class="pre">backends.example/get</span></code> should result in <code class="docutils literal notranslate"><span class="pre">200</span></code> responses from the example Gateway and the output from the
example app that indicates which pod handled the request should switch between the first pod and the second one from the
new deployment on subsequent requests.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-vvv<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: backends.example&quot;</span><span class="w"> </span><span class="s2">&quot;http://</span><span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span><span class="s2">:8080/get&quot;</span>
<span class="go">...</span>
<span class="go">&gt; GET /get HTTP/1.1</span>
<span class="go">&gt; Host: backends.example</span>
<span class="go">&gt; User-Agent: curl/7.81.0</span>
<span class="go">&gt; Accept: */*</span>
<span class="go">&gt; add-header: something</span>
<span class="go">&gt; </span>
<span class="go">* Mark bundle as not supporting multiuse</span>
<span class="go">&lt; HTTP/1.1 200 OK</span>
<span class="go">&lt; content-type: application/json</span>
<span class="go">&lt; x-content-type-options: nosniff</span>
<span class="go">&lt; content-length: 474</span>
<span class="go">&lt; x-envoy-upstream-service-time: 0</span>
<span class="go">&lt; server: envoy</span>
<span class="go">&lt; </span>
<span class="go">...</span>
<span class="go"> &quot;namespace&quot;: &quot;default&quot;,</span>
<span class="go"> &quot;ingress&quot;: &quot;&quot;,</span>
<span class="go"> &quot;service&quot;: &quot;&quot;,</span>
<span class="go"> &quot;pod&quot;: &quot;backend-75bcd4c969-lsxpz&quot;</span>
<span class="go">...</span>
</pre></div>
</div>
</section>
<section id="weighted-backendrefs">
<h2>Weighted backendRefs<a class="headerlink" href="#weighted-backendrefs" title="Permalink to this heading">¶</a></h2>
<p>If multiple backendRefs are configured and an un-even traffic split between the backends is desired, then the <code class="docutils literal notranslate"><span class="pre">weight</span></code>
field can be used to control the weight of requests to each backend. If weight is not configured for a backendRef it is
assumed to be <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>The <a class="reference external" href="https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef">weight field in a backendRef</a> controls the distribution of the traffic split. The proportion of
requests to a single backendRef is calculated by dividing its <code class="docutils literal notranslate"><span class="pre">weight</span></code> by the sum of all backendRef weights in the
HTTPRoute. The weight is not a percentage and the sum of all weights does not need to add up to 100.</p>
<p>The HTTPRoute below will configure the gateway to send 80% of the traffic to the backend service, and 20% to the
backend-2 service.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-headers</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - backends.example</span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">      weight: 8</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend-2</span>
<span class="s">      port: 3000</span>
<span class="s">      weight: 2</span>
<span class="s">EOF</span>
</pre></div>
</div>
</section>
<section id="invalid-backendrefs">
<h2>Invalid backendRefs<a class="headerlink" href="#invalid-backendrefs" title="Permalink to this heading">¶</a></h2>
<p>backendRefs can be considered invalid for the following reasons:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">group</span></code> field is configured to something other than <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>. Currently, only the core API group (specified by
omitting the group field or setting it to an empty string) is supported</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field is configured to anything other than <code class="docutils literal notranslate"><span class="pre">Service</span></code>. Envoy Gateway currently only supports Kubernetes
Service backendRefs</p></li>
<li><p>The backendRef configures a service with a <code class="docutils literal notranslate"><span class="pre">namespace</span></code> not permitted by any existing ReferenceGrants</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">port</span></code> field is not configured or is configured to a port that does not exist on the Service</p></li>
<li><p>The named Service configured by the backendRef cannot be found</p></li>
</ul>
<p>Modifying the above example to make the backend-2 backendRef invalid by using a port that does not exist on the Service
will result in 80% of the traffic being sent to the backend service, and 20% of the traffic receiving an HTTP response
with status code <code class="docutils literal notranslate"><span class="pre">500</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-headers</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - backends.example</span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">      weight: 8</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend-2</span>
<span class="s">      port: 9000</span>
<span class="s">      weight: 2</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Querying <code class="docutils literal notranslate"><span class="pre">backends.example/get</span></code> should result in <code class="docutils literal notranslate"><span class="pre">200</span></code> responses 80% of the time, and <code class="docutils literal notranslate"><span class="pre">500</span></code> responses 20% of the time.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-vvv<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: backends.example&quot;</span><span class="w"> </span><span class="s2">&quot;http://</span><span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span><span class="s2">:8080/get&quot;</span>
<span class="go">&gt; GET /get HTTP/1.1</span>
<span class="go">&gt; Host: backends.example</span>
<span class="go">&gt; User-Agent: curl/7.81.0</span>
<span class="go">&gt; Accept: */*</span>
<span class="go">&gt; </span>
<span class="go">* Mark bundle as not supporting multiuse</span>
<span class="go">&lt; HTTP/1.1 500 Internal Server Error</span>
<span class="go">&lt; server: envoy</span>
<span class="go">&lt; content-length: 0</span>
<span class="go">&lt;</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Envoy Gateway</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/compatibility.html">Compatibility Matrix</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_docs.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs.html">Design Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_docs.html">About the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_involved.html">Getting Involved</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../user_docs.html">User Guides</a><ul>
      <li>Previous: <a href="http-redirect.html" title="previous chapter">HTTP Redirects</a></li>
      <li>Next: <a href="http-request-headers.html" title="next chapter">HTTP Request Headers</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Envoy Gateway Project Authors | <a href="https://github.com/envoyproxy/gateway">GitHub</a> | <a href="/latest">Latest Docs</a>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/user/http-traffic-splitting.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>