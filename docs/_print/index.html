<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.117.0"><link rel=canonical type=text/html href=http://gateway.xunzhuo.cafe/docs/><link rel=alternate type=application/rss+xml href=http://gateway.xunzhuo.cafe/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Documentation | Envoy Gateway</title><meta name=description content="Manages Envoy Proxy as a Standalone or Kubernetes-based Application Gateway"><meta property="og:title" content="Documentation"><meta property="og:description" content="Manages Envoy Proxy as a Standalone or Kubernetes-based Application Gateway"><meta property="og:type" content="website"><meta property="og:url" content="http://gateway.xunzhuo.cafe/docs/"><meta property="og:site_name" content="Envoy Gateway"><meta itemprop=name content="Documentation"><meta itemprop=description content="Manages Envoy Proxy as a Standalone or Kubernetes-based Application Gateway"><meta name=twitter:card content="summary"><meta name=twitter:title content="Documentation"><meta name=twitter:description content="Manages Envoy Proxy as a Standalone or Kubernetes-based Application Gateway"><link rel=preload href=/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css as=style><link href=/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-00000000-0"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-00000000-0")}</script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class=navbar-brand__name>Envoy Gateway</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/about/><span>About</span></a></li><li class=nav-item><a class=nav-link href=/docs/api/><span>API</span></a></li><li class=nav-item><a class=nav-link href=/docs/design/><span>Design</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/docs/helm/><span>Helm</span></a></li><li class=nav-item><a class=nav-link href=/docs/intro/><span>Introduction</span></a></li><li class=nav-item><a class=nav-link href=/docs/releases/><span>Releases</span></a></li><li class=nav-item><a class=nav-link href=/docs/user/><span>User Guide</span></a></li><li class=nav-item><a class=nav-link href=/blog/><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-db699884bd3aedc1fbac2328d8409e60>API</a></li><ul><li>1.1: <a href=#pg-e0506ee3335bfc90090054c3cf95f0c7>Config Types</a></li><li>1.2: <a href=#pg-235a73045992670068c3cc74441d39bc>Extension Types</a></li></ul><li>2: <a href=#pg-ddd7fbe6fc5666af530b7ac47a4a5fca>Design</a></li><ul><li>2.1: <a href=#pg-08c492fcd261c36dd8e0bb8dc70155eb>Add Pprof support in Envoy Gateway</a></li><li>2.2: <a href=#pg-080f800856c4aaeca39b99154c78806b>Bootstrap Design</a></li><li>2.3: <a href=#pg-d95b539366696a52e6bbde596fe15bde>Configuration API Design</a></li><li>2.4: <a href=#pg-677b5704cda0b4585fd015f774624734>egctl Design</a></li><li>2.5: <a href=#pg-a6ba4c5d4c0dd5c5a9da577949a49126>Envoy Gateway Extensions Design</a></li><li>2.6: <a href=#pg-9e05365d99c70d7c35ff49ddfb3faefe>EnvoyPatchPolicy Design</a></li><li>2.7: <a href=#pg-782f8b563b3b612196dabcda1546a537>Gateway API Translator Design</a></li><li>2.8: <a href=#pg-940b0d3142db0b37b73631699b6a9680>Observability Accesslog</a></li><li>2.9: <a href=#pg-db0f9dd0035b6783ae0dc21fdc2497cb>Observability: Accesslog</a></li><li>2.10: <a href=#pg-5f369822277277bf98402321ec6c584c>Observability: Metrics</a></li><li>2.11: <a href=#pg-432e167e7cba66b608808421487338d3>Rate Limit Design</a></li><li>2.12: <a href=#pg-b622e15212ac176fc0f98dd89f3a9916>Request Authentication Design</a></li><li>2.13: <a href=#pg-d200fa855c2d507debade16505dee377>Roadmap</a></li><li>2.14: <a href=#pg-3fc30f1a064a6892e5ad574d47d9721b>Running Envoy Gateway locally</a></li><li>2.15: <a href=#pg-0fa34640d8b8d8fca8f387300d585a92>System Design</a></li><li>2.16: <a href=#pg-a8da31517fe722f791d672352baa0c35>TCP and UDP Proxy Design</a></li><li>2.17: <a href=#pg-44c7518b753af0dc562cf1202b7ef661>Watching Components Design</a></li></ul><li>3: <a href=#pg-225c7e5454818c24ae8c4072c5dbafb0>Helm</a></li><ul><li>3.1: <a href=#pg-9f9033a5f543a5de0f6c038229505944>Usage</a></li></ul><li>4: <a href=#pg-a5f739a8bec034e3bccefb4740e1c6ec>Introduction</a></li><ul><li>4.1: <a href=#pg-71e4fa69375715cbc1aff93dc2363138>Compatibility Matrix</a></li></ul><li>5: <a href=#pg-9662232d61bca04520940eafdc2967e8>Releases</a></li><ul><li>5.1: <a href=#pg-47b8476f450232d350df4857afebfdb3>Announcing Envoy Gateway v0.5</a></li><li>5.2: <a href=#pg-920170f99d4cf5e216fa2b2dd7fc36d5>Announcing Envoy Gateway v0.4</a></li><li>5.3: <a href=#pg-1bd4ee2f2a6bd8dec27a3eba1ef3e578>Announcing Envoy Gateway v0.3</a></li><li>5.4: <a href=#pg-4ff68093439b2ea3685847ef01935e33>Announcing Envoy Gateway v0.2</a></li><li>5.5: <a href=#pg-e66247585908294b891834378ea3ac19></a></li></ul><li>6: <a href=#pg-60b58cae199073ee637865a9f60710e7>User Guide</a></li><ul><li>6.1: <a href=#pg-d5bd454b857d88557b13a286e9242378></a></li><li>6.2: <a href=#pg-e70a3fedc0fcaab8dfcf1abca0043f73></a></li><li>6.3: <a href=#pg-f44b560399133c52b7c07d0a48eb00f0></a></li><li>6.4: <a href=#pg-cf30c4df7d9e1861913182fa02c656f6></a></li><li>6.5: <a href=#pg-79fbf0081ff9c3448d19524f90b4aa41></a></li><li>6.6: <a href=#pg-f991774fb350e8e0ee3aa2f63e9365d3></a></li><li>6.7: <a href=#pg-894b9ef799cf8f008c86fb040f693dcb></a></li><li>6.8: <a href=#pg-8563abe38555100b3562a843144b5df2></a></li><li>6.9: <a href=#pg-0065b883d3771bbee12c3729343cedb5></a></li><li>6.10: <a href=#pg-18fc6726bfbca0af0e301a1b238a462a></a></li><li>6.11: <a href=#pg-526c2363197d6fc4c61100d884f89db8></a></li><li>6.12: <a href=#pg-7e057f84803b3e18612397301b8086a0></a></li><li>6.13: <a href=#pg-9b9b6c7f848d76cec306e87849a6ddbb></a></li><li>6.14: <a href=#pg-ad54cbd9f25034c25a4b39533d9b82b7></a></li><li>6.15: <a href=#pg-d4306dd0cf2e17b9fd55dad08c4ff981></a></li><li>6.16: <a href=#pg-66c616300865bef62c1b8456505ac2db></a></li><li>6.17: <a href=#pg-21d4065290fe2ac3baca1e8011739c93></a></li><li>6.18: <a href=#pg-9a253aa6ff69db8dd67cfa17628f4a59></a></li><li>6.19: <a href=#pg-e62114c29f995b23e2fa6acc5f391326></a></li><li>6.20: <a href=#pg-5a52e3c47a260e6eeffbb6eee27a7cb1></a></li><li>6.21: <a href=#pg-c54214b1e943ca6b3a21b07767d41fdb></a></li><li>6.22: <a href=#pg-f234061010e2f904c0c0e87e38a46d80></a></li><li>6.23: <a href=#pg-909f112ee4921602d610f2121d35774d></a></li><li>6.24: <a href=#pg-ff91cb685ccd7cc62af7de11a3c6b299></a></li><li>6.25: <a href=#pg-0b6105b58120b01aad817fd8d1eee631></a></li><li>6.26: <a href=#pg-58b87202a450ea245964ef56ac3d2af1></a></li></ul></ul><div class=content><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-db699884bd3aedc1fbac2328d8409e60>1 - API</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e0506ee3335bfc90090054c3cf95f0c7>1.1 - Config Types</h1><h1 id=api-reference>API Reference</h1><h2 id=packages>Packages</h2><ul><li><a href=#configgatewayenvoyproxyiov1alpha1>config.gateway.envoyproxy.io/v1alpha1</a></li></ul><h2 id=configgatewayenvoyproxyiov1alpha1>config.gateway.envoyproxy.io/v1alpha1</h2><p>Package v1alpha1 contains API schema definitions for the config.gateway.envoyproxy.io
API group.</p><h3 id=resource-types>Resource Types</h3><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoyproxy>EnvoyProxy</a></li></ul><h2 id=bootstraptype>BootstrapType</h2><p><em>Underlying type:</em> <code>string</code></p><p>BootstrapType defines the types of bootstrap supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#proxybootstrap>ProxyBootstrap</a></li></ul><h2 id=customtag>CustomTag</h2><p><em>Appears in:</em></p><ul><li><a href=#proxytracing>ProxyTracing</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#customtagtype>CustomTagType</a></em></td><td>Type defines the type of custom tag.</td></tr><tr><td><code>literal</code> <em><a href=#literalcustomtag>LiteralCustomTag</a></em></td><td>Literal adds hard-coded value to each span. It&rsquo;s required when the type is &ldquo;Literal&rdquo;.</td></tr><tr><td><code>environment</code> <em><a href=#environmentcustomtag>EnvironmentCustomTag</a></em></td><td>Environment adds value from environment variable to each span. It&rsquo;s required when the type is &ldquo;Environment&rdquo;.</td></tr><tr><td><code>requestHeader</code> <em><a href=#requestheadercustomtag>RequestHeaderCustomTag</a></em></td><td>RequestHeader adds value from request header to each span. It&rsquo;s required when the type is &ldquo;RequestHeader&rdquo;.</td></tr></tbody></table><h2 id=customtagtype>CustomTagType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#customtag>CustomTag</a></li></ul><h2 id=environmentcustomtag>EnvironmentCustomTag</h2><p>EnvironmentCustomTag adds value from environment variable to each span.</p><p><em>Appears in:</em></p><ul><li><a href=#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code> <em>string</em></td><td>Name defines the name of the environment variable which to extract the value from.</td></tr><tr><td><code>defaultValue</code> <em>string</em></td><td>DefaultValue defines the default value to use if the environment variable is not set.</td></tr></tbody></table><h2 id=envoygateway>EnvoyGateway</h2><p>EnvoyGateway is the schema for the envoygateways API.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>config.gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>EnvoyGateway</code></td></tr><tr><td><code>gateway</code> <em><a href=#gateway>Gateway</a></em></td><td>Gateway defines desired Gateway API specific configuration. If unset, default configuration parameters will apply.</td></tr><tr><td><code>provider</code> <em><a href=#envoygatewayprovider>EnvoyGatewayProvider</a></em></td><td>Provider defines the desired provider and provider-specific configuration. If unspecified, the Kubernetes provider is used with default configuration parameters.</td></tr><tr><td><code>logging</code> <em><a href=#envoygatewaylogging>EnvoyGatewayLogging</a></em></td><td>Logging defines logging parameters for Envoy Gateway.</td></tr><tr><td><code>admin</code> <em><a href=#envoygatewayadmin>EnvoyGatewayAdmin</a></em></td><td>Admin defines the desired admin related abilities. If unspecified, the Admin is used with default configuration parameters.</td></tr><tr><td><code>rateLimit</code> <em><a href=#ratelimit>RateLimit</a></em></td><td>RateLimit defines the configuration associated with the Rate Limit service deployed by Envoy Gateway required to implement the Global Rate limiting functionality. The specific rate limit service used here is the reference implementation in Envoy. For more details visit <a href=https://github.com/envoyproxy/ratelimit>https://github.com/envoyproxy/ratelimit</a>. This configuration is unneeded for &ldquo;Local&rdquo; rate limiting.</td></tr><tr><td><code>extensionManager</code> <em><a href=#extensionmanager>ExtensionManager</a></em></td><td>ExtensionManager defines an extension manager to register for the Envoy Gateway Control Plane.</td></tr><tr><td><code>extensionApis</code> <em><a href=#extensionapisettings>ExtensionAPISettings</a></em></td><td>ExtensionAPIs defines the settings related to specific Gateway API Extensions implemented by Envoy Gateway</td></tr></tbody></table><h2 id=envoygatewayadmin>EnvoyGatewayAdmin</h2><p>EnvoyGatewayAdmin defines the Envoy Gateway Admin configuration.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>address</code> <em><a href=#envoygatewayadminaddress>EnvoyGatewayAdminAddress</a></em></td><td>Address defines the address of Envoy Gateway Admin Server.</td></tr><tr><td><code>debug</code> <em>boolean</em></td><td>Debug defines if enable the /debug endpoint of Envoy Gateway.</td></tr></tbody></table><h2 id=envoygatewayadminaddress>EnvoyGatewayAdminAddress</h2><p>EnvoyGatewayAdminAddress defines the Envoy Gateway Admin Address configuration.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayadmin>EnvoyGatewayAdmin</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>port</code> <em>integer</em></td><td>Port defines the port the admin server is exposed on.</td></tr><tr><td><code>host</code> <em>string</em></td><td>Host defines the admin server hostname.</td></tr></tbody></table><h2 id=envoygatewaycustomprovider>EnvoyGatewayCustomProvider</h2><p>EnvoyGatewayCustomProvider defines configuration for the Custom provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayprovider>EnvoyGatewayProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>resource</code> <em><a href=#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></em></td><td>Resource defines the desired resource provider. This provider is used to specify the provider to be used to retrieve the resource configurations such as Gateway API resources</td></tr><tr><td><code>infrastructure</code> <em><a href=#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></em></td><td>Infrastructure defines the desired infrastructure provider. This provider is used to specify the provider to be used to provide an environment to deploy the out resources like the Envoy Proxy data plane.</td></tr></tbody></table><h2 id=envoygatewayfileresourceprovider>EnvoyGatewayFileResourceProvider</h2><p>EnvoyGatewayFileResourceProvider defines configuration for the File Resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>paths</code> <em>string array</em></td><td>Paths are the paths to a directory or file containing the resource configuration. Recursive sub directories are not currently supported.</td></tr></tbody></table><h2 id=envoygatewayhostinfrastructureprovider>EnvoyGatewayHostInfrastructureProvider</h2><p>EnvoyGatewayHostInfrastructureProvider defines configuration for the Host Infrastructure provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></li></ul><h2 id=envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</h2><p>EnvoyGatewayInfrastructureProvider defines configuration for the Custom Infrastructure provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#infrastructureprovidertype>InfrastructureProviderType</a></em></td><td>Type is the type of infrastructure providers to use. Supported types are &ldquo;Host&rdquo;.</td></tr><tr><td><code>host</code> <em><a href=#envoygatewayhostinfrastructureprovider>EnvoyGatewayHostInfrastructureProvider</a></em></td><td>Host defines the configuration of the Host provider. Host provides runtime deployment of the data plane as a child process on the host environment.</td></tr></tbody></table><h2 id=envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</h2><p>EnvoyGatewayKubernetesProvider defines configuration for the Kubernetes provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayprovider>EnvoyGatewayProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>rateLimitDeployment</code> <em><a href=#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></em></td><td>RateLimitDeployment defines the desired state of the Envoy ratelimit deployment resource. If unspecified, default settings for the manged Envoy ratelimit deployment resource are applied.</td></tr><tr><td><code>watch</code> <em><a href=#kuberneteswatchmode>KubernetesWatchMode</a></em></td><td>Watch holds configuration of which input resources should be watched and reconciled.</td></tr><tr><td><code>deploy</code> <em><a href=#kubernetesdeploymode>KubernetesDeployMode</a></em></td><td>Deploy holds configuration of how output managed resources such as the Envoy Proxy data plane should be deployed</td></tr><tr><td><code>overwrite_control_plane_certs</code> <em>boolean</em></td><td>OverwriteControlPlaneCerts updates the secrets containing the control plane certs, when set.</td></tr></tbody></table><h2 id=envoygatewaylogcomponent>EnvoyGatewayLogComponent</h2><p><em>Underlying type:</em> <code>string</code></p><p>EnvoyGatewayLogComponent defines a component that supports a configured logging level.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaylogging>EnvoyGatewayLogging</a></li></ul><h2 id=envoygatewaylogging>EnvoyGatewayLogging</h2><p>EnvoyGatewayLogging defines logging for Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>level</code> <em>object (keys:<a href=#envoygatewaylogcomponent>EnvoyGatewayLogComponent</a>, values:<a href=#loglevel>LogLevel</a>)</em></td><td>Level is the logging level. If unspecified, defaults to &ldquo;info&rdquo;. EnvoyGatewayLogComponent options: default/provider/gateway-api/xds-translator/xds-server/infrastructure/global-ratelimit. LogLevel options: debug/info/error/warn.</td></tr></tbody></table><h2 id=envoygatewayprovider>EnvoyGatewayProvider</h2><p>EnvoyGatewayProvider defines the desired configuration of a provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#providertype>ProviderType</a></em></td><td>Type is the type of provider to use. Supported types are &ldquo;Kubernetes&rdquo;.</td></tr><tr><td><code>kubernetes</code> <em><a href=#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></em></td><td>Kubernetes defines the configuration of the Kubernetes provider. Kubernetes provides runtime configuration via the Kubernetes API.</td></tr><tr><td><code>custom</code> <em><a href=#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></em></td><td>Custom defines the configuration for the Custom provider. This provider allows you to define a specific resource provider and a infrastructure provider.</td></tr></tbody></table><h2 id=envoygatewayresourceprovider>EnvoyGatewayResourceProvider</h2><p>EnvoyGatewayResourceProvider defines configuration for the Custom Resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaycustomprovider>EnvoyGatewayCustomProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#resourceprovidertype>ResourceProviderType</a></em></td><td>Type is the type of resource provider to use. Supported types are &ldquo;File&rdquo;.</td></tr><tr><td><code>file</code> <em><a href=#envoygatewayfileresourceprovider>EnvoyGatewayFileResourceProvider</a></em></td><td>File defines the configuration of the File provider. File provides runtime configuration defined by one or more files.</td></tr></tbody></table><h2 id=envoygatewayspec>EnvoyGatewaySpec</h2><p>EnvoyGatewaySpec defines the desired state of Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>gateway</code> <em><a href=#gateway>Gateway</a></em></td><td>Gateway defines desired Gateway API specific configuration. If unset, default configuration parameters will apply.</td></tr><tr><td><code>provider</code> <em><a href=#envoygatewayprovider>EnvoyGatewayProvider</a></em></td><td>Provider defines the desired provider and provider-specific configuration. If unspecified, the Kubernetes provider is used with default configuration parameters.</td></tr><tr><td><code>logging</code> <em><a href=#envoygatewaylogging>EnvoyGatewayLogging</a></em></td><td>Logging defines logging parameters for Envoy Gateway.</td></tr><tr><td><code>admin</code> <em><a href=#envoygatewayadmin>EnvoyGatewayAdmin</a></em></td><td>Admin defines the desired admin related abilities. If unspecified, the Admin is used with default configuration parameters.</td></tr><tr><td><code>rateLimit</code> <em><a href=#ratelimit>RateLimit</a></em></td><td>RateLimit defines the configuration associated with the Rate Limit service deployed by Envoy Gateway required to implement the Global Rate limiting functionality. The specific rate limit service used here is the reference implementation in Envoy. For more details visit <a href=https://github.com/envoyproxy/ratelimit>https://github.com/envoyproxy/ratelimit</a>. This configuration is unneeded for &ldquo;Local&rdquo; rate limiting.</td></tr><tr><td><code>extensionManager</code> <em><a href=#extensionmanager>ExtensionManager</a></em></td><td>ExtensionManager defines an extension manager to register for the Envoy Gateway Control Plane.</td></tr><tr><td><code>extensionApis</code> <em><a href=#extensionapisettings>ExtensionAPISettings</a></em></td><td>ExtensionAPIs defines the settings related to specific Gateway API Extensions implemented by Envoy Gateway</td></tr></tbody></table><h2 id=envoyproxy>EnvoyProxy</h2><p>EnvoyProxy is the schema for the envoyproxies API.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>config.gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>EnvoyProxy</code></td></tr><tr><td><code>metadata</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code> <em><a href=#envoyproxyspec>EnvoyProxySpec</a></em></td><td>EnvoyProxySpec defines the desired state of EnvoyProxy.</td></tr></tbody></table><h2 id=envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</h2><p>EnvoyProxyKubernetesProvider defines configuration for the Kubernetes resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxyprovider>EnvoyProxyProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>envoyDeployment</code> <em><a href=#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></em></td><td>EnvoyDeployment defines the desired state of the Envoy deployment resource. If unspecified, default settings for the manged Envoy deployment resource are applied.</td></tr><tr><td><code>envoyService</code> <em><a href=#kubernetesservicespec>KubernetesServiceSpec</a></em></td><td>EnvoyService defines the desired state of the Envoy service resource. If unspecified, default settings for the manged Envoy service resource are applied.</td></tr></tbody></table><h2 id=envoyproxyprovider>EnvoyProxyProvider</h2><p>EnvoyProxyProvider defines the desired state of a resource provider.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#providertype>ProviderType</a></em></td><td>Type is the type of resource provider to use. A resource provider provides infrastructure resources for running the data plane, e.g. Envoy proxy, and optional auxiliary control planes. Supported types are &ldquo;Kubernetes&rdquo;.</td></tr><tr><td><code>kubernetes</code> <em><a href=#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></em></td><td>Kubernetes defines the desired state of the Kubernetes resource provider. Kubernetes provides infrastructure resources for running the data plane, e.g. Envoy proxy. If unspecified and type is &ldquo;Kubernetes&rdquo;, default settings for managed Kubernetes resources are applied.</td></tr></tbody></table><h2 id=envoyproxyspec>EnvoyProxySpec</h2><p>EnvoyProxySpec defines the desired state of EnvoyProxy.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxy>EnvoyProxy</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>provider</code> <em><a href=#envoyproxyprovider>EnvoyProxyProvider</a></em></td><td>Provider defines the desired resource provider and provider-specific configuration. If unspecified, the &ldquo;Kubernetes&rdquo; resource provider is used with default configuration parameters.</td></tr><tr><td><code>logging</code> <em><a href=#proxylogging>ProxyLogging</a></em></td><td>Logging defines logging parameters for managed proxies.</td></tr><tr><td><code>telemetry</code> <em><a href=#proxytelemetry>ProxyTelemetry</a></em></td><td>Telemetry defines telemetry parameters for managed proxies.</td></tr><tr><td><code>bootstrap</code> <em><a href=#proxybootstrap>ProxyBootstrap</a></em></td><td>Bootstrap defines the Envoy Bootstrap as a YAML string. Visit <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-msg-config-bootstrap-v3-bootstrap>https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-msg-config-bootstrap-v3-bootstrap</a> to learn more about the syntax. If set, this is the Bootstrap configuration used for the managed Envoy Proxy fleet instead of the default Bootstrap configuration set by Envoy Gateway. Some fields within the Bootstrap that are required to communicate with the xDS Server (Envoy Gateway) and receive xDS resources from it are not configurable and will result in the <code>EnvoyProxy</code> resource being rejected. Backward compatibility across minor versions is not guaranteed. We strongly recommend using <code>egctl x translate</code> to generate a <code>EnvoyProxy</code> resource with the <code>Bootstrap</code> field set to the default Bootstrap configuration used. You can edit this configuration, and rerun <code>egctl x translate</code> to ensure there are no validation errors.</td></tr><tr><td><code>concurrency</code> <em>integer</em></td><td>Concurrency defines the number of worker threads to run. If unset, it defaults to the number of cpuset threads on the platform.</td></tr></tbody></table><h2 id=extensionapisettings>ExtensionAPISettings</h2><p>ExtensionAPISettings defines the settings specific to Gateway API Extensions.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>enableEnvoyPatchPolicy</code> <em>boolean</em></td><td>EnableEnvoyPatchPolicy enables Envoy Gateway to reconcile and implement the EnvoyPatchPolicy resources.</td></tr></tbody></table><h2 id=extensionhooks>ExtensionHooks</h2><p>ExtensionHooks defines extension hooks across all supported runners</p><p><em>Appears in:</em></p><ul><li><a href=#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>xdsTranslator</code> <em><a href=#xdstranslatorhooks>XDSTranslatorHooks</a></em></td><td>XDSTranslator defines all the supported extension hooks for the xds-translator runner</td></tr></tbody></table><h2 id=extensionmanager>ExtensionManager</h2><p>ExtensionManager defines the configuration for registering an extension manager to the Envoy Gateway control plane.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>resources</code> <em><a href=#groupversionkind>GroupVersionKind</a> array</em></td><td>Resources defines the set of K8s resources the extension will handle.</td></tr><tr><td><code>hooks</code> <em><a href=#extensionhooks>ExtensionHooks</a></em></td><td>Hooks defines the set of hooks the extension supports</td></tr><tr><td><code>service</code> <em><a href=#extensionservice>ExtensionService</a></em></td><td>Service defines the configuration of the extension service that the Envoy Gateway Control Plane will call through extension hooks.</td></tr></tbody></table><h2 id=extensionservice>ExtensionService</h2><p>ExtensionService defines the configuration for connecting to a registered extension service.</p><p><em>Appears in:</em></p><ul><li><a href=#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>host</code> <em>string</em></td><td>Host define the extension service hostname.</td></tr><tr><td><code>port</code> <em>integer</em></td><td>Port defines the port the extension service is exposed on.</td></tr><tr><td><code>tls</code> <em><a href=#extensiontls>ExtensionTLS</a></em></td><td>TLS defines TLS configuration for communication between Envoy Gateway and the extension service.</td></tr></tbody></table><h2 id=extensiontls>ExtensionTLS</h2><p>ExtensionTLS defines the TLS configuration when connecting to an extension service</p><p><em>Appears in:</em></p><ul><li><a href=#extensionservice>ExtensionService</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>certificateRef</code> <em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.SecretObjectReference>SecretObjectReference</a></em></td><td>CertificateRef contains a references to objects (Kubernetes objects or otherwise) that contains a TLS certificate and private keys. These certificates are used to establish a TLS handshake to the extension server.</td></tr><tr><td>CertificateRef can only reference a Kubernetes Secret at this time.</td><td></td></tr></tbody></table><h2 id=fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog</h2><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>path</code> <em>string</em></td><td>Path defines the file path used to expose envoy access log(e.g. /dev/stdout).</td></tr></tbody></table><h2 id=gateway>Gateway</h2><p>Gateway defines the desired Gateway API configuration of Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>controllerName</code> <em>string</em></td><td>ControllerName defines the name of the Gateway API controller. If unspecified, defaults to &ldquo;gateway.envoyproxy.io/gatewayclass-controller&rdquo;. See the following for additional details: <a href=https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.GatewayClass>https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.GatewayClass</a></td></tr></tbody></table><h2 id=groupversionkind>GroupVersionKind</h2><p>GroupVersionKind unambiguously identifies a Kind. It can be converted to k8s.io/apimachinery/pkg/runtime/schema.GroupVersionKind</p><p><em>Appears in:</em></p><ul><li><a href=#extensionmanager>ExtensionManager</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>group</code> <em>string</em></td><td></td></tr><tr><td><code>version</code> <em>string</em></td><td></td></tr><tr><td><code>kind</code> <em>string</em></td><td></td></tr></tbody></table><h2 id=infrastructureprovidertype>InfrastructureProviderType</h2><p><em>Underlying type:</em> <code>string</code></p><p>InfrastructureProviderType defines the types of custom infrastructure providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayinfrastructureprovider>EnvoyGatewayInfrastructureProvider</a></li></ul><h2 id=kubernetescontainerspec>KubernetesContainerSpec</h2><p>KubernetesContainerSpec defines the desired state of the Kubernetes container resource.</p><p><em>Appears in:</em></p><ul><li><a href=#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>env</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#envvar-v1-core>EnvVar</a> array</em></td><td>List of environment variables to set in the container.</td></tr><tr><td><code>resources</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#resourcerequirements-v1-core>ResourceRequirements</a></em></td><td>Resources required by this container. More info: <a href=https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/>https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/</a></td></tr><tr><td><code>securityContext</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#securitycontext-v1-core>SecurityContext</a></em></td><td>SecurityContext defines the security options the container should be run with. If set, the fields of SecurityContext override the equivalent fields of PodSecurityContext. More info: <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/>https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></td></tr><tr><td><code>image</code> <em>string</em></td><td>Image specifies the EnvoyProxy container image to be used, instead of the default image.</td></tr><tr><td><code>volumeMounts</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#volumemount-v1-core>VolumeMount</a> array</em></td><td>VolumeMounts are volumes to mount into the container&rsquo;s filesystem. Cannot be updated.</td></tr></tbody></table><h2 id=kubernetesdeploymode>KubernetesDeployMode</h2><p>KubernetesDeployMode holds configuration for how to deploy managed resources such as the Envoy Proxy data plane fleet.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><h2 id=kubernetesdeploymentspec>KubernetesDeploymentSpec</h2><p>KubernetesDeploymentSpec defines the desired state of the Kubernetes deployment resource.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li><li><a href=#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>replicas</code> <em>integer</em></td><td>Replicas is the number of desired pods. Defaults to 1.</td></tr><tr><td><code>strategy</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#deploymentstrategy-v1-apps>DeploymentStrategy</a></em></td><td>The deployment strategy to use to replace existing pods with new ones.</td></tr><tr><td><code>pod</code> <em><a href=#kubernetespodspec>KubernetesPodSpec</a></em></td><td>Pod defines the desired annotations and securityContext of container.</td></tr><tr><td><code>container</code> <em><a href=#kubernetescontainerspec>KubernetesContainerSpec</a></em></td><td>Container defines the resources and securityContext of container.</td></tr></tbody></table><h2 id=kubernetespodspec>KubernetesPodSpec</h2><p>KubernetesPodSpec defines the desired state of the Kubernetes pod resource.</p><p><em>Appears in:</em></p><ul><li><a href=#kubernetesdeploymentspec>KubernetesDeploymentSpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code> <em>object (keys:string, values:string)</em></td><td>Annotations are the annotations that should be appended to the pods. By default, no pod annotations are appended.</td></tr><tr><td><code>labels</code> <em>object (keys:string, values:string)</em></td><td>Labels are the additional labels that should be tagged to the pods. By default, no additional pod labels are tagged.</td></tr><tr><td><code>securityContext</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podsecuritycontext-v1-core>PodSecurityContext</a></em></td><td>SecurityContext holds pod-level security attributes and common container settings. Optional: Defaults to empty. See type description for default values of each field.</td></tr><tr><td><code>affinity</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#affinity-v1-core>Affinity</a></em></td><td>If specified, the pod&rsquo;s scheduling constraints.</td></tr><tr><td><code>tolerations</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#toleration-v1-core>Toleration</a> array</em></td><td>If specified, the pod&rsquo;s tolerations.</td></tr><tr><td><code>volumes</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#volume-v1-core>Volume</a> array</em></td><td>Volumes that can be mounted by containers belonging to the pod. More info: <a href=https://kubernetes.io/docs/concepts/storage/volumes>https://kubernetes.io/docs/concepts/storage/volumes</a></td></tr></tbody></table><h2 id=kubernetesservicespec>KubernetesServiceSpec</h2><p>KubernetesServiceSpec defines the desired state of the Kubernetes service resource.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxykubernetesprovider>EnvoyProxyKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>annotations</code> <em>object (keys:string, values:string)</em></td><td>Annotations that should be appended to the service. By default, no annotations are appended.</td></tr><tr><td><code>type</code> <em><a href=#servicetype>ServiceType</a></em></td><td>Type determines how the Service is exposed. Defaults to LoadBalancer. Valid options are ClusterIP, LoadBalancer and NodePort. &ldquo;LoadBalancer&rdquo; means a service will be exposed via an external load balancer (if the cloud provider supports it). &ldquo;ClusterIP&rdquo; means a service will only be accessible inside the cluster, via the cluster IP. &ldquo;NodePort&rdquo; means a service will be exposed on a static Port on all Nodes of the cluster.</td></tr><tr><td><code>loadBalancerClass</code> <em>string</em></td><td>LoadBalancerClass, when specified, allows for choosing the LoadBalancer provider implementation if more than one are available or is otherwise expected to be specified</td></tr></tbody></table><h2 id=kuberneteswatchmode>KubernetesWatchMode</h2><p>KubernetesWatchMode holds the configuration for which input resources to watch and reconcile.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaykubernetesprovider>EnvoyGatewayKubernetesProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>namespaces</code> <em>string array</em></td><td>Namespaces holds the list of namespaces that Envoy Gateway will watch for namespaced scoped resources such as Gateway, HTTPRoute and Service. Note that Envoy Gateway will continue to reconcile relevant cluster scoped resources such as GatewayClass that it is linked to. By default, when this field is unset or empty, Envoy Gateway will watch for input namespaced resources from all namespaces.</td></tr></tbody></table><h2 id=literalcustomtag>LiteralCustomTag</h2><p>LiteralCustomTag adds hard-coded value to each span.</p><p><em>Appears in:</em></p><ul><li><a href=#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>value</code> <em>string</em></td><td>Value defines the hard-coded value to add to each span.</td></tr></tbody></table><h2 id=logcomponent>LogComponent</h2><p><em>Underlying type:</em> <code>string</code></p><p>LogComponent defines a component that supports a configured logging level.</p><p><em>Appears in:</em></p><ul><li><a href=#proxylogging>ProxyLogging</a></li></ul><h2 id=loglevel>LogLevel</h2><p><em>Underlying type:</em> <code>string</code></p><p>LogLevel defines a log level for Envoy Gateway and EnvoyProxy system logs. This type is not implemented for EnvoyProxy until <a href=https://github.com/envoyproxy/gateway/issues/280>https://github.com/envoyproxy/gateway/issues/280</a> is fixed.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewaylogging>EnvoyGatewayLogging</a></li><li><a href=#proxylogging>ProxyLogging</a></li></ul><h2 id=match>Match</h2><p>Match defines the stats match configuration.</p><p><em>Appears in:</em></p><ul><li><a href=#proxymetrics>ProxyMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#matchertype>MatcherType</a></em></td><td>MatcherType defines the stats matcher type</td></tr><tr><td><code>value</code> <em>string</em></td><td></td></tr></tbody></table><h2 id=matchertype>MatcherType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#match>Match</a></li></ul><h2 id=metricsink>MetricSink</h2><p><em>Appears in:</em></p><ul><li><a href=#proxymetrics>ProxyMetrics</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#metricsinktype>MetricSinkType</a></em></td><td>Type defines the metric sink type. EG currently only supports OpenTelemetry.</td></tr><tr><td><code>openTelemetry</code> <em><a href=#opentelemetrysink>OpenTelemetrySink</a></em></td><td>OpenTelemetry defines the configuration for OpenTelemetry sink. It&rsquo;s required if the sink type is OpenTelemetry.</td></tr></tbody></table><h2 id=metricsinktype>MetricSinkType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#metricsink>MetricSink</a></li></ul><h2 id=opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</h2><p>TODO: consider reuse ExtensionService?</p><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>host</code> <em>string</em></td><td>Host define the extension service hostname.</td></tr><tr><td><code>port</code> <em>integer</em></td><td>Port defines the port the extension service is exposed on.</td></tr><tr><td><code>resources</code> <em>object (keys:string, values:string)</em></td><td>Resources is a set of labels that describe the source of a log entry, including envoy node info. It&rsquo;s recommended to follow <a href=https://opentelemetry.io/docs/reference/specification/resource/semantic_conventions/>semantic conventions</a>.</td></tr></tbody></table><h2 id=opentelemetrysink>OpenTelemetrySink</h2><p><em>Appears in:</em></p><ul><li><a href=#metricsink>MetricSink</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>host</code> <em>string</em></td><td>Host define the service hostname.</td></tr><tr><td><code>port</code> <em>integer</em></td><td>Port defines the port the service is exposed on.</td></tr></tbody></table><h2 id=prometheusprovider>PrometheusProvider</h2><p><em>Appears in:</em></p><ul><li><a href=#proxymetrics>ProxyMetrics</a></li></ul><h2 id=providertype>ProviderType</h2><p><em>Underlying type:</em> <code>string</code></p><p>ProviderType defines the types of providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayprovider>EnvoyGatewayProvider</a></li><li><a href=#envoyproxyprovider>EnvoyProxyProvider</a></li></ul><h2 id=proxyaccesslog>ProxyAccessLog</h2><p><em>Appears in:</em></p><ul><li><a href=#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>disable</code> <em>boolean</em></td><td>Disable disables access logging for managed proxies if set to true.</td></tr><tr><td><code>settings</code> <em><a href=#proxyaccesslogsetting>ProxyAccessLogSetting</a> array</em></td><td>Settings defines accesslog settings for managed proxies. If unspecified, will send default format to stdout.</td></tr></tbody></table><h2 id=proxyaccesslogformat>ProxyAccessLogFormat</h2><p>ProxyAccessLogFormat defines the format of accesslog. By default accesslogs are written to standard output.</p><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogsetting>ProxyAccessLogSetting</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#proxyaccesslogformattype>ProxyAccessLogFormatType</a></em></td><td>Type defines the type of accesslog format.</td></tr><tr><td><code>text</code> <em>string</em></td><td>Text defines the text accesslog format, following Envoy accesslog formatting, It&rsquo;s required when the format type is &ldquo;Text&rdquo;. Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators>command operators</a> may be used in the format. The <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-strings>format string documentation</a> provides more information.</td></tr><tr><td><code>json</code> <em>object (keys:string, values:string)</em></td><td>JSON is additional attributes that describe the specific event occurrence. Structured format for the envoy access logs. Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators>command operators</a> can be used as values for fields within the Struct. It&rsquo;s required when the format type is &ldquo;JSON&rdquo;.</td></tr></tbody></table><h2 id=proxyaccesslogformattype>ProxyAccessLogFormatType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogformat>ProxyAccessLogFormat</a></li></ul><h2 id=proxyaccesslogsetting>ProxyAccessLogSetting</h2><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslog>ProxyAccessLog</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>format</code> <em><a href=#proxyaccesslogformat>ProxyAccessLogFormat</a></em></td><td>Format defines the format of accesslog.</td></tr><tr><td><code>sinks</code> <em><a href=#proxyaccesslogsink>ProxyAccessLogSink</a> array</em></td><td>Sinks defines the sinks of accesslog.</td></tr></tbody></table><h2 id=proxyaccesslogsink>ProxyAccessLogSink</h2><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogsetting>ProxyAccessLogSetting</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#proxyaccesslogsinktype>ProxyAccessLogSinkType</a></em></td><td>Type defines the type of accesslog sink.</td></tr><tr><td><code>file</code> <em><a href=#fileenvoyproxyaccesslog>FileEnvoyProxyAccessLog</a></em></td><td>File defines the file accesslog sink.</td></tr><tr><td><code>openTelemetry</code> <em><a href=#opentelemetryenvoyproxyaccesslog>OpenTelemetryEnvoyProxyAccessLog</a></em></td><td>OpenTelemetry defines the OpenTelemetry accesslog sink.</td></tr></tbody></table><h2 id=proxyaccesslogsinktype>ProxyAccessLogSinkType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#proxyaccesslogsink>ProxyAccessLogSink</a></li></ul><h2 id=proxybootstrap>ProxyBootstrap</h2><p>ProxyBootstrap defines Envoy Bootstrap configuration.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#bootstraptype>BootstrapType</a></em></td><td>Type is the type of the bootstrap configuration, it should be either Replace or Merge. If unspecified, it defaults to Replace.</td></tr><tr><td><code>value</code> <em>string</em></td><td>Value is a YAML string of the bootstrap.</td></tr></tbody></table><h2 id=proxylogging>ProxyLogging</h2><p>ProxyLogging defines logging parameters for managed proxies.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>level</code> <em>object (keys:<a href=#logcomponent>LogComponent</a>, values:<a href=#loglevel>LogLevel</a>)</em></td><td>Level is a map of logging level per component, where the component is the key and the log level is the value. If unspecified, defaults to &ldquo;default: warn&rdquo;.</td></tr></tbody></table><h2 id=proxymetrics>ProxyMetrics</h2><p><em>Appears in:</em></p><ul><li><a href=#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>prometheus</code> <em><a href=#prometheusprovider>PrometheusProvider</a></em></td><td>Prometheus defines the configuration for Admin endpoint <code>/stats/prometheus</code>.</td></tr><tr><td><code>sinks</code> <em><a href=#metricsink>MetricSink</a> array</em></td><td>Sinks defines the metric sinks where metrics are sent to.</td></tr><tr><td><code>matches</code> <em><a href=#match>Match</a> array</em></td><td>Matches defines configuration for selecting specific metrics instead of generating all metrics stats that are enabled by default. This helps reduce CPU and memory overhead in Envoy.</td></tr></tbody></table><h2 id=proxytelemetry>ProxyTelemetry</h2><p><em>Appears in:</em></p><ul><li><a href=#envoyproxyspec>EnvoyProxySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>accessLog</code> <em><a href=#proxyaccesslog>ProxyAccessLog</a></em></td><td>AccessLogs defines accesslog parameters for managed proxies. If unspecified, will send default format to stdout.</td></tr><tr><td><code>tracing</code> <em><a href=#proxytracing>ProxyTracing</a></em></td><td>Tracing defines tracing configuration for managed proxies. If unspecified, will not send tracing data.</td></tr><tr><td><code>metrics</code> <em><a href=#proxymetrics>ProxyMetrics</a></em></td><td>Metrics defines metrics configuration for managed proxies.</td></tr></tbody></table><h2 id=proxytracing>ProxyTracing</h2><p><em>Appears in:</em></p><ul><li><a href=#proxytelemetry>ProxyTelemetry</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>samplingRate</code> <em>integer</em></td><td>SamplingRate controls the rate at which traffic will be selected for tracing if no prior sampling decision has been made. Defaults to 100, valid values [0-100]. 100 indicates 100% sampling.</td></tr><tr><td><code>customTags</code> <em>object (keys:string, values:<a href=#customtag>CustomTag</a>)</em></td><td>CustomTags defines the custom tags to add to each span. If provider is kubernetes, pod name and namespace are added by default.</td></tr><tr><td><code>provider</code> <em><a href=#tracingprovider>TracingProvider</a></em></td><td>Provider defines the tracing provider. Only OpenTelemetry is supported currently.</td></tr></tbody></table><h2 id=ratelimit>RateLimit</h2><p>RateLimit defines the configuration associated with the Rate Limit Service used for Global Rate Limiting.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygateway>EnvoyGateway</a></li><li><a href=#envoygatewayspec>EnvoyGatewaySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>backend</code> <em><a href=#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></em></td><td>Backend holds the configuration associated with the database backend used by the rate limit service to store state associated with global ratelimiting.</td></tr><tr><td><code>timeout</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#duration-v1-meta>Duration</a></em></td><td>Timeout specifies the timeout period for the proxy to access the ratelimit server If not set, timeout is 20ms.</td></tr><tr><td><code>failClosed</code> <em>boolean</em></td><td>FailClosed is a switch used to control the flow of traffic when the response from the ratelimit server cannot be obtained. If FailClosed is false, let the traffic pass, otherwise, don&rsquo;t let the traffic pass and return 500. If not set, FailClosed is False.</td></tr></tbody></table><h2 id=ratelimitdatabasebackend>RateLimitDatabaseBackend</h2><p>RateLimitDatabaseBackend defines the configuration associated with the database backend used by the rate limit service.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimit>RateLimit</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#ratelimitdatabasebackendtype>RateLimitDatabaseBackendType</a></em></td><td>Type is the type of database backend to use. Supported types are: * Redis: Connects to a Redis database.</td></tr><tr><td><code>redis</code> <em><a href=#ratelimitredissettings>RateLimitRedisSettings</a></em></td><td>Redis defines the settings needed to connect to a Redis database.</td></tr></tbody></table><h2 id=ratelimitdatabasebackendtype>RateLimitDatabaseBackendType</h2><p><em>Underlying type:</em> <code>string</code></p><p>RateLimitDatabaseBackendType specifies the types of database backend to be used by the rate limit service.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></li></ul><h2 id=ratelimitredissettings>RateLimitRedisSettings</h2><p>RateLimitRedisSettings defines the configuration for connecting to redis database.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitdatabasebackend>RateLimitDatabaseBackend</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code> <em>string</em></td><td>URL of the Redis Database.</td></tr><tr><td><code>tls</code> <em><a href=#redistlssettings>RedisTLSSettings</a></em></td><td>TLS defines TLS configuration for connecting to redis database.</td></tr></tbody></table><h2 id=redistlssettings>RedisTLSSettings</h2><p>RedisTLSSettings defines the TLS configuration for connecting to redis database.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitredissettings>RateLimitRedisSettings</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>certificateRef</code> <em><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.SecretObjectReference>SecretObjectReference</a></em></td><td>CertificateRef defines the client certificate reference for TLS connections. Currently only a Kubernetes Secret of type TLS is supported.</td></tr></tbody></table><h2 id=requestheadercustomtag>RequestHeaderCustomTag</h2><p>RequestHeaderCustomTag adds value from request header to each span.</p><p><em>Appears in:</em></p><ul><li><a href=#customtag>CustomTag</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code> <em>string</em></td><td>Name defines the name of the request header which to extract the value from.</td></tr><tr><td><code>defaultValue</code> <em>string</em></td><td>DefaultValue defines the default value to use if the request header is not set.</td></tr></tbody></table><h2 id=resourceprovidertype>ResourceProviderType</h2><p><em>Underlying type:</em> <code>string</code></p><p>ResourceProviderType defines the types of custom resource providers supported by Envoy Gateway.</p><p><em>Appears in:</em></p><ul><li><a href=#envoygatewayresourceprovider>EnvoyGatewayResourceProvider</a></li></ul><h2 id=servicetype>ServiceType</h2><p><em>Underlying type:</em> <code>string</code></p><p>ServiceType string describes ingress methods for a service</p><p><em>Appears in:</em></p><ul><li><a href=#kubernetesservicespec>KubernetesServiceSpec</a></li></ul><h2 id=tracingprovider>TracingProvider</h2><p><em>Appears in:</em></p><ul><li><a href=#proxytracing>ProxyTracing</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#tracingprovidertype>TracingProviderType</a></em></td><td>Type defines the tracing provider type. EG currently only supports OpenTelemetry.</td></tr><tr><td><code>host</code> <em>string</em></td><td>Host define the provider service hostname.</td></tr><tr><td><code>port</code> <em>integer</em></td><td>Port defines the port the provider service is exposed on.</td></tr></tbody></table><h2 id=tracingprovidertype>TracingProviderType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#tracingprovider>TracingProvider</a></li></ul><h2 id=xdstranslatorhook>XDSTranslatorHook</h2><p><em>Underlying type:</em> <code>string</code></p><p>XDSTranslatorHook defines the types of hooks that an Envoy Gateway extension may support for the xds-translator</p><p><em>Appears in:</em></p><ul><li><a href=#xdstranslatorhooks>XDSTranslatorHooks</a></li></ul><h2 id=xdstranslatorhooks>XDSTranslatorHooks</h2><p>XDSTranslatorHooks contains all the pre and post hooks for the xds-translator runner.</p><p><em>Appears in:</em></p><ul><li><a href=#extensionhooks>ExtensionHooks</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>pre</code> <em><a href=#xdstranslatorhook>XDSTranslatorHook</a> array</em></td><td></td></tr><tr><td><code>post</code> <em><a href=#xdstranslatorhook>XDSTranslatorHook</a> array</em></td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-235a73045992670068c3cc74441d39bc>1.2 - Extension Types</h1><h1 id=api-reference>API Reference</h1><h2 id=packages>Packages</h2><ul><li><a href=#gatewayenvoyproxyiov1alpha1>gateway.envoyproxy.io/v1alpha1</a></li></ul><h2 id=gatewayenvoyproxyiov1alpha1>gateway.envoyproxy.io/v1alpha1</h2><p>Package v1alpha1 contains API schema definitions for the gateway.envoyproxy.io API group.</p><h3 id=resource-types>Resource Types</h3><ul><li><a href=#authenticationfilter>AuthenticationFilter</a></li><li><a href=#envoypatchpolicy>EnvoyPatchPolicy</a></li><li><a href=#envoypatchpolicylist>EnvoyPatchPolicyList</a></li><li><a href=#ratelimitfilter>RateLimitFilter</a></li></ul><h2 id=authenticationfilter>AuthenticationFilter</h2><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>AuthenticationFilter</code></td></tr><tr><td><code>metadata</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code> <em><a href=#authenticationfilterspec>AuthenticationFilterSpec</a></em></td><td>Spec defines the desired state of the AuthenticationFilter type.</td></tr></tbody></table><h2 id=authenticationfilterspec>AuthenticationFilterSpec</h2><p>AuthenticationFilterSpec defines the desired state of the AuthenticationFilter type.</p><p><em>Appears in:</em></p><ul><li><a href=#authenticationfilter>AuthenticationFilter</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#authenticationfiltertype>AuthenticationFilterType</a></em></td><td>Type defines the type of authentication provider to use. Supported provider types are &ldquo;JWT&rdquo;.</td></tr><tr><td><code>jwtProviders</code> <em><a href=#jwtauthenticationfilterprovider>JwtAuthenticationFilterProvider</a> array</em></td><td>JWT defines the JSON Web Token (JWT) authentication provider type. When multiple jwtProviders are specified, the JWT is considered valid if any of the providers successfully validate the JWT. For additional details, see <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/jwt_authn_filter.html>https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/jwt_authn_filter.html</a>.</td></tr></tbody></table><h2 id=authenticationfiltertype>AuthenticationFilterType</h2><p><em>Underlying type:</em> <code>string</code></p><p>AuthenticationFilterType is a type of authentication provider.</p><p><em>Appears in:</em></p><ul><li><a href=#authenticationfilterspec>AuthenticationFilterSpec</a></li></ul><h2 id=claimtoheader>ClaimToHeader</h2><p>ClaimToHeader defines a configuration to convert JWT claims into HTTP headers</p><p><em>Appears in:</em></p><ul><li><a href=#jwtauthenticationfilterprovider>JwtAuthenticationFilterProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>header</code> <em>string</em></td><td>Header defines the name of the HTTP request header that the JWT Claim will be saved into.</td></tr><tr><td><code>claim</code> <em>string</em></td><td>Claim is the JWT Claim that should be saved into the header : it can be a nested claim of type (eg. &ldquo;claim.nested.key&rdquo;, &ldquo;sub&rdquo;). The nested claim name must use dot &ldquo;.&rdquo; to separate the JSON name path.</td></tr></tbody></table><h2 id=envoyjsonpatchconfig>EnvoyJSONPatchConfig</h2><p>EnvoyJSONPatchConfig defines the configuration for patching a Envoy xDS Resource using JSONPatch semantic</p><p><em>Appears in:</em></p><ul><li><a href=#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#envoyresourcetype>EnvoyResourceType</a></em></td><td>Type is the typed URL of the Envoy xDS Resource</td></tr><tr><td><code>name</code> <em>string</em></td><td>Name is the name of the resource</td></tr><tr><td><code>operation</code> <em><a href=#jsonpatchoperation>JSONPatchOperation</a></em></td><td>Patch defines the JSON Patch Operation</td></tr></tbody></table><h2 id=envoypatchpolicy>EnvoyPatchPolicy</h2><p>EnvoyPatchPolicy allows the user to modify the generated Envoy xDS resources by Envoy Gateway using this patch API</p><p><em>Appears in:</em></p><ul><li><a href=#envoypatchpolicylist>EnvoyPatchPolicyList</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>EnvoyPatchPolicy</code></td></tr><tr><td><code>metadata</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code> <em><a href=#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></em></td><td>Spec defines the desired state of EnvoyPatchPolicy.</td></tr></tbody></table><h2 id=envoypatchpolicylist>EnvoyPatchPolicyList</h2><p>EnvoyPatchPolicyList contains a list of EnvoyPatchPolicy resources.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>EnvoyPatchPolicyList</code></td></tr><tr><td><code>metadata</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#listmeta-v1-meta>ListMeta</a></em></td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>items</code> <em><a href=#envoypatchpolicy>EnvoyPatchPolicy</a> array</em></td><td></td></tr></tbody></table><h2 id=envoypatchpolicyspec>EnvoyPatchPolicySpec</h2><p>EnvoyPatchPolicySpec defines the desired state of EnvoyPatchPolicy.</p><p><em>Appears in:</em></p><ul><li><a href=#envoypatchpolicy>EnvoyPatchPolicy</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#envoypatchtype>EnvoyPatchType</a></em></td><td>Type decides the type of patch. Valid EnvoyPatchType values are &ldquo;JSONPatch&rdquo;.</td></tr><tr><td><code>jsonPatches</code> <em><a href=#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a> array</em></td><td>JSONPatch defines the JSONPatch configuration.</td></tr><tr><td><code>targetRef</code> <em><a href=#policytargetreference>PolicyTargetReference</a></em></td><td>TargetRef is the name of the Gateway API resource this policy is being attached to. Currently only attaching to Gateway is supported This Policy and the TargetRef MUST be in the same namespace for this Policy to have effect and be applied to the Gateway TargetRef</td></tr><tr><td><code>priority</code> <em>integer</em></td><td>Priority of the EnvoyPatchPolicy. If multiple EnvoyPatchPolicies are applied to the same TargetRef, they will be applied in the ascending order of the priority i.e. int32.min has the highest priority and int32.max has the lowest priority. Defaults to 0.</td></tr></tbody></table><h2 id=envoypatchtype>EnvoyPatchType</h2><p><em>Underlying type:</em> <code>string</code></p><p>EnvoyPatchType specifies the types of Envoy patching mechanisms.</p><p><em>Appears in:</em></p><ul><li><a href=#envoypatchpolicyspec>EnvoyPatchPolicySpec</a></li></ul><h2 id=envoyresourcetype>EnvoyResourceType</h2><p><em>Underlying type:</em> <code>string</code></p><p>EnvoyResourceType specifies the type URL of the Envoy resource.</p><p><em>Appears in:</em></p><ul><li><a href=#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a></li></ul><h2 id=globalratelimit>GlobalRateLimit</h2><p>GlobalRateLimit defines global rate limit configuration.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitfilterspec>RateLimitFilterSpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>rules</code> <em><a href=#ratelimitrule>RateLimitRule</a> array</em></td><td>Rules are a list of RateLimit selectors and limits. Each rule and its associated limit is applied in a mutually exclusive way i.e. if multiple rules get selected, each of their associated limits get applied, so a single traffic request might increase the rate limit counters for multiple rules if selected.</td></tr></tbody></table><h2 id=headermatch>HeaderMatch</h2><p>HeaderMatch defines the match attributes within the HTTP Headers of the request.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitselectcondition>RateLimitSelectCondition</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#headermatchtype>HeaderMatchType</a></em></td><td>Type specifies how to match against the value of the header.</td></tr><tr><td><code>name</code> <em>string</em></td><td>Name of the HTTP header.</td></tr><tr><td><code>value</code> <em>string</em></td><td>Value within the HTTP header. Due to the case-insensitivity of header names, &ldquo;foo&rdquo; and &ldquo;Foo&rdquo; are considered equivalent. Do not set this field when Type=&ldquo;Distinct&rdquo;, implying matching on any/all unique values within the header.</td></tr></tbody></table><h2 id=headermatchtype>HeaderMatchType</h2><p><em>Underlying type:</em> <code>string</code></p><p>HeaderMatchType specifies the semantics of how HTTP header values should be compared. Valid HeaderMatchType values are &ldquo;Exact&rdquo;, &ldquo;RegularExpression&rdquo;, and &ldquo;Distinct&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=#headermatch>HeaderMatch</a></li></ul><h2 id=jsonpatchoperation>JSONPatchOperation</h2><p>JSONPatchOperation defines the JSON Patch Operation as defined in <a href=https://datatracker.ietf.org/doc/html/rfc6902>https://datatracker.ietf.org/doc/html/rfc6902</a></p><p><em>Appears in:</em></p><ul><li><a href=#envoyjsonpatchconfig>EnvoyJSONPatchConfig</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>op</code> <em><a href=#jsonpatchoperationtype>JSONPatchOperationType</a></em></td><td>Op is the type of operation to perform</td></tr><tr><td><code>path</code> <em>string</em></td><td>Path is the location of the target document/field where the operation will be performed Refer to <a href=https://datatracker.ietf.org/doc/html/rfc6901>https://datatracker.ietf.org/doc/html/rfc6901</a> for more details.</td></tr><tr><td><code>value</code> <em><a href=#json>JSON</a></em></td><td>Value is the new value of the path location.</td></tr></tbody></table><h2 id=jsonpatchoperationtype>JSONPatchOperationType</h2><p><em>Underlying type:</em> <code>string</code></p><p>JSONPatchOperationType specifies the JSON Patch operations that can be performed.</p><p><em>Appears in:</em></p><ul><li><a href=#jsonpatchoperation>JSONPatchOperation</a></li></ul><h2 id=jwtauthenticationfilterprovider>JwtAuthenticationFilterProvider</h2><p>JwtAuthenticationFilterProvider defines the JSON Web Token (JWT) authentication provider type and how JWTs should be verified:</p><p><em>Appears in:</em></p><ul><li><a href=#authenticationfilterspec>AuthenticationFilterSpec</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>name</code> <em>string</em></td><td>Name defines a unique name for the JWT provider. A name can have a variety of forms, including RFC1123 subdomains, RFC 1123 labels, or RFC 1035 labels.</td></tr><tr><td><code>issuer</code> <em>string</em></td><td>Issuer is the principal that issued the JWT and takes the form of a URL or email address. For additional details, see <a href=https://tools.ietf.org/html/rfc7519#section-4.1.1>https://tools.ietf.org/html/rfc7519#section-4.1.1</a> for URL format and <a href=https://rfc-editor.org/rfc/rfc5322.html>https://rfc-editor.org/rfc/rfc5322.html</a> for email format. If not provided, the JWT issuer is not checked.</td></tr><tr><td><code>audiences</code> <em>string array</em></td><td>Audiences is a list of JWT audiences allowed access. For additional details, see <a href=https://tools.ietf.org/html/rfc7519#section-4.1.3>https://tools.ietf.org/html/rfc7519#section-4.1.3</a>. If not provided, JWT audiences are not checked.</td></tr><tr><td><code>remoteJWKS</code> <em><a href=#remotejwks>RemoteJWKS</a></em></td><td>RemoteJWKS defines how to fetch and cache JSON Web Key Sets (JWKS) from a remote HTTP/HTTPS endpoint.</td></tr><tr><td><code>claimToHeaders</code> <em><a href=#claimtoheader>ClaimToHeader</a> array</em></td><td>ClaimToHeaders is a list of JWT claims that must be extracted into HTTP request headers For examples, following config: The claim must be of type; string, int, double, bool. Array type claims are not supported</td></tr></tbody></table><h2 id=ratelimitfilter>RateLimitFilter</h2><p>RateLimitFilter allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>apiVersion</code> <em>string</em></td><td><code>gateway.envoyproxy.io/v1alpha1</code></td></tr><tr><td><code>kind</code> <em>string</em></td><td><code>RateLimitFilter</code></td></tr><tr><td><code>metadata</code> <em><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#objectmeta-v1-meta>ObjectMeta</a></em></td><td>Refer to Kubernetes API documentation for fields of <code>metadata</code>.</td></tr><tr><td><code>spec</code> <em><a href=#ratelimitfilterspec>RateLimitFilterSpec</a></em></td><td>Spec defines the desired state of RateLimitFilter.</td></tr></tbody></table><h2 id=ratelimitfilterspec>RateLimitFilterSpec</h2><p>RateLimitFilterSpec defines the desired state of RateLimitFilter.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitfilter>RateLimitFilter</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#ratelimittype>RateLimitType</a></em></td><td>Type decides the scope for the RateLimits. Valid RateLimitType values are &ldquo;Global&rdquo;.</td></tr><tr><td><code>global</code> <em><a href=#globalratelimit>GlobalRateLimit</a></em></td><td>Global defines global rate limit configuration.</td></tr></tbody></table><h2 id=ratelimitrule>RateLimitRule</h2><p>RateLimitRule defines the semantics for matching attributes from the incoming requests, and setting limits for them.</p><p><em>Appears in:</em></p><ul><li><a href=#globalratelimit>GlobalRateLimit</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>clientSelectors</code> <em><a href=#ratelimitselectcondition>RateLimitSelectCondition</a> array</em></td><td>ClientSelectors holds the list of select conditions to select specific clients using attributes from the traffic flow. All individual select conditions must hold True for this rule and its limit to be applied. If this field is empty, it is equivalent to True, and the limit is applied.</td></tr><tr><td><code>limit</code> <em><a href=#ratelimitvalue>RateLimitValue</a></em></td><td>Limit holds the rate limit values. This limit is applied for traffic flows when the selectors compute to True, causing the request to be counted towards the limit. The limit is enforced and the request is ratelimited, i.e. a response with 429 HTTP status code is sent back to the client when the selected requests have reached the limit.</td></tr></tbody></table><h2 id=ratelimitselectcondition>RateLimitSelectCondition</h2><p>RateLimitSelectCondition specifies the attributes within the traffic flow that can be used to select a subset of clients to be ratelimited. All the individual conditions must hold True for the overall condition to hold True.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitrule>RateLimitRule</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>headers</code> <em><a href=#headermatch>HeaderMatch</a> array</em></td><td>Headers is a list of request headers to match. Multiple header values are ANDed together, meaning, a request MUST match all the specified headers.</td></tr><tr><td><code>sourceCIDR</code> <em><a href=#sourcematch>SourceMatch</a></em></td><td>SourceCIDR is the client IP Address range to match on.</td></tr></tbody></table><h2 id=ratelimittype>RateLimitType</h2><p><em>Underlying type:</em> <code>string</code></p><p>RateLimitType specifies the types of RateLimiting.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitfilterspec>RateLimitFilterSpec</a></li></ul><h2 id=ratelimitunit>RateLimitUnit</h2><p><em>Underlying type:</em> <code>string</code></p><p>RateLimitUnit specifies the intervals for setting rate limits. Valid RateLimitUnit values are &ldquo;Second&rdquo;, &ldquo;Minute&rdquo;, &ldquo;Hour&rdquo;, and &ldquo;Day&rdquo;.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitvalue>RateLimitValue</a></li></ul><h2 id=ratelimitvalue>RateLimitValue</h2><p>RateLimitValue defines the limits for rate limiting.</p><p><em>Appears in:</em></p><ul><li><a href=#ratelimitrule>RateLimitRule</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>requests</code> <em>integer</em></td><td></td></tr><tr><td><code>unit</code> <em><a href=#ratelimitunit>RateLimitUnit</a></em></td><td></td></tr></tbody></table><h2 id=remotejwks>RemoteJWKS</h2><p>RemoteJWKS defines how to fetch and cache JSON Web Key Sets (JWKS) from a remote HTTP/HTTPS endpoint.</p><p><em>Appears in:</em></p><ul><li><a href=#jwtauthenticationfilterprovider>JwtAuthenticationFilterProvider</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>uri</code> <em>string</em></td><td>URI is the HTTPS URI to fetch the JWKS. Envoy&rsquo;s system trust bundle is used to validate the server certificate.</td></tr></tbody></table><h2 id=sourcematch>SourceMatch</h2><p><em>Appears in:</em></p><ul><li><a href=#ratelimitselectcondition>RateLimitSelectCondition</a></li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>type</code> <em><a href=#sourcematchtype>SourceMatchType</a></em></td><td></td></tr><tr><td><code>value</code> <em>string</em></td><td>Value is the IP CIDR that represents the range of Source IP Addresses of the client. These could also be the intermediate addresses through which the request has flown through and is part of the <code>X-Forwarded-For</code> header. For example, <code>192.168.0.1/32</code>, <code>192.168.0.0/24</code>, <code>001:db8::/64</code>.</td></tr></tbody></table><h2 id=sourcematchtype>SourceMatchType</h2><p><em>Underlying type:</em> <code>string</code></p><p><em>Appears in:</em></p><ul><li><a href=#sourcematch>SourceMatch</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ddd7fbe6fc5666af530b7ac47a4a5fca>2 - Design</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-08c492fcd261c36dd8e0bb8dc70155eb>2.1 - Add Pprof support in Envoy Gateway</h1><h1 id=add-pprof-support-in-envoy-gateway>Add Pprof support in Envoy Gateway</h1><h2 id=overview>Overview</h2><p>Envoy Gateway exposes endpoints at <code>localhost:8899/debug/pprof</code> to run Golang profiles to aid in live debugging. The endpoints are equivalent to those found in the http/pprof package. <code>/debug/pprof/</code> returns an HTML page listing the available profiles.</p><h2 id=goals>Goals</h2><ul><li>Add Debug Pprof support to Envoy Gateway control plane.</li><li>Define an API to allow Envoy Gateway to custom debug server configuration.</li></ul><p>The following are the different types of profiles end-user can run:</p><table><thead><tr><th>PROFILE</th><th>FUNCTION</th></tr></thead><tbody><tr><td>/debug/pprof/allocs</td><td>Returns a sampling of all past memory allocations.</td></tr><tr><td>/debug/pprof/block</td><td>Returns stack traces of goroutines that led to blocking on synchronization primitives.</td></tr><tr><td>/debug/pprof/cmdline</td><td>Returns the command line that was invoked by the current program.</td></tr><tr><td>/debug/pprof/goroutine</td><td>Returns stack traces of all current goroutines.</td></tr><tr><td>/debug/pprof/heap</td><td>Returns a sampling of memory allocations of live objects.</td></tr><tr><td>/debug/pprof/mutex</td><td>Returns stack traces of goroutines holding contended mutexes.</td></tr><tr><td>/debug/pprof/profile</td><td>Returns pprof-formatted cpu profile. You can specify the duration using the seconds GET parameter. The default duration is 30 seconds.</td></tr><tr><td>/debug/pprof/symbol</td><td>Returns the program counters listed in the request.</td></tr><tr><td>/debug/pprof/threadcreate</td><td>Returns stack traces that led to creation of new OS threads.</td></tr><tr><td>/debug/pprof/trace</td><td>Returns the execution trace in binary form. You can specify the duration using the seconds GET parameter. The default duration is 1 second.</td></tr></tbody></table><h2 id=non-goals>Non Goals</h2><h2 id=api>API</h2><ul><li>Add <code>admin</code> field in EnvoyGateway config.</li><li>Add <code>debug</code> field under <code>admin</code> field.</li><li>Add <code>enable</code>, <code>port</code> and <code>host</code> under <code>address</code> field.</li></ul><p>Here is an example configuration</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;gateway.envoyproxy.io/gatewayclass-controller&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Kubernetes&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8899</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-080f800856c4aaeca39b99154c78806b>2.2 - Bootstrap Design</h1><h1 id=bootstrap-design>Bootstrap Design</h1><h2 id=overview>Overview</h2><p><a href=https://github.com/envoyproxy/gateway/issues/31>Issue 31</a> specifies the need for allowing advanced users to specify their custom
Envoy Bootstrap configuration rather than using the default Bootstrap configuration
defined in Envoy Gateway. This allows advanced users to extend Envoy Gateway and
support their custom use cases such setting up tracing and stats configuration
that is not supported by Envoy Gateway.</p><h2 id=goals>Goals</h2><ul><li>Define an API field to allow a user to specify a custom Bootstrap</li><li>Provide tooling to allow the user to generate the default Bootstrap configuration
as well as validate their custom Bootstrap.</li></ul><h2 id=non-goals>Non Goals</h2><ul><li>Allow user to configure only a section of the Bootstrap</li></ul><h2 id=api>API</h2><p>Leverage the existing <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoyproxy>EnvoyProxy</a> resource which can be attached to the <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.GatewayClass>GatewayClass</a> using
the <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.ParametersReference>parametersRef</a> field, and define a <code>Bootstrap</code> field within the resource. If this field is set,
the value is used as the Bootstrap configuration for all managed Envoy Proxies created by Envoy Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyProxySpec defines the desired state of EnvoyProxy.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyProxySpec</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>......</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Bootstrap defines the Envoy Bootstrap as a YAML string.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Visit https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/bootstrap/v3/bootstrap.proto#envoy-v3-api-msg-config-bootstrap-v3-bootstrap
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// to learn more about the syntax.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If set, this is the Bootstrap configuration used for the managed Envoy Proxy fleet instead of the default Bootstrap configuration
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// set by Envoy Gateway.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Some fields within the Bootstrap that are required to communicate with the xDS Server (Envoy Gateway) and receive xDS resources
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// from it are not configurable and will result in the `EnvoyProxy` resource being rejected.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Backward compatibility across minor versions is not guaranteed.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// We strongly recommend using `egctl x translate` to generate a `EnvoyProxy` resource with the `Bootstrap` field set to the default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Bootstrap configuration used. You can edit this configuration, and rerun `egctl x translate` to ensure there are no validation errors.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Bootstrap</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;bootstrap,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=tooling>Tooling</h2><p>A CLI tool <code>egctl x translate</code> will be provided to the user to help generate a working Bootstrap configuration.
Here is an example where a user inputs a <code>GatewayClass</code> and the CLI generates the <code>EnvoyProxy</code> resource with the <code>Bootstrap</code> field populated.</p><pre tabindex=0><code>cat &lt;&lt;EOF | egctl x translate --from gateway-api --to gateway-api -f -
apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
---

EOF
</code></pre><pre tabindex=0><code>apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
  parametersRef:
    group: config.gateway.envoyproxy.io/v1alpha1
    kind: EnvoyProxy
    name: with-bootstrap-config
---
apiVersion: config.gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: with-bootstrap-config
spec:
  bootstrap: |
    admin:
      access_log:
      - name: envoy.access_loggers.file
        typed_config:
          &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
          path: /dev/null
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 19000
    dynamic_resources:
      cds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
      lds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
    static_resources:
      clusters:
      - connect_timeout: 1s
        load_assignment:
          cluster_name: xds_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: envoy-gateway
                    port_value: 18000
        typed_extension_protocol_options:
          &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
             &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
             &#34;explicit_http_config&#34;:
               &#34;http2_protocol_options&#34;: {}
        name: xds_cluster
        type: STRICT_DNS
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              tls_params:
                tls_maximum_protocol_version: TLSv1_3
              tls_certificate_sds_secret_configs:
              - name: xds_certificate
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-certificate.json&#34;
                  resource_api_version: V3
              validation_context_sds_secret_config:
                name: xds_trusted_ca
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-trusted-ca.json&#34;
                  resource_api_version: V3
    layered_runtime:
      layers:
        - name: runtime-0
          rtds_layer:
            rtds_config:
              resource_api_version: V3
              api_config_source:
                transport_api_version: V3
                api_type: DELTA_GRPC
                grpc_services:
                  envoy_grpc:
                    cluster_name: xds_cluster
            name: runtime-0
</code></pre><p>The user can now modify the output, for their use case. Lets say for this example, the user wants to change the admin server port
from <code>19000</code> to <code>18000</code>, they can do so by editing the previous output and running <code>egctl x translate</code> again to see if there any validation
errors. Validation errors should be surfaced in the Status subresource. The internal validator will ensure that the Bootstrap string can be
unmarshalled into the Bootstrap object as well as ensure the user can override certain fields within the Bootstrap configuration such as the
<code>address</code> and tls context within the <code>xds_cluster</code> which are essential for xDS communication between Envoy Gateway and Envoy Proxy.</p><pre tabindex=0><code>cat &lt;&lt;EOF | egctl x translate --from gateway-api --to gateway-api -f -
apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
  parametersRef:
    group: config.gateway.envoyproxy.io/v1alpha1
    kind: EnvoyProxy
    name: with-bootstrap-config
---
apiVersion: config.gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: with-bootstrap-config
spec:
  bootstrap: |
    admin:
      access_log:
      - name: envoy.access_loggers.file
        typed_config:
          &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
          path: /dev/null
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 18000
    dynamic_resources:
      cds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
      lds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
    static_resources:
      clusters:
      - connect_timeout: 1s
        load_assignment:
          cluster_name: xds_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: envoy-gateway
                    port_value: 18000
        typed_extension_protocol_options:
          &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
             &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
             &#34;explicit_http_config&#34;:
               &#34;http2_protocol_options&#34;: {}
        name: xds_cluster
        type: STRICT_DNS
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              tls_params:
                tls_maximum_protocol_version: TLSv1_3
              tls_certificate_sds_secret_configs:
              - name: xds_certificate
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-certificate.json&#34;
                  resource_api_version: V3
              validation_context_sds_secret_config:
                name: xds_trusted_ca
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-trusted-ca.json&#34;
                  resource_api_version: V3
    layered_runtime:
      layers:
        - name: runtime-0
          rtds_layer:
            rtds_config:
              resource_api_version: V3
              api_config_source:
                transport_api_version: V3
                api_type: DELTA_GRPC
                grpc_services:
                  envoy_grpc:
                    cluster_name: xds_cluster
            name: runtime-0

EOF
</code></pre><pre tabindex=0><code>apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
  parametersRef:
    group: config.gateway.envoyproxy.io/v1alpha1
    kind: EnvoyProxy
    name: with-bootstrap-config
---
apiVersion: config.gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: with-bootstrap-config
spec:
  bootstrap: |
    admin:
      access_log:
      - name: envoy.access_loggers.file
        typed_config:
          &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
          path: /dev/null
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 18000
    dynamic_resources:
      cds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
      lds_config:
        resource_api_version: V3
        api_config_source:
          api_type: DELTA_GRPC
          transport_api_version: V3
          grpc_services:
          - envoy_grpc:
              cluster_name: xds_cluster
          set_node_on_first_message_only: true
    static_resources:
      clusters:
      - connect_timeout: 1s
        load_assignment:
          cluster_name: xds_cluster
          endpoints:
          - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: envoy-gateway
                    port_value: 18000
        typed_extension_protocol_options:
          &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
             &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
             &#34;explicit_http_config&#34;:
               &#34;http2_protocol_options&#34;: {}
        name: xds_cluster
        type: STRICT_DNS
        transport_socket:
          name: envoy.transport_sockets.tls
          typed_config:
            &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
            common_tls_context:
              tls_params:
                tls_maximum_protocol_version: TLSv1_3
              tls_certificate_sds_secret_configs:
              - name: xds_certificate
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-certificate.json&#34;
                  resource_api_version: V3
              validation_context_sds_secret_config:
                name: xds_trusted_ca
                sds_config:
                  path_config_source:
                    path: &#34;/sds/xds-trusted-ca.json&#34;
                  resource_api_version: V3
    layered_runtime:
      layers:
        - name: runtime-0
          rtds_layer:
            rtds_config:
              resource_api_version: V3
              api_config_source:
                transport_api_version: V3
                api_type: DELTA_GRPC
                grpc_services:
                  envoy_grpc:
                    cluster_name: xds_cluster
            name: runtime-0
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-d95b539366696a52e6bbde596fe15bde>2.3 - Configuration API Design</h1><h1 id=configuration-api-design>Configuration API Design</h1><h2 id=motivation>Motivation</h2><p><a href=https://github.com/envoyproxy/gateway/issues/51>Issue 51</a> specifies the need to design an API for configuring Envoy Gateway. The control plane is configured
statically at startup and the data plane is configured dynamically through Kubernetes resources, primarily
<a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> objects. Refer to the Envoy Gateway <a href=https://github.com/envoyproxy/gateway/blob/main/docs/design/SYSTEM_DESIGN.md>design doc</a> for additional details regarding
Envoy Gateway terminology and configuration.</p><h2 id=goals>Goals</h2><ul><li>Define an <strong>initial</strong> API to configure Envoy Gateway at startup.</li><li>Define an <strong>initial</strong> API for configuring the managed data plane, e.g. Envoy proxies.</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Implementation of the configuration APIs.</li><li>Define the <code>status</code> subresource of the configuration APIs.</li><li>Define a <strong>complete</strong> set of APIs for configuring Envoy Gateway. As stated in the <a href=#goals>Goals</a>, this document
defines the initial configuration APIs.</li><li>Define an API for deploying/provisioning/operating Envoy Gateway. If needed, a future Envoy Gateway operator would be
responsible for designing and implementing this type of API.</li><li>Specify tooling for managing the API, e.g. generate protos, CRDs, controller RBAC, etc.</li></ul><h2 id=control-plane-api>Control Plane API</h2><p>The <code>EnvoyGateway</code> API defines the control plane configuration, e.g. Envoy Gateway. Key points of this API are:</p><ul><li>It will define Envoy Gateway&rsquo;s startup configuration file. If the file does not exist, Envoy Gateway will start up
with default configuration parameters.</li><li>EnvoyGateway inlines the <code>TypeMeta</code> API. This allows EnvoyGateway to be versioned and managed as a GroupVersionKind
scheme.</li><li>EnvoyGateway does not contain a metadata field since it&rsquo;s currently represented as a static configuration file instead of
a Kubernetes resource.</li><li>Since EnvoyGateway does not surface status, EnvoyGatewaySpec is inlined.</li><li>If data plane static configuration is required in the future, Envoy Gateway will use a separate file for this purpose.</li></ul><p>The <code>v1alpha1</code> version and <code>config.gateway.envoyproxy.io</code> API group get generated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// gateway/api/config/v1alpha1/doc.go
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Package v1alpha1 contains API Schema definitions for the config.gateway.envoyproxy.io API group.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +groupName=config.gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1alpha1</span>
</span></span></code></pre></div><p>The initial <code>EnvoyGateway</code> API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// gateway/api/config/v1alpha1/envoygateway.go
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>valpha1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span> <span style=color:#4e9a06>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyGateway is the Schema for the envoygateways API
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyGateway</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeMeta</span> <span style=color:#4e9a06>`json:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// EnvoyGatewaySpec defines the desired state of Envoy Gateway.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>EnvoyGatewaySpec</span> <span style=color:#4e9a06>`json:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyGatewaySpec defines the desired state of Envoy Gateway configuration.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyGatewaySpec</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Gateway defines Gateway-API specific configuration. If unset, default
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// configuration parameters will apply.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Gateway</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Gateway</span> <span style=color:#4e9a06>`json:&#34;gateway,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Provider defines the desired provider configuration. If unspecified,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// the Kubernetes provider is used with default parameters.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Provider</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>EnvoyGatewayProvider</span> <span style=color:#4e9a06>`json:&#34;provider,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Gateway defines desired Gateway API configuration of Envoy Gateway.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Gateway</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// ControllerName defines the name of the Gateway API controller. If unspecified,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// defaults to &#34;gateway.envoyproxy.io/gatewayclass-controller&#34;. See the following
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// for additional details:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ControllerName</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;controllerName,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyGatewayProvider defines the desired configuration of a provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +union
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyGatewayProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type is the type of provider to use. If unset, the Kubernetes provider is used.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +unionDiscriminator
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>ProviderType</span> <span style=color:#4e9a06>`json:&#34;type,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Kubernetes defines the configuration of the Kubernetes provider. Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// provides runtime configuration via the Kubernetes API.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Kubernetes</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>EnvoyGatewayKubernetesProvider</span> <span style=color:#4e9a06>`json:&#34;kubernetes,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// File defines the configuration of the File provider. File provides runtime
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// configuration defined by one or more files.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>File</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>EnvoyGatewayFileProvider</span> <span style=color:#4e9a06>`json:&#34;file,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ProviderType defines the types of providers supported by Envoy Gateway.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProviderType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// KubernetesProviderType defines the &#34;Kubernetes&#34; provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>KubernetesProviderType</span> <span style=color:#000>ProviderType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Kubernetes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// FileProviderType defines the &#34;File&#34; provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>FileProviderType</span> <span style=color:#000>ProviderType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;File&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyGatewayKubernetesProvider defines configuration for the Kubernetes provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyGatewayKubernetesProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: Add config as use cases are better understood.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyGatewayFileProvider defines configuration for the File provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyGatewayFileProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: Add config as use cases are better understood.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><strong>Note:</strong> Provider-specific configuration is defined in the <code>{$PROVIDER_NAME}Provider</code> API.</p><h3 id=gateway>Gateway</h3><p>Gateway defines desired configuration of <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> controllers that reconcile and translate Gateway API
resources into the Intermediate Representation (IR). Refer to the Envoy Gateway <a href=https://github.com/envoyproxy/gateway/blob/main/docs/design/SYSTEM_DESIGN.md>design doc</a> for additional
details.</p><h3 id=provider>Provider</h3><p>Provider defines the desired configuration of an Envoy Gateway provider. A provider is an infrastructure component that
Envoy Gateway calls to establish its runtime configuration. Provider is a <a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#unions>union type</a>. Therefore, Envoy Gateway
can be configured with only one provider based on the <code>type</code> discriminator field. Refer to the Envoy Gateway
<a href=https://github.com/envoyproxy/gateway/blob/main/docs/design/SYSTEM_DESIGN.md>design doc</a> for additional details.</p><h3 id=control-plane-configuration>Control Plane Configuration</h3><p>The configuration file is defined by the EnvoyGateway API type. At startup, Envoy Gateway searches for the configuration
at &ldquo;/etc/envoy-gateway/config.yaml&rdquo;.</p><p>Start Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./envoy-gateway
</span></span></code></pre></div><p>Since the configuration file does not exist, Envoy Gateway will start with default configuration parameters.</p><p>The Kubernetes provider can be configured explicitly using <code>provider.kubernetes</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>$ cat &lt;&lt; EOF &gt; /etc/envoy-gateway/config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This configuration will cause Envoy Gateway to use the Kubernetes provider with default configuration parameters.</p><p>The Kubernetes provider can be configured using the <code>provider</code> field. For example, the <code>foo</code> field can be set to &ldquo;bar&rdquo;:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>$ cat &lt;&lt; EOF &gt; /etc/envoy-gateway/config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Kubernetes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kubernetes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>foo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Note:</strong> The Provider API from the Kubernetes package is currently undefined and <code>foo: bar</code> is provided for
illustration purposes only.</p><p>The same API structure is followed for each supported provider. The following example causes Envoy Gateway to use the
File provider:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>$ cat &lt;&lt; EOF &gt; /etc/envoy-gateway/config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>File</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>foo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>EOF</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Note:</strong> The Provider API from the File package is currently undefined and <code>foo: bar</code> is provided for illustration
purposes only.</p><p>Gateway API-related configuration is expressed through the <code>gateway</code> field. If unspecified, Envoy Gateway will use
default configuration parameters for <code>gateway</code>. The following example causes the <a href=https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.GatewayClass>GatewayClass</a> controller to
manage GatewayClasses with controllerName <code>foo</code> instead of the default <code>gateway.envoyproxy.io/gatewayclass-controller</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>$ cat &lt;&lt; EOF &gt; /etc/envoy-gateway/config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>With any of the above configuration examples, Envoy Gateway can be started without any additional arguments:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ./envoy-gateway
</span></span></code></pre></div><h2 id=data-plane-api>Data Plane API</h2><p>The data plane is configured dynamically through Kubernetes resources, primarily <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> objects.
Optionally, the data plane infrastructure can be configured by referencing a <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>custom resource (CR)</a> through
<code>spec.parametersRef</code> of the managed GatewayClass. The <code>EnvoyProxy</code> API defines the data plane infrastructure
configuration and is represented as the CR referenced by the managed GatewayClass. Key points of this API are:</p><ul><li>If unreferenced by <code>gatewayclass.spec.parametersRef</code>, default parameters will be used to configure the data plane
infrastructure, e.g. expose Envoy network endpoints using a LoadBalancer service.</li><li>Envoy Gateway will follow Gateway API <a href=https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.GatewayClass>recommendations</a> regarding updates to the EnvoyProxy CR:<blockquote><p>It is recommended that this resource be used as a template for Gateways. This means that a Gateway is based on the
state of the GatewayClass at the time it was created and changes to the GatewayClass or associated parameters are
not propagated down to existing Gateways.</p></blockquote></li></ul><p>The initial <code>EnvoyProxy</code> API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// gateway/api/config/v1alpha1/envoyproxy.go
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1alpha1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span> <span style=color:#4e9a06>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyProxy is the Schema for the envoyproxies API.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyProxy</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeMeta</span>   <span style=color:#4e9a06>`json:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectMeta</span> <span style=color:#4e9a06>`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>Spec</span>   <span style=color:#000>EnvoyProxySpec</span>   <span style=color:#4e9a06>`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#000>Status</span> <span style=color:#000>EnvoyProxyStatus</span> <span style=color:#4e9a06>`json:&#34;status,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyProxySpec defines the desired state of Envoy Proxy infrastructure
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// configuration.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyProxySpec</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Undefined by this design spec.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvoyProxyStatus defines the observed state of EnvoyProxy.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvoyProxyStatus</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Undefined by this design spec.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The EnvoyProxySpec and EnvoyProxyStatus fields will be defined in the future as proxy infrastructure configuration use
cases are better understood.</p><h3 id=data-plane-configuration>Data Plane Configuration</h3><p>GatewayClass and Gateway resources define the data plane infrastructure. Note that all examples assume Envoy Gateway is
running with the Kubernetes provider.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Since the GatewayClass does not define <code>spec.parametersRef</code>, the data plane is provisioned using default configuration
parameters. The Envoy proxies will be configured with a http listener and a Kubernetes LoadBalancer service listening
on port 80.</p><p>The following example will configure the data plane to use a ClusterIP service instead of the default LoadBalancer
service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-class</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>networkPublishing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterIPService</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Note:</strong> The NetworkPublishing API is currently undefined and is provided here for illustration purposes only.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-677b5704cda0b4585fd015f774624734>2.4 - egctl Design</h1><h1 id=egctl-design>egctl Design</h1><h2 id=motivation>Motivation</h2><p>EG should provide a command line tool with following capabilities:</p><ul><li>Collect configuration from envoy proxy and gateway</li><li>Analyse system configuration to diagnose any issues in envoy gateway</li></ul><p>This tool is named <code>egctl</code>.</p><h2 id=syntax>Syntax</h2><p>Use the following syntax to run <code>egctl</code> commands from your terminal window:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>egctl [command] [entity] [name] [flags]
</span></span></span></code></pre></div><p>where <code>command</code>, <code>name</code>, and <code>flags</code> are:</p><ul><li><p><code>command</code>: Specifies the operation that you want to perform on one or more resources,
for example <code>config</code>, <code>version</code>.</p></li><li><p><code>entity</code>: Specifies the entity the operation is being performed on such as <code>envoy-proxy</code> or <code>envoy-gateway</code>.</p></li><li><p><code>name</code>: Specifies the name of the specified instance.</p></li><li><p><code>flags</code>: Specifies optional flags. For example, you can use the <code>-c</code> or <code>--config</code> flags to specify the values for installing.</p></li></ul><p>If you need help, run <code>egctl help</code> from the terminal window.</p><h2 id=operation>Operation</h2><p>The following table includes short descriptions and the general syntax for all the <code>egctl</code> operations:</p><table><thead><tr><th>Operation</th><th>Syntax</th><th>Description</th></tr></thead><tbody><tr><td><code>version</code></td><td><code>egctl version</code></td><td>Prints out build version information.</td></tr><tr><td><code>config</code></td><td><code>egctl config ENTITY</code></td><td>Retrieve information about proxy configuration from envoy proxy and gateway</td></tr><tr><td><code>analyze</code></td><td><code>egctl analyze</code></td><td>Analyze EG configuration and print validation messages</td></tr><tr><td><code>experimental</code></td><td><code>egctl experimental</code></td><td>Subcommand for experimental features. These do not guarantee backwards compatibility</td></tr></tbody></table><h2 id=examples>Examples</h2><p>Use the following set of examples to help you familiarize yourself with running the commonly used <code>egctl</code> operations:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>#</span> Retrieve all information about proxy configuration from envoy
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>egctl config envoy-proxy all &lt;instance_name&gt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>#</span> Retrieve listener information about proxy configuration from envoy 
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>egctl config envoy-proxy listener &lt;instance_name&gt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>#</span> Retrieve information about envoy gateway
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>egctl config envoy-gateway
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-a6ba4c5d4c0dd5c5a9da577949a49126>2.5 - Envoy Gateway Extensions Design</h1><h1 id=envoy-gateway-extensions-design>Envoy Gateway Extensions Design</h1><p>As outlined in the <a href=https://github.com/envoyproxy/gateway/blob/main/GOALS.md#extensibility>official goals</a> for the Envoy Gateway project, one of the main goals is to &ldquo;provide a common foundation for vendors to build value-added products
without having to re-engineer fundamental interactions&rdquo;. Development of the Envoy Gateway project has been focused on developing the core features for the project and
Kubernetes Gateway API conformance. This system focuses on the “common foundation for vendors” component by introducing a way for vendors to extend Envoy Gateway.</p><p>To meaningfully extend Envoy Gateway and provide additional features, Extensions need to be able to introduce their own custom resources and have a high level of control
over the configuration generated by Envoy Gateway. Simply applying some static xDS configuration patches or relying on the existing Gateway API resources are both insufficient on their own
as means to add larger features that require dynamic user-configuration.</p><p>As an example, an extension developer may wish to provide their own out-of-the-box authentication filters that require configuration from the end-user. This is a scenario where the ability to introduce
custom resources and attach them to <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a>s as an <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.LocalObjectReference>ExtensionRef</a> is necessary. Providing the same feature through a series of xDS patch resources would be too cumbersome for many end-users that want to avoid
that level of complexity when managing their clusters.</p><h2 id=goals>Goals</h2><ul><li>Provide a foundation for extending the Envoy Gateway control plane</li><li>Allow Extension Developers to introduce their own custom resources for extending the Gateway-API via <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.LocalObjectReference>ExtensionRefs</a>, <a href="https://gateway-api.sigs.k8s.io/references/policy-attachment/?h=policy">policyAttachments</a> (future) and <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendObjectReference>backendRefs</a> (future).</li><li>Extension developers should <strong>NOT</strong> have to maintain a custom fork of Envoy Gateway</li><li>Provide a system for extending Envoy Gateway which allows extension projects to ship updates independent of Envoy Gateway&rsquo;s release schedule</li><li>Modify the generated Envoy xDS config</li><li>Setup a foundation for the initial iteration of Extending Envoy Gateway</li><li>Allow an Extension to hook into the infra manager pipeline (future)</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>The initial design does not capture every hook that Envoy Gateway will eventually support.</li><li>Extend <a href="https://gateway-api.sigs.k8s.io/references/policy-attachment/?h=policy">Gateway API Policy Attachments</a>. At some point, these will be addressed using this extension system, but the initial implementation omits these.</li><li>Support multiple extensions at the same time. Due to the fact that extensions will be modifying xDS resources after they are generated, handling the order of extension execution for each individual hook point is a challenge. Additionally, there is no
real way to prevent one extension from overwriting or breaking modifications to xDS resources that were made by another extension that was executed first.</li></ul><h2 id=overview>Overview</h2><p>Envoy Gateway can be extended by vendors by means of an extension server developed by the vendor and deployed alongside Envoy Gateway.
An extension server can make use of one or more pre/post hooks inside Envoy Gateway before and after its major components (translator, etc.) to allow the extension to modify the data going into or coming out of these components.
An extension can be created external to Envoy Gateway as its own Kubernetes deployment or loaded as a sidecar. gRPC is used for the calls between Envoy Gateway and an extension. In the hook call, Envoy Gateway sends data as well
as context information to the extension and expects a reply with a modified version of the data that was sent to the extension. Since extensions fundamentally alter the logic and data that Envoy Gateway provides, Extension projects assume responsibility for any bugs and issues
they create as a direct result of their modification of Envoy Gateway.</p><h2 id=diagram>Diagram</h2><p><img src=../images/extension-example.png alt=Architecture></p><h2 id=registering-extensions-in-envoy-gateway>Registering Extensions in Envoy Gateway</h2><p>Information about the extension that Envoy Gateway needs to load is configured in the Envoy Gateway config.</p><p>An example configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyGateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>extensionManager</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.myextension.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OAuth2Filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hooks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>xdsTranslator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>post</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>Route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>VirtualHost</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>HTTPListener</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>Translation</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my-extension.example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>certificateRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my-secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>An extension must supply connection information in the <code>extension.service</code> field so that Envoy Gateway can communicate with the extension. The <code>tls</code> configuration is optional.</p><p>If the extension wants Envoy Gateway to watch resources for it then the extension must configure the optional <code>extension.resources</code> field and supply a list of:</p><ul><li><code>group</code>: the API group of the resource</li><li><code>version</code>: the API version of the resource</li><li><code>kind</code>: the Kind of resource</li></ul><p>The extension can configure the <code>extensionManager.hooks</code> field to specify which hook points it would like to support. If a given hook is not listed here then it will not be executed even
if the extension is configured properly. This allows extension developers to only opt-in to the hook points they want to make use of.</p><p>This configuration is required to be provided at bootstrap and modifying the registered extension during runtime is not currently supported.
Envoy Gateway will keep track of the registered extension and its API <code>groups</code> and <code>kinds</code> when processing Gateway API resources.</p><h2 id=extending-gateway-api-and-the-data-plane>Extending Gateway API and the Data Plane</h2><p>Envoy Gateway manages <a href=https://www.envoyproxy.io/>Envoy</a> deployments, which act as the data plane that handles actual user traffic. Users configure the data plane using the K8s Gateway API resources which Envoy
Gateway converts into <a href=https://www.envoyproxy.io/docs/envoy/v1.25.1/configuration/configuration>Envoy specific configuration (xDS)</a> to send over to Envoy.</p><p>Gateway API offers <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.LocalObjectReference>ExtensionRef filters</a> and <a href="https://gateway-api.sigs.k8s.io/references/policy-attachment/?h=policy">Policy Attachments</a> as extension points for implementers to use. Envoy Gateway extends the Gateway API using these extension points to provide support for <a href=https://gateway.envoyproxy.io/v0.3.0/user/rate-limit.html>rate limiting</a>
and <a href=https://gateway.envoyproxy.io/v0.3.0/user/authn.html>authentication</a> native to the project. The initial design of Envoy Gateway extensions will primarily focus on ExtensionRef filters so that extension developers can reference their own resources as HTTP Filters in the same way
that Envoy Gateway has native support for rate limiting and authentication filters.</p><p>When Envoy Gateway encounters an <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRoute>GRPCRoute</a> that has an <code>ExtensionRef</code> <code>filter</code> with a <code>group</code> and <code>kind</code> that Envoy Gateway does not support, it will first
check the registered extension to determine if it supports the referenced object before considering it a configuration error.</p><p>This allows users to be able to reference additional filters provided by their Envoy Gateway Extension, in their <code>HTTPRoute</code>s / <code>GRPCRoute</code>s:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.myextension.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OAuth2Filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example.myextension.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OAuth2Filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-filter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In order to enable the usage of new resources introduced by an extension for translation and xDS modification, Envoy Gateway provides hook points within the translation pipeline, where it calls out to the extension service registered in the <a href=https://gateway.envoyproxy.io/v0.3.0/api/config_types.html#envoygateway>EnvoyGateway config</a>
if they specify an <code>group</code> that matches the <code>group</code> of an <code>ExtensionRef</code> filter. The extension will then be able to modify the xDS that Envoy Gateway generated and send back the
modified configuration. If an extension is not registered or if the registered extension does not specify support for the <code>group</code> of an <code>ExtensionRef</code> filter then Envoy Gateway will treat it as an unknown resource
and provide an error to the user.</p><p><strong>Note:</strong> Currently (as of <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io%2fv1beta1>v1beta1</a>) Gateway API does not provide a means to specify the namespace or version of an object referenced as an <code>ExtensionRef</code>. The extension mechanism will assume that
the namespace of any <code>ExtensionRef</code> is the same as the namespace of the <code>HTTPRoute</code> or <code>GRPCRoute</code> it is attached to rather than treating the <code>name</code> field of an <code>ExtensionRef</code> as a <code>name.namespace</code> string.
If Gateway API adds support for these fields then the design of the Envoy Gateway extensions will be updated to support them.</p><h2 id=watching-new-resources>Watching New Resources</h2><p>Envoy Gateway will dynamically create new watches on resources introduced by the registered Extension. It does so by using the <a href=https://github.com/kubernetes-sigs/controller-runtime>controller-runtime</a> to create new watches on <a href=https://pkg.go.dev/k8s.io/apimachinery/pkg/apis/meta/v1/unstructured>Unstructured</a> resources that match the <code>version</code>s, <code>group</code>s, and <code>kind</code>s that the
registered extension configured. When communicating with an extension, Envoy Gateway sends these Unstructured resources over to the extension. This eliminates the need for the extension to create its own watches which would have a strong chance of creating race conditions and reconciliation loops when resources change. When an extension receives the Unstructured resources from Envoy Gateway it can perform its own type validation on them. Currently we make the simplifying assumption that the registered extension&rsquo;s <code>Kinds</code> are filters referenced by <code>extensionRef</code> in <code>HTTPRouteFilter</code>s . Support for Policy attachments will be introduced at a later time.</p><h2 id=xds-hooks-api>xDS Hooks API</h2><p>Envoy Gateway supports the following hooks as the initial foundation of the Extension system. Additional hooks can be developed using this extension system at a later point as new use-cases and needs are discovered. The primary iteration of the extension hooks
focuses solely on the modification of xDS resources.</p><h3 id=route-modification-hook>Route Modification Hook</h3><p>The <a href=https://www.envoyproxy.io/docs/envoy/v1.23.0/api-v3/config/route/v3/route_components.proto#config-route-v3-route>Route</a> level Hook provides a way for extensions to modify a route generated by Envoy Gateway before it is finalized.
Doing so allows extensions to configure/modify route fields configured by Envoy Gateway and also to configure the
Route&rsquo;s TypedPerFilterConfig which may be desirable to do things such as pass settings and information to ext_authz filters.
The Post Route Modify hook also passes a list of Unstructured data for the externalRefs owned by the extension on the HTTPRoute that created this xDS route
This hook is always executed when an extension is loaded that has added <code>Route</code> to the <code>EnvoyProxy.extensionManager.hooks.xdsTranslator.post</code>, and only on Routes which were generated from an HTTPRoute that uses extension resources as externalRef filters.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PostRouteModifyRequest sends a Route that was generated by Envoy Gateway along with context information to an extension so that the Route can be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>message</span> <span style=color:#000>PostRouteModifyRequest</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>envoy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>v3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Route</span> <span style=color:#000>route</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>PostRouteExtensionContext</span> <span style=color:#000>post_route_context</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RouteExtensionContext provides resources introduced by an extension and watched by Envoy Gateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// additional context information can be added to this message as more use-cases are discovered
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>message</span> <span style=color:#000>PostRouteExtensionContext</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Resources introduced by the extension that were used as extensionRefs in an HTTPRoute/GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>repeated</span> <span style=color:#000>ExtensionResource</span> <span style=color:#000>extension_resources</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// hostnames are the fully qualified domain names attached to the HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>repeated</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>hostnames</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ExtensionResource stores the data for a K8s API object referenced in an HTTPRouteFilter
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// extensionRef. It is constructed from an unstructured.Unstructured marshalled to JSON. An extension
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// can marshal the bytes from this resource back into an unstructured.Unstructured and then 
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// perform type checking to obtain the resource.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>message</span> <span style=color:#000>ExtensionResource</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>bytes</span> <span style=color:#000>unstructured_bytes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PostRouteModifyResponse is the expected response from an extension and contains a modified version of the Route that was sent
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If an extension returns a nil Route then it will not be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>message</span> <span style=color:#000>PostRouteModifyResponse</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>envoy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>route</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>v3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Route</span> <span style=color:#000>route</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=virtualhost-modification-hook>VirtualHost Modification Hook</h3><p>The <a href=https://www.envoyproxy.io/docs/envoy/v1.23.0/api-v3/config/route/v3/route_components.proto#config-route-v3-virtualhost>VirtualHost</a> Hook provides a way for extensions to modify a VirtualHost generated by Envoy Gateway before it is finalized.
An extension can also make use of this hook to generate and insert entirely new Routes not generated by Envoy Gateway.
This hook is always executed when an extension is loaded that has added <code>VirtualHost</code> to the <code>EnvoyProxy.extensionManager.hooks.xdsTranslator.post</code>.
An extension may return nil to not make any changes to the VirtualHost.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PostVirtualHostModifyRequest sends a VirtualHost that was generated by Envoy Gateway along with context information to an extension so that the VirtualHost can be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostVirtualHostModifyRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>envoy.config.route.v3.VirtualHost</span> <span style=color:#000>virtual_host</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>PostVirtualHostExtensionContext</span> <span style=color:#000>post_virtual_host_context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Empty for now but we can add fields to the context as use-cases are discovered without
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// breaking any clients that use the API
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// additional context information can be added to this message as more use-cases are discovered
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostVirtualHostExtensionContext</span> <span style=color:#000;font-weight:700>{}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// PostVirtualHostModifyResponse is the expected response from an extension and contains a modified version of the VirtualHost that was sent
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If an extension returns a nil Virtual Host then it will not be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostVirtualHostModifyResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>envoy.config.route.v3.VirtualHost</span> <span style=color:#000>virtual_host</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=http-listener-modification-hook>HTTP Listener Modification Hook</h3><p>The HTTP <a href=https://www.envoyproxy.io/docs/envoy/v1.23.0/api-v3/config/listener/v3/listener.proto#config-listener-v3-listener>Listener</a> modification hook is the broadest xDS modification Hook available and allows an extension to make changes to a Listener generated by Envoy Gateway before it is finalized.
This hook is always executed when an extension is loaded that has added <code>HTTPListener</code> to the <code>EnvoyProxy.extensionManager.hooks.xdsTranslator.post</code>. An extension may return nil
in order to not make any changes to the Listener.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PostVirtualHostModifyRequest sends a Listener that was generated by Envoy Gateway along with context information to an extension so that the Listener can be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostHTTPListenerModifyRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>envoy.config.listener.v3.Listener</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>PostHTTPListenerExtensionContext</span> <span style=color:#000>post_listener_context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// Empty for now but we can add fields to the context as use-cases are discovered without
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// breaking any clients that use the API
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// additional context information can be added to this message as more use-cases are discovered
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostHTTPListenerExtensionContext</span> <span style=color:#000;font-weight:700>{}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// PostHTTPListenerModifyResponse is the expected response from an extension and contains a modified version of the Listener that was sent
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// If an extension returns a nil Listener then it will not be modified
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostHTTPListenerModifyResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>envoy.config.listener.v3.Listener</span> <span style=color:#000>listener</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=post-xds-translation-modify-hook>Post xDS Translation Modify Hook</h3><p>The Post Translate Modify hook allows an extension to modify the clusters and secrets in the xDS config.
This allows for inserting clusters that may change along with extension specific configuration to be dynamically created rather than
using custom bootstrap config which would be sufficient for clusters that are static and not prone to have their configurations changed.
An example of how this may be used is to inject a cluster that will be used by an ext_authz http filter created by the extension.
The list of clusters and secrets returned by the extension are used as the final list of all clusters and secrets
This hook is always executed when an extension is loaded that has added <code>Translation</code> to the <code>EnvoyProxy.extensionManager.hooks.xdsTranslator.post</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// PostTranslateModifyRequest currently sends only clusters and secrets to an extension.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// The extension is free to add/modify/remove the resources it received.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostTranslateModifyRequest</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#000>PostTranslateExtensionContext</span> <span style=color:#000>post_translate_context</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>envoy.config.cluster.v3.Cluster</span> <span style=color:#000>clusters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>envoy.extensions.transport_sockets.tls.v3.Secret</span> <span style=color:#000>secrets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// PostTranslateModifyResponse is the expected response from an extension and contains
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// the full list of xDS clusters and secrets to be used for the xDS config.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>PostTranslateModifyResponse</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>envoy.config.cluster.v3.Cluster</span> <span style=color:#000>clusters</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#000>envoy.extensions.transport_sockets.tls.v3.Secret</span> <span style=color:#000>secrets</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h3 id=extension-service>Extension Service</h3><p>Currently, an extension must implement all of the following hooks although it may return the input(s) it received
if no modification of the resource is desired. A future expansion of the extension hooks will allow an Extension to specify
with config which Hooks it would like to &ldquo;subscribe&rdquo; to and which Hooks it does not wish to support. These specific Hooks were chosen
in order to provide extensions with the ability to have both broad and specific control over xDS resources and to minimize the amount of data being sent.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#204a87;font-weight:700>service</span> <span style=color:#000>EnvoyGatewayExtension</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>PostRouteModify</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PostRouteModifyRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PostRouteModifyResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>PostVirtualHostModify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>PostVirtualHostModifyRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PostVirtualHostModifyResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>PostHTTPListenerModify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>PostHTTPListenerModifyRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PostHTTPListenerModifyResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>    <span style=color:#204a87;font-weight:700>rpc</span> <span style=color:#000>PostTranslateModify</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>PostTranslateModifyRequest</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>returns</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PostTranslateModifyResponse</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{};</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>}</span><span style=color:#a40000>
</span></span></span></code></pre></div><h2 id=design-decisions>Design Decisions</h2><ul><li>Envoy Gateway watches new custom resources introduced by a loaded extension and passes the resources back to the extension when they are used.<ul><li>This decision was made to solve the problem about how resources introduced by an extension get watched. If an extension server watches its own resources then it would need some way to trigger an Envoy Gateway reconfigure when a resource that Envoy Gateway is not watching gets updated. Having Envoy Gateway watch all resources removes any concern about creating race confitions or reconcile loops that would result from Envoy Gateway and the extension server both having so much separate state that needs to be synchronized.</li></ul></li><li>The Extension Server takes ownership of producing the correct xDS configuration in the hook responses</li><li>The Extension Server will be responsible for ensuring the performance of the hook processing time</li><li>The Post xDS level gRPC hooks all currently send a context field even though it contains nothing for several hooks. These fields exist so that they can be updadated in the future to pass
additional information to extensions as new use-cases and needs are discovered.</li><li>The initial design supplies the scaffolding for both &ldquo;pre xDS&rdquo; and &ldquo;post xDS&rdquo; hooks. Only the post hooks are currently implemented which operate on xDS resources after they have been generated.
The pre hooks will be implemented at a later date along with one or more hooks in the infra manager. The infra manager level hook(s) will exist to power use-cases such as dynamically creating Deployments/Services for the extension the
whenever Envoy Gateway creates an instance of Envoy Proxy. An extension developer might want to take advantage of this functionality to inject a new authorization service as a sidecar on the Envoy Proxy deployment for reduced latency.</li><li>Multiple extensions are not be supported at the same time. Preventing conflict between multiple extensions that are mangling xDS resources is too difficult to ensure compatibility with and is likely to only generate issues.</li></ul><h2 id=known-challenges>Known Challenges</h2><p>Extending Envoy Gateway by using an external extension server which makes use of hook points in Envoy Gateway does comes with a few trade-offs. One known trade-off is the impact of the time that it takes for the hook calls to be executed. Since an extension would make use of hook points in Envoy Gateway that use gRPC for communication, the time it takes to perform these requests could become a concern for some extension developers. One way to minimize the request time of the hook calls is to load the extension server as a sidecar to Envoy Gateway to minimize the impact of networking on the hook calls.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9e05365d99c70d7c35ff49ddfb3faefe>2.6 - EnvoyPatchPolicy Design</h1><h1 id=envoypatchpolicy>EnvoyPatchPolicy</h1><h2 id=overview>Overview</h2><p>This design introduces the <code>EnvoyPatchPolicy</code> API allowing users to modify the generated Envoy xDS Configuration
that Envoy Gateway generates before sending it to Envoy Proxy.</p><p>Envoy Gateway allows users to configure networking and security intent using the
upstream <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> as well as implementation specific <a href=https://gateway.envoyproxy.io/latest/api/extension_types.html>Extension APIs</a> defined in this project
to provide a more batteries included experience for application developers.</p><ul><li>These APIs are an abstracted version of the underlying Envoy xDS API to provide a better user experience for the application developer, exposing and setting only a subset of the fields for a specific feature, sometimes in a opinionated way (e.g <a href=https://gateway.envoyproxy.io/latest/user/rate-limit.html>RateLimit</a>)</li><li>These APIs do not expose all the features capabilities that Envoy has either because these features are desired but the API
is not defined yet or the project cannot support such an extensive list of features.
To alleviate this problem, and provide an interim solution for a small section of advanced users who are well versed in
Envoy xDS API and its capabilities, this API is being introduced.</li></ul><h2 id=goals>Goals</h2><ul><li>Add an API allowing users to modify the generated xDS Configuration</li></ul><h2 id=non-goals>Non Goals</h2><ul><li>Support multiple patch mechanisims</li></ul><h2 id=implementation>Implementation</h2><p><code>EnvoyPatchPolicy</code> is a <a href=https://gateway-api.sigs.k8s.io/references/policy-attachment/#direct-policy-attachment>Direct Policy Attachment</a> type API that can be used to extend <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a>
Modifications to the generated xDS configuration can be provided as a JSON Patch which is defined in
<a href=https://datatracker.ietf.org/doc/html/rfc6902>RFC 6902</a>. This patching mechanism has been adopted in <a href=https://kubernetes.io/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/>Kubernetes</a> as well as <a href=https://github.com/kubernetes-sigs/kustomize/blob/master/examples/jsonpatch.md>Kustomize</a> to update
resource objects.</p><h3 id=example>Example</h3><p>Here is an example highlighting how a user can configure global ratelimiting using an external rate limit service using this API.</p><pre tabindex=0><code>apiVersion: gateway.networking.k8s.io/v1beta1
kind: GatewayClass
metadata:
  name: eg
spec:
  controllerName: gateway.envoyproxy.io/gatewayclass-controller
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: eg
  namespace: default
spec:
  gatewayClassName: eg
  listeners:
    - name: http
      protocol: HTTP
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: backend
  namespace: default
spec:
  parentRefs:
    - name: eg
  hostnames:
    - &#34;www.example.com&#34;
  rules:
    - backendRefs:
        - group: &#34;&#34;
          kind: Service
          name: backend
          port: 3000
          weight: 1
      matches:
        - path:
            type: PathPrefix
            value: /
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: ratelimit-patch-policy
  namespace: default
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: eg
    namespace: default
  type: JSONPatch
  jsonPatches:
    - type: &#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;
      # The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
      name: default/eg/http
      operation:
        op: add
        path: &#34;/default_filter_chain/filters/0/typed_config/http_filters/0&#34;
        value:
          name: &#34;envoy.filters.http.ratelimit&#34;
          typed_config:
            &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit&#34;
            domain: &#34;eag-ratelimit&#34;
            failure_mode_deny: true
            timeout: 1s
            rate_limit_service:
              grpc_service:
                envoy_grpc:
                  cluster_name: rate-limit-cluster
              transport_api_version: V3
    - type: &#34;type.googleapis.com/envoy.config.route.v3.RouteConfiguration&#34;
      # The route name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
      name: default/eg/http
      operation:
        op: add
        path: &#34;/virtual_hosts/0/rate_limits&#34;
        value:
          - actions:
              - remote_address: {}
    - type: &#34;type.googleapis.com/envoy.config.cluster.v3.Cluster&#34;
      name: rate-limit-cluster
      operation:
        op: add
        path: &#34;&#34;
        value:
          name: rate-limit-cluster
          type: STRICT_DNS
          connect_timeout: 10s
          lb_policy: ROUND_ROBIN
          http2_protocol_options: {}
          load_assignment:
            cluster_name: rate-limit-cluster
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: ratelimit.svc.cluster.local
                          port_value: 8081
</code></pre><h2 id=verification>Verification</h2><ul><li>Offline - Leverage <a href=https://gateway.envoyproxy.io/latest/user/egctl.html#egctl-experimental-translate>egctl x translate</a> to ensure that the <code>EnvoyPatchPolicy</code> can be successfully applied and the desired
output xDS is created.</li><li>Runtime - Use the <code>Status</code> field within <code>EnvoyPatchPolicy</code> to highlight whether the patch was applied successfully or not.</li></ul><h2 id=state-of-the-world>State of the World</h2><ul><li>Istio - Supports the <a href=https://istio.io/latest/docs/reference/config/networking/envoy-filter>EnvoyFilter</a> API which allows users to customize the output xDS using patches and proto based merge
semantics.</li></ul><h2 id=design-decisions>Design Decisions</h2><ul><li>This API will only support a single <code>targetRef</code> and can bind to only a <code>Gateway</code> resource. This simplifies reasoning of how
patches will work.</li><li>This API will always be an experimental API and cannot be graduated into a stable API because Envoy Gateway cannot garuntee<ul><li>that the naming scheme for the generated resources names will not change across releases</li><li>that the underlying Envoy Proxy API will not change across releases</li></ul></li><li>This API needs to be explicitly enabled using the <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoygateway>EnvoyGateway</a> API</li></ul><h2 id=open-questions>Open Questions</h2><ul><li>Should the value only support JSON or YAML as well (which is a JSON superset) ?</li></ul><h2 id=alternatives>Alternatives</h2><ul><li>Users can customize the Envoy <a href=https://gateway.envoyproxy.io/latest/user/customize-envoyproxy.html#customize-envoyproxy-bootstrap-config>Bootstrap configuration using EnvoyProxy API</a> and provide static xDS configuration.</li><li>Users can extend functionality by <a href=https://gateway.envoyproxy.io/latest/design/extending-envoy-gateway.html>Extending the Control Plane</a> and adding gRPC hooks to modify the generated xDS configuration.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-782f8b563b3b612196dabcda1546a537>2.7 - Gateway API Translator Design</h1><h1 id=gateway-api-translator-design>Gateway API Translator Design</h1><p>The Gateway API translates external resources, e.g. GatewayClass, from the configured Provider to the Intermediate
Representation (IR).</p><h2 id=assumptions>Assumptions</h2><p>Initially target core conformance features only, to be followed by extended conformance features.</p><h2 id=inputs-and-outputs>Inputs and Outputs</h2><p>The main inputs to the Gateway API translator are:</p><ul><li>GatewayClass, Gateway, HTTPRoute, TLSRoute, Service, ReferenceGrant, Namespace, and Secret resources.</li></ul><p><strong>Note:</strong> ReferenceGrant is not fully implemented as of v0.2.</p><p>The outputs of the Gateway API translator are:</p><ul><li>Xds and Infra Internal Representations (IRs).</li><li>Status updates for GatewayClass, Gateways, HTTPRoutes</li></ul><h2 id=listener-compatibility>Listener Compatibility</h2><p>Envoy Gateway follows Gateway API listener compatibility spec:</p><blockquote><p>Each listener in a Gateway must have a unique combination of Hostname, Port, and Protocol. An implementation MAY group
Listeners by Port and then collapse each group of Listeners into a single Listener if the implementation determines
that the Listeners in the group are “compatible”.</p></blockquote><p><strong>Note:</strong> Envoy Gateway does not collapse listeners across multiple Gateways.</p><h3 id=listener-compatibility-examples>Listener Compatibility Examples</h3><h4 id=example-1-gateway-with-compatible-listeners-same-port--protocol-different-hostnames>Example 1: Gateway with compatible Listeners (same port & protocol, different hostnames)</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;*.envoygateway.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>whales.envoygateway.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=example-2-gateway-with-compatible-listeners-same-port--protocol-one-hostname-specified-one-not>Example 2: Gateway with compatible Listeners (same port & protocol, one hostname specified, one not)</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;*.envoygateway.io&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=example-3-gateway-with-incompatible-listeners-same-port-protocol-and-hostname>Example 3: Gateway with incompatible Listeners (same port, protocol and hostname)</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>whales.envoygateway.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>whales.envoygateway.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=example-4-gateway-with-incompatible-listeners-neither-specify-a-hostname>Example 4: Gateway with incompatible Listeners (neither specify a hostname)</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>allowedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>namespaces</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>All</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=computing-status>Computing Status</h2><p>Gateway API specifies a rich set of status fields & conditions for each resource. To achieve conformance, Envoy Gateway
must compute the appropriate status fields and conditions for managed resources.</p><p>Status is computed and set for:</p><ul><li>The managed GatewayClass (<code>gatewayclass.status.conditions</code>).</li><li>Each managed Gateway, based on its Listeners&rsquo; status (<code>gateway.status.conditions</code>). For the Kubernetes provider, the
Envoy Deployment and Service status are also included to calculate Gateway status.</li><li>Listeners for each Gateway (<code>gateway.status.listeners</code>).</li><li>The ParentRef for each Route (<code>route.status.parents</code>).</li></ul><p>The Gateway API translator is responsible for calculating status conditions while translating Gateway API resources to
the IR and publishing status over the <a href=watching.md>message bus</a>. The Status Manager subscribes to these status messages and
updates the resource status using the configured provider. For example, the Status Manager uses a Kubernetes client to
update resource status on the Kubernetes API server.</p><h2 id=outline>Outline</h2><p>The following roughly outlines the translation process. Each step may produce (1) IR; and (2) status updates on Gateway
API resources.</p><ol><li><p>Process Gateway Listeners</p><ul><li>Validate unique hostnames, ports, and protocols.</li><li>Validate and compute supported kinds.</li><li>Validate allowed namespaces (validate selector if specified).</li><li>Validate TLS fields if specified, including resolving referenced Secrets.</li></ul></li><li><p>Process HTTPRoutes</p><ul><li>foreach route rule:<ul><li>compute matches<ul><li>[core] path exact, path prefix</li><li>[core] header exact</li><li>[extended] query param exact</li><li>[extended] HTTP method</li></ul></li><li>compute filters<ul><li>[core] request header modifier (set/add/remove)</li><li>[core] request redirect (hostname, statuscode)</li><li>[extended] request mirror</li></ul></li><li>compute backends<ul><li>[core] Kubernetes services</li></ul></li></ul></li><li>foreach route parent ref:<ul><li>get matching listeners (check Gateway, section name, listener validation status, listener allowed routes, hostname intersection)</li><li>foreach matching listener:<ul><li>foreach hostname intersection with route:<ul><li>add each computed route rule to host</li></ul></li></ul></li></ul></li></ul></li></ol><h2 id=context-structs>Context Structs</h2><p>To help store, access and manipulate information as it&rsquo;s processed during the translation process, a set of context
structs are used. These structs wrap a given Gateway API type, and add additional fields and methods to support
processing.</p><p><code>GatewayContext</code> wraps a Gateway and provides helper methods for setting conditions, accessing Listeners, etc.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>GatewayContext</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// The managed Gateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateway</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// A list of Gateway ListenerContexts.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>listeners</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ListenerContext</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><code>ListenerContext</code> wraps a Listener and provides helper methods for setting conditions and other status information on
the associated Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ListenerContext</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// The Gateway listener.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Listener</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// The Gateway this Listener belongs to.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>gateway</span>           <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateway</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// An index used for managing this listener in the list of Gateway listeners.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>listenerStatusIdx</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Only Routes in namespaces selected by the selector may be attached
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// to the Gateway this listener belongs to.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>namespaceSelector</span> <span style=color:#000>labels</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Selector</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// The TLS Secret for this Listener, if applicable.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>tlsSecret</span>         <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Secret</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><code>RouteContext</code> represents a generic Route object (HTTPRoute, TLSRoute, etc.) that can reference Gateway objects.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>RouteContext</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Object</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// GetRouteType returns the Kind of the Route object, HTTPRoute,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// TLSRoute, TCPRoute, UDPRoute etc.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetRouteType</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// GetHostnames returns the hosts targeted by the Route object.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetHostnames</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// GetParentReferences returns the ParentReference of the Route object.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetParentReferences</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParentReference</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// GetRouteParentContext returns RouteParentContext by using the Route
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// objects&#39; ParentReference.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetRouteParentContext</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>forParentRef</span> <span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ParentReference</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RouteParentContext</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-940b0d3142db0b37b73631699b6a9680>2.8 - Observability Accesslog</h1><h1 id=observability-accesslog>Observability: Accesslog</h1><h2 id=overview>Overview</h2><p>Envoy supports extensible accesslog to different sinks, File, gRPC etc. Envoy supports customizable access log formats using predefined fields as well as arbitrary HTTP request and response headers. Envoy supports several built-in access log filters and extension filters that are registered at runtime.</p><p>Envoy Gateway leverages <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> for configuring managed Envoy proxies. Gateway API defines core, extended, and implementation-specific API <a href="https://gateway-api.sigs.k8s.io/concepts/conformance/?h=extended#2-support-levels">support levels</a> for implementors such as Envoy Gateway to expose features. Since accesslog is not covered by <code>Core</code> or <code>Extended</code> APIs, EG should provide an easy to config access log formats and sinks per <code>EnvoyProxy</code>.</p><h2 id=goals>Goals</h2><ul><li>Support send accesslog to <code>File</code> or <code>OpenTelemetry</code> backend</li><li>TODO: Support access log filters base on <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/filters/cel/v3/cel.proto#extension-envoy-access-loggers-extension-filters-cel>CEL</a> expression</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Support non-CEL filters, e.g. <code>status_code_filter</code>, <code>response_flag_filter</code></li><li>Support <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/grpc/v3/als.proto#extensions-access-loggers-grpc-v3-httpgrpcaccesslogconfig>HttpGrpcAccessLogConfig</a> or <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/access_loggers/grpc/v3/als.proto#extensions-access-loggers-grpc-v3-tcpgrpcaccesslogconfig>TcpGrpcAccessLogConfig</a></li></ul><h2 id=use-cases>Use-Cases</h2><ul><li>Configure accesslog for a <code>EnvoyProxy</code> to <code>File</code></li><li>Configure accesslog for a <code>EnvoyProxy</code> to <code>OpenTelemetry</code> backend</li><li>Configure multi accesslog providers for a <code>EnvoyProxy</code></li></ul><h3 id=proxyaccesslog-api-type>ProxyAccessLog API Type</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLog</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Disable disables access logging for managed proxies if set to true.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Disable</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#4e9a06>`json:&#34;disable,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Settings defines accesslog settings for managed proxies.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If unspecified, will send default format to stdout.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Settings</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>ProxyAccessLogSetting</span> <span style=color:#4e9a06>`json:&#34;settings,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLogSetting</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Format defines the format of accesslog.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Format</span> <span style=color:#000>ProxyAccessLogFormat</span> <span style=color:#4e9a06>`json:&#34;format&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Sinks defines the sinks of accesslog.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:MinItems=1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Sinks</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>ProxyAccessLogSink</span> <span style=color:#4e9a06>`json:&#34;sinks&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLogFormatType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// ProxyAccessLogFormatTypeText defines the text accesslog format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ProxyAccessLogFormatTypeText</span> <span style=color:#000>ProxyAccessLogFormatType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Text&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// ProxyAccessLogFormatTypeJSON defines the JSON accesslog format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ProxyAccessLogFormatTypeJSON</span> <span style=color:#000>ProxyAccessLogFormatType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;JSON&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: support format type &#34;mix&#34; in the future.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ProxyAccessLogFormat defines the format of accesslog.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +union
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLogFormat</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the type of accesslog format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=Text;JSON
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +unionDiscriminator
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>ProxyAccessLogFormatType</span> <span style=color:#4e9a06>`json:&#34;type,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Text defines the text accesslog format, following Envoy accesslog formatting,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// empty value results in proxy&#39;s default access log format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required when the format type is &#34;Text&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Envoy [command operators](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators) may be used in the format.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// The [format string documentation](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#config-access-log-format-strings) provides more information.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Text</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;text,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// JSON is additional attributes that describe the specific event occurrence.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Structured format for the envoy access logs. Envoy [command operators](https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage#command-operators)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// can be used as values for fields within the Struct.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required when the format type is &#34;JSON&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>JSON</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;json,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLogSinkType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// ProxyAccessLogSinkTypeFile defines the file accesslog sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ProxyAccessLogSinkTypeFile</span> <span style=color:#000>ProxyAccessLogSinkType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;File&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// ProxyAccessLogSinkTypeOpenTelemetry defines the OpenTelemetry accesslog sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ProxyAccessLogSinkTypeOpenTelemetry</span> <span style=color:#000>ProxyAccessLogSinkType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;OpenTelemetry&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyAccessLogSink</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the type of accesslog sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=File;OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>ProxyAccessLogSinkType</span> <span style=color:#4e9a06>`json:&#34;type,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// File defines the file accesslog sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>File</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FileEnvoyProxyAccessLog</span> <span style=color:#4e9a06>`json:&#34;file,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// OpenTelemetry defines the OpenTelemetry accesslog sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>OpenTelemetry</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>OpenTelemetryEnvoyProxyAccessLog</span> <span style=color:#4e9a06>`json:&#34;openTelemetry,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>FileEnvoyProxyAccessLog</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Path defines the file path used to expose envoy access log(e.g. /dev/stdout).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Empty value disables accesslog.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Path</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;path,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// TODO: consider reuse ExtensionService?
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>OpenTelemetryEnvoyProxyAccessLog</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Host define the extension service hostname.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Host</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;host&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Port defines the port the extension service is exposed on.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Minimum=0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=4317
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Port</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#4e9a06>`json:&#34;port,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Resources is a set of labels that describe the source of a log entry, including envoy node info.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s recommended to follow [semantic conventions](https://opentelemetry.io/docs/reference/specification/resource/semantic_conventions/).
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Resources</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;resources,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: support more OpenTelemetry accesslog options(e.g. TLS, auth etc.) in the future.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=example>Example</h3><ul><li>The following is an example to disable access log.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disable-accesslog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>The following is an example with text format access log.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>text-access-logging</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>settings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Text</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>text</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>              
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>sinks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>File</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>The following is an example with json format access log.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>json-access-logging</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>settings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JSON</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>json</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;%RESPONSE_CODE%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;%LOCAL_REPLY_BODY%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sinks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>File</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>The following is an example with OpenTelemetry format access log.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-access-logging</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>settings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Text</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>text</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>              
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>sinks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OpenTelemetry</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>openTelemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-collector.monitoring.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4317</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>k8s.cluster.name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cluster-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>The following is an example of sending same format to different sinks.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>multi-sinks</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>settings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>format</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Text</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>text</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              [%START_TIME%] &#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% &#34;%REQ(X-FORWARDED-FOR)%&#34; &#34;%REQ(USER-AGENT)%&#34; &#34;%REQ(X-REQUEST-ID)%&#34; &#34;%REQ(:AUTHORITY)%&#34; &#34;%UPSTREAM_HOST%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>              
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>sinks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>File</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OpenTelemetry</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>openTelemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-collector.monitoring.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4317</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>k8s.cluster.name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cluster-1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-db0f9dd0035b6783ae0dc21fdc2497cb>2.9 - Observability: Accesslog</h1><h1 id=observability-accesslog>Observability: Accesslog</h1><h2 id=overview>Overview</h2><p>Envoy supports extensible tracing to different sinks, Zipkin, OpenTelemetry etc. Overview of Envoy tracing can be found <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/tracing>here</a>.</p><p>Envoy Gateway leverages <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> for configuring managed Envoy proxies. Gateway API defines core, extended, and implementation-specific API <a href="https://gateway-api.sigs.k8s.io/concepts/conformance/?h=extended#2-support-levels">support levels</a> for implementors such as Envoy Gateway to expose features. Since tracing is not covered by <code>Core</code> or <code>Extended</code> APIs, EG should provide an easy to config tracing per <code>EnvoyProxy</code>.</p><p>Only OpenTelemetry sink can be configured currently, you can use <a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> to export to other tracing backends.</p><h2 id=goals>Goals</h2><ul><li>Support send tracing to <code>OpenTelemetry</code> backend</li><li>Support configurable sampling rate</li><li>Support propagate tag from <code>Literal</code>, <code>Environment</code> and <code>Request Header</code></li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Support other tracing backend, e.g. <code>Zipkin</code>, <code>Jaeger</code></li></ul><h2 id=use-cases>Use-Cases</h2><ul><li>Configure accesslog for a <code>EnvoyProxy</code> to <code>File</code></li></ul><h3 id=proxyaccesslog-api-type>ProxyAccessLog API Type</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyTracing</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// SamplingRate controls the rate at which traffic will be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// selected for tracing if no prior sampling decision has been made.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Defaults to 100, valid values [0-100]. 100 indicates 100% sampling.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Minimum=0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Maximum=100
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=100
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>SamplingRate</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>uint32</span> <span style=color:#4e9a06>`json:&#34;samplingRate,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// CustomTags defines the custom tags to add to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// If provider is kubernetes, pod name and namespace are added by default.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>CustomTags</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#000>CustomTag</span> <span style=color:#4e9a06>`json:&#34;customTags,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Provider defines the tracing provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// Only OpenTelemetry is supported currently.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Provider</span> <span style=color:#000>TracingProvider</span> <span style=color:#4e9a06>`json:&#34;provider&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>TracingProviderType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>TracingProviderTypeOpenTelemetry</span> <span style=color:#000>TracingProviderType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;OpenTelemetry&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>TracingProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the tracing provider type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// EG currently only supports OpenTelemetry.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>TracingProviderType</span> <span style=color:#4e9a06>`json:&#34;type&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Host define the provider service hostname.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Host</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;host&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Port defines the port the provider service is exposed on.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Minimum=0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=4317
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Port</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#4e9a06>`json:&#34;port,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CustomTagType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// CustomTagTypeLiteral adds hard-coded value to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>CustomTagTypeLiteral</span> <span style=color:#000>CustomTagType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Literal&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// CustomTagTypeEnvironment adds value from environment variable to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>CustomTagTypeEnvironment</span> <span style=color:#000>CustomTagType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Environment&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// CustomTagTypeRequestHeader adds value from request header to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>CustomTagTypeRequestHeader</span> <span style=color:#000>CustomTagType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;RequestHeader&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CustomTag</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the type of custom tag.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=Literal;Environment;RequestHeader
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +unionDiscriminator
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=Literal
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>CustomTagType</span> <span style=color:#4e9a06>`json:&#34;type&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Literal adds hard-coded value to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required when the type is &#34;Literal&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Literal</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>LiteralCustomTag</span> <span style=color:#4e9a06>`json:&#34;literal,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Environment adds value from environment variable to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required when the type is &#34;Environment&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Environment</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>EnvironmentCustomTag</span> <span style=color:#4e9a06>`json:&#34;environment,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// RequestHeader adds value from request header to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required when the type is &#34;RequestHeader&#34;.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>RequestHeader</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RequestHeaderCustomTag</span> <span style=color:#4e9a06>`json:&#34;requestHeader,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: add support for Metadata tags in the future.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// EG currently doesn&#39;t support metadata for route or cluster.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// LiteralCustomTag adds hard-coded value to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>LiteralCustomTag</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Value defines the hard-coded value to add to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Value</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;value&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// EnvironmentCustomTag adds value from environment variable to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EnvironmentCustomTag</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Name defines the name of the environment variable which to extract the value from.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Name</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// DefaultValue defines the default value to use if the environment variable is not set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>DefaultValue</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;defaultValue,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RequestHeaderCustomTag adds value from request header to each span.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>RequestHeaderCustomTag</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Name defines the name of the request header which to extract the value from.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Name</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// DefaultValue defines the default value to use if the request header is not set.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>DefaultValue</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;defaultValue,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=example>Example</h3><ol><li>The following is an example to config tracing.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tracing</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tracing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic># sample 100% of requests</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>samplingRate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-collector.monitoring.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4317</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>customTags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># This is an example of using a literal as a tag value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>key1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Literal</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>literal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;val1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># This is an example of using an environment variable as a tag value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>env1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Environment</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ENV1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>defaultValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic># This is an example of using a header value as a tag value</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>header1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestHeader</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>requestHeader</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>X-Header-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>defaultValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;-&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5f369822277277bf98402321ec6c584c>2.10 - Observability: Metrics</h1><h1 id=observability-metrics>Observability: Metrics</h1><h2 id=overview>Overview</h2><p>Envoy provide robust platform for metrics, Envoy support three different kinds of stats: counter, gauges, histograms.</p><p>Envoy enables prometheus format output via the <code>/stats/prometheus</code> <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/admin>admin endpoint</a>.</p><p>Envoy support different kinds of sinks, but EG will only support <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/stat_sinks/open_telemetry/v3/open_telemetry.proto>Open Telemetry sink</a>.</p><p>Envoy Gateway leverages <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> for configuring managed Envoy proxies. Gateway API defines core, extended, and implementation-specific API <a href="https://gateway-api.sigs.k8s.io/concepts/conformance/?h=extended#2-support-levels">support levels</a> for implementors such as Envoy Gateway to expose features. Since metrics is not covered by <code>Core</code> or <code>Extended</code> APIs, EG should provide an easy to config metrics per <code>EnvoyProxy</code>.</p><h2 id=goals>Goals</h2><ul><li>Support expose metrics in prometheus way(reuse probe port).</li><li>Support Open Telemetry stats sink.</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Support other stats sink.</li></ul><h2 id=use-cases>Use-Cases</h2><ul><li>Enable prometheus metric</li><li>Push metrics via Open Telemetry Sink</li><li>TODO: Customize histogram buckets of target metric</li><li>TODO: Support stats matcher</li></ul><h3 id=proxymetric-api-type>ProxyMetric API Type</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ProxyMetrics</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Prometheus defines the configuration for Admin endpoint `/stats/prometheus`.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Prometheus</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>PrometheusProvider</span> <span style=color:#4e9a06>`json:&#34;prometheus,omitempty&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Sinks defines the metric sinks where metrics are sent to.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Sinks</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>MetricSink</span> <span style=color:#4e9a06>`json:&#34;sinks,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>MetricSinkType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>MetricSinkTypeOpenTelemetry</span> <span style=color:#000>MetricSinkType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;OpenTelemetry&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>MetricSink</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the metric sink type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// EG currently only supports OpenTelemetry.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=OpenTelemetry
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>MetricSinkType</span> <span style=color:#4e9a06>`json:&#34;type&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// OpenTelemetry defines the configuration for OpenTelemetry sink.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// It&#39;s required if the sink type is OpenTelemetry.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>OpenTelemetry</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>OpenTelemetrySink</span> <span style=color:#4e9a06>`json:&#34;openTelemetry,omitempty&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>OpenTelemetrySink</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Host define the service hostname.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Host</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#4e9a06>`json:&#34;host&#34;`</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Port defines the port the service is exposed on.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Minimum=0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Maximum=65535
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +kubebuilder:default=4317
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Port</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#4e9a06>`json:&#34;port,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: add support for customizing OpenTelemetry sink in https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/stat_sinks/open_telemetry/v3/open_telemetry.proto#envoy-v3-api-msg-extensions-stat-sinks-open-telemetry-v3-sinkconfig
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>PrometheusProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=example>Example</h3><ol><li>The following is an example to enable prometheus metric.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>prometheus</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>prometheus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ol><li>The following is an example to send metric via Open Telemetry sink.</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-sink</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>telemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>sinks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>OpenTelemetry</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>openTelemetry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>otel-collector.monitoring.svc.cluster.local</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4317</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-432e167e7cba66b608808421487338d3>2.11 - Rate Limit Design</h1><h1 id=rate-limit-design>Rate Limit Design</h1><h2 id=overview>Overview</h2><p>Rate limit is a feature that allows the user to limit the number of incoming requests
to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why a user may want to implements Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><h2 id=scope-types>Scope Types</h2><p>The rate limit type here describes the scope of rate limits.</p><ul><li><p>Global - In this case, the rate limit is common across all the instances of Envoy proxies
where its applied i.e. if the data plane has 2 replicas of Envoy running, and the rate limit is
10 requests/second, this limit is common and will be hit if 5 requests pass through the first replica
and 5 requests pass through the second replica within the same second.</p></li><li><p>Local - In this case, the rate limits are specific to each instance/replica of Envoy running.
Note - This is not part of the initial design and will be added as a future enhancement.</p></li></ul><h2 id=match-types>Match Types</h2><h3 id=rate-limit-a-specific-traffic-flow>Rate limit a specific traffic flow</h3><ul><li>Here is an example of a ratelimit implemented by the application developer to limit a specific user
by matching on a custom <code>x-user-id</code> header with a value set to <code>one</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-specific-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>one</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-specific-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=rate-limit-all-traffic-flows>Rate limit all traffic flows</h3><ul><li>Here is an example of a rate limit implemented by the application developer that limits the total requests made
to a specific route to safeguard health of internal application components. In this case, no specific <code>headers</code> match
is specified, and the rate limit is applied to all traffic flows accepted by this <code>HTTPRoute</code>.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-all-requests</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Second</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-all-requests</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=rate-limit-per-distinct-value>Rate limit per distinct value</h3><ul><li>Here is an example of a rate limit implemented by the application developer to limit any unique user
by matching on a custom <code>x-user-id</code> header. Here, user A (recognised from the traffic flow using the header
<code>x-user-id</code> and value <code>a</code>) will be rate limited at 10 requests/hour and so will user B
(recognised from the traffic flow using the header <code>x-user-id</code> and value <code>b</code>).</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distinct</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-user </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=rate-limit-per-source-ip>Rate limit per source IP</h3><ul><li>Here is an example of a rate limit implemented by the application developer that limits the total requests made
to a specific route by matching on source IP. In this case, requests from <code>x.x.x.x</code> will be rate limited at 10 requests/hour.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-ip</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>sourceIP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x.x.x.x/32</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-user </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=rate-limit-based-on-jwt-claims>Rate limit based on JWT claims</h3><ul><li>Here is an example of rate limit implemented by the application developer that limits the total requests made
to a specific route by matching on the jwt claim. In this case, requests with jwt claim information of <code>{"name":"John Doe"}</code>
will be rate limited at 10 requests/hour.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JWT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwtProviders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>remoteJWKS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>claimToHeaders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>claim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>header</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-request-header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-specific-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>custom-request-header</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>John Doe</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;www.example.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>jwt-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-specific-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=multiple-ratelimitfilters-rules-and-clientselectors>Multiple RateLimitFilters, rules and clientSelectors</h2><ul><li>Users can create multiple <code>RateLimitFilter</code>s and apply it to the same <code>HTTPRoute</code>. In such a case each
<code>RateLimitFilter</code> will be applied to the route and matched (and limited) in a mutually exclusive way, independent of each other.</li><li>Rate limits are applied for each <code>RateLimitFilter</code> <code>rule</code> when ALL the conditions under <code>clientSelectors</code> hold true.</li></ul><p>Here&rsquo;s an example highlighting this -</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-all-safeguard-app </span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Second</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Global</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>clientSelectors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distinct</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x-user-id</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>unit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hour</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-per-user</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RateLimitFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit-all-safeguard-app</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><ul><li>The user has created two <code>RateLimitFilter</code>s and has attached it to a <code>HTTPRoute</code> - one(<code>ratelimit-all-safeguard-app</code>) to
ensure that the backend does not get overwhelmed with requests, any excess requests are rate limited irrespective of
the attributes within the traffic flow, and another(<code>ratelimit-per-user</code>) to rate limit each distinct user client
who can be differentiated using the <code>x-user-id</code> header, to ensure that each client does not make exessive requests to the backend.</li><li>If user <code>baz</code> (identified with the header and value of <code>x-user-id: baz</code>) sends 90 requests within the first second, and
user <code>bar</code> sends 11 more requests during that same interval of 1 second, and user <code>bar</code> sends the 101th request within that second,
the rule defined in <code>ratelimit-all-safeguard-app</code> gets activated and Envoy Gateway will ratelimit the request sent by <code>bar</code> (and any other
request sent within that 1 second). After 1 second, the rate limit counter associated with the <code>ratelimit-all-safeguard-app</code> rule
is reset and again evaluated.</li><li>If user <code>bar</code> also ends up sending 90 more requests within the hour, summing up <code>bar</code>&rsquo;s total request count to 101, the rate limit rule
defined within <code>ratelimit-per-user</code> will get activated, and <code>bar</code>&rsquo;s requests will be rate limited again until the hour interval ends.</li><li>Within the same above hour, if <code>baz</code> sends 991 more requests, summing up <code>baz</code>&rsquo;s total request count to 1001, the rate limit rule defined
within <code>ratelimit-per-user</code> will get activated for <code>baz</code>, and <code>baz</code>&rsquo;s requests will also be rate limited until the hour interval ends.</li></ul><h2 id=design-decisions>Design Decisions</h2><ul><li>The initial design uses an Extension filter to apply the Rate Limit functionality on a specific <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a>.
This was preferred over the <a href=https://gateway-api.sigs.k8s.io/references/policy-attachment/>PolicyAttachment</a> extension mechanism, because it is unclear whether Rate Limit
will be required to be enforced or overridden by the platform administrator or not.</li><li>The RateLimitFilter can only be applied as a filter to a [HTTPRouteRule[], applying it across all backends within a <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a>
and cannot be applied a filter within a <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io%2fv1beta1.HTTPBackendRef>HTTPBackendRef</a> for a specific backend.</li><li>The <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a> API has a <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteMatch>matches</a> field within each <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteMatch>rule</a> to select a specific traffic flow to be routed to
the destination backend. The RateLimitFilter API that can be attached to an HTTPRoute via an <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilterType>extensionRef</a> filter,
also has a <code>clientSelectors</code> field within each <code>rule</code> to select attributes within the traffic flow to rate limit specific clients.
The two levels of selectors/matches allow for flexibility and aim to hold match information specific to its use, allowing the author/owner
of each configuration to be different. It also allows the <code>clientSelectors</code> field within the RateLimitFilter to be enhanced with other matchable
attribute such as <a href=https://en.wikipedia.org/wiki/Subnetwork>IP subnet</a> in the future that are not relevant in the <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a> API.</li></ul><h2 id=implementation-details>Implementation Details</h2><h3 id=global-rate-limiting>Global Rate limiting</h3><ul><li><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a> in Envoy Proxy can be achieved using the following -<ul><li><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-ratelimit-action>Actions</a> can be conifgured per <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-routeaction>xDS Route</a>.</li><li>If the match criteria defined within these actions is met for a specific HTTP Request, a set of key value pairs called <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/rate_limit_filter.html?highlight=descriptor#example-1">descriptors</a>
defined within the above actions is sent to a remote <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/other_features/rate_limit#config-rate-limit-service>rate limit service</a>, whose configuration (such as the URL for the rate limit service) is defined
using a <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ratelimit/v3/rate_limit.proto#envoy-v3-api-msg-extensions-filters-http-ratelimit-v3-ratelimit>rate limit filter</a>.</li><li>Based on information received by the rate limit service and its programmed configuration, a decision is computed, whether to rate limit
the HTTP Request or not, and is sent back to Envoy, which enforces this decision on the data plane.</li></ul></li><li>Envoy Gateway will leverage this Envoy Proxy feature by -<ul><li>Translating the user facing RateLimitFilter API into Rate limit <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-ratelimit-action>Actions</a> as well as Rate limit service configuration to implement
the desired API intent.</li><li>Envoy Gateway will use the existing <a href=https://github.com/envoyproxy/ratelimit>reference implementation</a> of the rate limit service.<ul><li>The Infrastructure administrator will need to enable the rate limit service using new settings that will be defined in the <a href=https://github.com/envoyproxy/gateway/blob/main/api/config/v1alpha1/envoygateway_types.go>EnvoyGateway</a> config API.</li></ul></li><li>The xDS IR will be enhanced to hold the user facing rate limit intent.</li><li>The xDS Translator will be enhanced to translate the rate limit field within the xDS IR into Rate limit <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-ratelimit-action>Actions</a> as well as instantiate the <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ratelimit/v3/rate_limit.proto#envoy-v3-api-msg-extensions-filters-http-ratelimit-v3-ratelimit>rate limit filter</a>.</li><li>A new runner called <code>rate-limit</code> will be added that subscribes to the xDS IR messages and translates it into a new Rate Limit Infra IR which contains
the <a href=https://github.com/envoyproxy/ratelimit#configuration>rate limit service configuration</a> as well as other information needed to deploy the rate limit service.</li><li>The infrastructure service will be enhanced to subscribe to the Rate Limit Infra IR and deploy a provider specific rate limit service runnable entity.</li><li>A Status field within the RateLimitFilter API will be added to reflect whether the specific configuration was programmed correctly in these multiple locations or not.</li></ul></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b622e15212ac176fc0f98dd89f3a9916>2.12 - Request Authentication Design</h1><h1 id=request-authentication-design>Request Authentication Design</h1><h2 id=overview>Overview</h2><p><a href=https://github.com/envoyproxy/gateway/issues/336>Issue 336</a> specifies the need for exposing a user-facing API to configure request authentication. Request
authentication is defined as an authentication mechanism to be enforced by Envoy on a per-request basis. A connection
will be rejected if it contains invalid authentication information, based on the <code>AuthenticationFilter</code> API type
proposed in this design document.</p><p>Envoy Gateway leverages <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> for configuring managed Envoy proxies. Gateway API defines core, extended, and
implementation-specific API <a href="https://gateway-api.sigs.k8s.io/concepts/conformance/?h=extended#2-support-levels">support levels</a> for implementors such as Envoy Gateway to expose features. Since
implementing request authentication is not covered by <code>Core</code> or <code>Extended</code> APIs, an <code>Implementation-specific</code> API will
be created for this purpose.</p><h2 id=goals>Goals</h2><ul><li>Define an API for configuring request authentication.</li><li>Implement <a href=https://jwt.io/>JWT</a> as the first supported authentication type.</li><li>Allow users that manage routes, e.g. <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a>, to authenticate matching requests before forwarding to a backend
service.</li><li>Support HTTPRoutes as an Authentication API referent. HTTPRoute provides multiple <a href="https://gateway-api.sigs.k8s.io/concepts/api-overview/?h=extension#extension-points">extension points</a>. The
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>HTTPRouteFilter</a> is the extension point supported by the Authentication API.</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Allow infrastructure administrators to override or establish default authentication policies.</li><li>Support referents other than HTTPRoute.</li><li>Support Gateway API extension points other than HTTPRouteFilter.</li></ul><h2 id=use-cases>Use-Cases</h2><p>These use-cases are presented as an aid for how users may attempt to utilize the outputs of the design. They are not an
exhaustive list of features for authentication support in Envoy Gateway.</p><p>As a Service Producer, I need the ability to:</p><ul><li>Authenticate a request before forwarding it to a backend service.</li><li>Have different authentication mechanisms per route rule.</li><li>Choose from different authentication mechanisms supported by Envoy, e.g. OIDC.</li></ul><h3 id=authentication-api-type>Authentication API Type</h3><p>The Authentication API type defines authentication configuration for authenticating requests through managed Envoy
proxies.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1alpha1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span> <span style=color:#4e9a06>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>AuthenticationFilter</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeMeta</span>
</span></span><span style=display:flex><span>	<span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectMeta</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Spec defines the desired state of the Authentication type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Spec</span> <span style=color:#000>AuthenticationFilterSpec</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Note: The status sub-resource has been excluded but may be added in the future.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// AuthenticationFilterSpec defines the desired state of the AuthenticationFilter type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +union
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>AuthenticationFilterSpec</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Type defines the type of authentication provider to use. Supported provider types are:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// * JWT: A provider that uses JSON Web Token (JWT) for authenticating requests.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +unionDiscriminator
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Type</span> <span style=color:#000>AuthenticationFilterType</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// JWT defines the JSON Web Token (JWT) authentication provider type. When multiple
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// jwtProviders are specified, the JWT is considered valid if any of the providers
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// successfully validate the JWT.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>JwtProviders</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>JwtAuthenticationFilterProvider</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>Refer to <a href=https://github.com/envoyproxy/gateway/pull/733>PR 773</a> for the detailed AuthenticationFilter API spec.</p><p>The status subresource is not included in the AuthenticationFilter API. Status will be surfaced by an HTTPRoute that
references an AuthenticationFilter. For example, an HTTPRoute will surface the <code>ResolvedRefs=False</code> status condition if it
references an AuthenticationFilter that does not exist. It may be beneficial to add AuthenticationFilter status fields in the future
based on defined use-cases. For example, a remote <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a> can be validated based on the specified URI and have an
appropriate status condition surfaced.</p><h4 id=authenticationfilter-example>AuthenticationFilter Example</h4><p>The following is an AuthenticationFilter example with one JWT authentication provider:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JWT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwtProviders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>remoteJwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://foo.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>&lt;TBD&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Note:</strong> <code>type</code> is a union type, allowing only one of any supported provider type such as <code>jwtProviders</code> to be
specified.</p><p>The following is an example HTTPRoute configured to use the above JWT authentication provider:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Requests for <code>www.example.com/foo</code> will be authenticated using the referenced JWT provider before being forwarded to the
backend service named &ldquo;backend&rdquo;.</p><h2 id=implementation-details>Implementation Details</h2><p>The JWT authentication type is translated to an Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/jwt_authn_filter#config-http-filters-jwt-authn>JWT authentication filter</a> and a cluster is created for each
remote <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a>. The following examples provide additional details on how Gateway API and AuthenticationFilter resources are
translated into Envoy configuration.</p><h3 id=example-1-one-route-with-one-jwt-provider>Example 1: One Route with One JWT Provider</h3><p>The following cluster is created from the above HTTPRoute and AuthenticationFilter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>dynamic_clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo.com|443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>load_assignment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>cluster_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo.com|443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>lb_endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>socket_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>port_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>transport_socket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.transport_sockets.tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>&#34;@type&#34;: </span><span style=color:#000>type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>sni</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>common_tls_context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>validation_context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>match_subject_alt_names</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>exact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;*.foo.com&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>trusted_ca</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>filename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/ssl/certs/ca-certificates.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>A JWT authentication HTTP filter is added to the HTTP Connection Manager. For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>dynamic_resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamic_listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example_listener</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>socket_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1.2.3.4</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filter_chains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.http_connection_manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>http_filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.jwt_authn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>&#34;@type&#34;: </span><span style=color:#000>type.googleapis.com/envoy.config.filter.http.jwt_authn.v2alpha.JwtAuthentication</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This JWT authentication HTTP filter contains two fields:</p><ul><li>The <code>providers</code> field specifies how a JWT should be verified, such as where to extract the token, where to fetch the
public key (<a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a>) and where to output its payload. This field is built from the source resource <code>namespace-name</code>, and
the JWT provider name of an AuthenticationFilter.</li><li>The <code>rules</code> field specifies matching rules and their requirements. If a request matches a rule, its requirement
applies. The requirement specifies which JWT providers should be used. This field is built from a HTTPRoute
<code>matches</code> rule that references the AuthenticationFilter. When a referenced Authentication specifies multiple
<code>jwtProviders</code>, the JWT is considered valid if <strong>any</strong> of the providers successfully validate the JWT.</li></ul><p>The following JWT authentication HTTP filter <code>providers</code> configuration is created from the above AuthenticationFilter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>example</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>remote_jwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>http_uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://foo.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example_jwks_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>1s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The following JWT authentication HTTP filter <code>rules</code> configuration is created from the above HTTPRoute.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>provider_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-example-example</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=example-2-two-httproutes-with-different-authenticationfilters>Example 2: Two HTTPRoutes with Different AuthenticationFilters</h3><p>The following example contains:</p><ul><li>Two HTTPRoutes with different hostnames.</li><li>Each HTTPRoute references a different AuthenticationFilter.</li><li>Each AuthenticationFilter contains a different JWT provider.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JWT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwtProviders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example1.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>remoteJwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://foo.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>JWT</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jwtProviders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>bar.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>remoteJwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://bar.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>www.example1.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io/v1beta1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>www.example2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ExtensionRef</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>extensionRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthenticationFilter</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The following xDS configuration is created from the above example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dynamic_listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>default_filter_chain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.network.http_connection_manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>&gt;-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span style=color:#f8f8f8;text-decoration:underline>                
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>stat_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>rds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>config_source</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>route_config_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>http_filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.jwt_authn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>&gt;-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      type.googleapis.com/envoy.config.filter.http.jwt_authn.v2alpha.JwtAuthentication</span><span style=color:#f8f8f8;text-decoration:underline>                      
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>default-example1-example1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example1.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span>- <span style=color:#000>foo.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>remote_jwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>http_uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://foo.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-example1-example1-jwt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>default-example2-example2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://www.example2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>audiences</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span>- <span style=color:#000>bar.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>remote_jwks</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>http_uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#204a87;font-weight:700>uri</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://bar.com/jwt/public-key/jwks.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                            </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-example2-example2-jwt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>exact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>provider_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-example1-example1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>exact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                          </span><span style=color:#204a87;font-weight:700>provider_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-example2-example2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.router</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>typed_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>&gt;-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span><span style=color:#f8f8f8;text-decoration:underline>                      
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dynamic_route_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>route_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>virtual_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#4e9a06>&#39;*&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>routes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;:authority&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>string_match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>exact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>www.example1.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example1.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>headers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;:authority&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>string_match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                      </span><span style=color:#204a87;font-weight:700>exact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>www.example2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend2-rule-0-match-0-www.example2.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dynamic_active_clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>locality</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>lb_endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>socket_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>$BACKEND_SERVICE1_IP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>port_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.cluster.v3.Cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-1-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>locality</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>lb_endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>socket_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>$BACKEND_SERVICE2_IP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>port_value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p><strong>Note:</strong> The JWT provider cluster and route is omitted from the above example for brevity.</p><h3 id=implementation-outline>Implementation Outline</h3><ul><li>Update the Kubernetes provider to get/watch AuthenticationFilter resources that are referenced by managed HTTPRoutes.
Add the referenced AuthenticationFilter object to the resource map and publish it.</li><li>Update the resource translator to include the AuthenticationFilter API in HTTPRoute processing.</li><li>Update the xDS translator to translate an AuthenticationFilter into xDS resources. The translator should perform the
following:<ul><li>Convert a list of JWT rules from the xds IR into an Envoy JWT filter config.</li><li>Create a JWT authentication HTTP filter.</li><li>Build the HTTP Connection Manager (HCM) HTTP filters.</li><li>Build the HCM.</li><li>When building the Listener, create an HCM for each filter-chain.</li></ul></li></ul><h2 id=adding-authentication-types>Adding Authentication Types</h2><p>Additional authentication types can be added in the future through the <code>AuthenticationFilterType</code> API. For
example, to add the <code>Foo</code> authentication type:</p><p>Define the <code>Foo</code> authentication provider:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1alpha1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// FooAuthenticationFilterProvider defines the &#34;Foo&#34; authentication filter provider type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>FooAuthenticationFilterProvider</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// TODO: Define fields of the Foo authentication filter provider type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Add the <code>FooAuthenticationFilterProvider</code> type to <code>AuthenticationFilterSpec</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1alpha1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>AuthenticationFilterSpec</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// Foo defines the Foo authentication type. For additional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// details, see:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//   &lt;INSERT_LINK&gt;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// +optional
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Foo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FooAuthenticationFilterProvider</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Lastly, add the type to the <code>AuthenticationType</code> enum:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// AuthenticationType is a type of authentication provider.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// +kubebuilder:validation:Enum=JWT,FOO
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>AuthenticationFilterType</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// JwtAuthenticationProviderType is the JWT authentication provider type.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>FooAuthenticationFilterProviderType</span> <span style=color:#000>AuthenticationFilterType</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;FOO&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>The AuthenticationFilter API should support additional authentication types in the future, for example:</p><ul><li>OAuth2</li><li>OIDC</li></ul><h2 id=outstanding-questions>Outstanding Questions</h2><ul><li>If Envoy Gateway owns the AuthenticationFilter API, is an xDS IR equivalent needed?</li><li>Should local <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a> be implemented before remote <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a>?</li><li>How should Envoy obtain the trusted CA for a remote <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a>?</li><li>Should HTTPS be the only supported scheme for remote <a href=https://www.rfc-editor.org/rfc/rfc7517>JWKS</a>?</li><li>Should OR&rsquo;ing JWT providers be supported?</li><li>Should Authentication provide status?</li><li>Are the API field validation rules acceptable?</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d200fa855c2d507debade16505dee377>2.13 - Roadmap</h1><h1 id=roadmap>Roadmap</h1><p>This document serves as a high-level reference for Envoy Gateway users and contributors to understand the direction of
the project.</p><h2 id=contributing-to-the-roadmap>Contributing to the Roadmap</h2><ul><li>To add a feature to the roadmap, create an <a href=https://github.com/envoyproxy/gateway/issues>issue</a> or join a <a href="https://docs.google.com/document/d/1leqwsHX8N-XxNEyTflYjRur462ukFxd19Rnk3Uzy55I/edit?usp=sharing">community meeting</a> to discuss your use
case. If your feature is accepted, a maintainer will assign your issue to a <a href=https://github.com/envoyproxy/gateway/milestones>release milestone</a> and update
this document accordingly.</li><li>To help with an existing roadmap item, comment on or assign yourself to the associated issue.</li><li>If a roadmap item doesn&rsquo;t have an issue, create one, assign yourself to the issue, and reference this document. A
maintainer will submit a <a href=https://github.com/envoyproxy/gateway/compare>pull request</a> to add the feature to the roadmap. <strong>Note:</strong> The feature should be
discussed in an issue or a community meeting before implementing it.</li></ul><p>If you don&rsquo;t know where to start contributing, help is needed to reduce technical, automation, and documentation debt.
Look for issues with the <code>help wanted</code> label to get started.</p><h2 id=details>Details</h2><p>Roadmap features and timelines may change based on feedback, community contributions, etc. If you depend on a specific
roadmap item, you&rsquo;re encouraged to attend a community meeting to discuss the details, or help us deliver the feature by
contributing to the project.</p><p><code>Last Updated: April 2023</code></p><h3 id=v020v020-establish-a-solid-foundation><a href=https://github.com/envoyproxy/gateway/milestone/1>v0.2.0</a>: Establish a Solid Foundation</h3><ul><li>Complete the core Envoy Gateway implementation- <a href=https://github.com/envoyproxy/gateway/issues/60>Issue #60</a>.</li><li>Establish initial testing, e2e, integration, etc- <a href=https://github.com/envoyproxy/gateway/issues/64>Issue #64</a>.</li><li>Establish user and developer project documentation- <a href=https://github.com/envoyproxy/gateway/issues/17>Issue #17</a>.</li><li>Achieve Gateway API conformance (e.g. routing, LB, Header transformation, etc.)- <a href=https://github.com/envoyproxy/gateway/issues/65>Issue #65</a>.</li><li>Setup a CI/CD pipeline- <a href=https://github.com/envoyproxy/gateway/issues/63>Issue #63</a>.</li></ul><h3 id=v030v030-drive-advanced-features-through-extension-mechanisms><a href=https://github.com/envoyproxy/gateway/milestone/7>v0.3.0</a>: Drive Advanced Features through Extension Mechanisms</h3><ul><li>Support extended Gateway API fields <a href=https://github.com/envoyproxy/gateway/issues/707>Issue #707</a>.</li><li>Support experimental Gateway APIs such as TCPRoute <a href=https://github.com/envoyproxy/gateway/issues/643>Issue #643</a>, UDPRoute <a href=https://github.com/envoyproxy/gateway/issues/641>Issue #641</a> and GRPCRoute <a href=https://github.com/envoyproxy/gateway/issues/642>Issue #642</a>.</li><li>Establish guidelines for leveragaing Gateway API extensions <a href=https://github.com/envoyproxy/gateway/issues/675>Issue #675</a>.</li><li>Rate Limiting <a href=https://github.com/envoyproxy/gateway/issues/670>Issue #670</a>.</li><li>Authentication <a href=https://github.com/envoyproxy/gateway/issues/336>Issue #336</a>.</li></ul><h3 id=v040v040-customizing-envoy-gateway><a href=https://github.com/envoyproxy/gateway/milestone/12>v0.4.0</a>: Customizing Envoy Gateway</h3><ul><li>Extending Envoy Gateway control plane <a href=https://github.com/envoyproxy/gateway/issues/20>Issue #20</a></li><li>Helm based installation for Envoy Gateway <a href=https://github.com/envoyproxy/gateway/issues/650>Issue #650</a></li><li>Customizing managed Envoy Proxy Kubernetes resource fields <a href=https://github.com/envoyproxy/gateway/issues/648>Issue #648</a></li><li>Configuring xDS Bootstrap <a href=https://github.com/envoyproxy/gateway/issues/31>Issue #31</a></li></ul><h3 id=v050v050-observability-and-scale><a href=https://github.com/envoyproxy/gateway/milestone/13>v0.5.0</a>: Observability and Scale</h3><ul><li>Observability for data plane <a href=https://github.com/envoyproxy/gateway/issues/699>Issue #699</a>.</li><li>Allow users to configure xDS Resources <a href=https://github.com/envoyproxy/gateway/issues/24>Issue #24</a>.</li></ul><h3 id=v060v060-preparation-for-ga><a href=https://github.com/envoyproxy/gateway/milestone/15>v0.6.0</a>: Preparation for GA</h3><ul><li>Observability for control plane <a href=https://github.com/envoyproxy/gateway/issues/700>Issue #700</a>.</li><li>Compute and document Envoy Gateway performance <a href=https://github.com/envoyproxy/gateway/issues/1365>Issue #1365</a>.</li><li>Add TrafficPolicy APIs for advanced features <a href=https://github.com/envoyproxy/gateway/issues/1492>Issue #1492</a>.</li><li>Envoy Gateway meets readiness criteria <a href=https://github.com/envoyproxy/gateway/issues/1160>Issue #1160</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-3fc30f1a064a6892e5ad574d47d9721b>2.14 - Running Envoy Gateway locally</h1><h1 id=running-envoy-gateway-locally>Running Envoy Gateway locally</h1><h2 id=overview>Overview</h2><p>Today, Envoy Gateway runs only on Kubernetes. This is an ideal solution
when the applications are running in Kubernetes.
However there might be cases when the applications are running on the host which would
require Envoy Gateway to run locally.</p><h2 id=goals>Goals</h2><ul><li>Define an API to allow Envoy Gateway to retrieve configuration while running locally.</li><li>Define an API to allow Envoy Gateway to deploy the managed Envoy Proxy fleet on the host
machine.</li></ul><h2 id=non-goals>Non Goals</h2><ul><li>Support multiple ways to retrieve configuration while running locally.</li><li>Support multiple ways to deploy the Envoy Proxy fleet locally on the host.</li></ul><h2 id=api>API</h2><ul><li>The <code>provider</code> field within the <code>EnvoyGateway</code> configuration only supports
<code>Kubernetes</code> today which provides two features - the ability to retrieve
resources from the Kubernetes API Server as well as deploy the managed
Envoy Proxy fleet on Kubernetes.</li><li>This document proposes adding a new top level <code>provider</code> type called <code>Custom</code>
with two fields called <code>resource</code> and <code>infrastructure</code> to allow the user to configure
the sub providers for providing resource configuration and an infrastructure to deploy
the Envoy Proxy data plane in.</li><li>A <code>File</code> resource provider will be introduced to enable retrieveing configuration locally
by reading from the configuration from a file.</li><li>A <code>Host</code> infrastructure provider will be introduced to allow Envoy Gateway to spawn a
Envoy Proxy child process on the host.</li></ul><p>Here is an example configuration</p><pre tabindex=0><code>provider:
  type: Custom
  custom:
    resource:
      type: File
      file:
        paths: 
        - &#34;config.yaml&#34;
    infrastructure:
      type: Host
      host: {}
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-0fa34640d8b8d8fca8f387300d585a92>2.15 - System Design</h1><h1 id=system-design>System Design</h1><h2 id=goals>Goals</h2><ul><li>Define the system components needed to satisfy the requirements of Envoy Gateway.</li></ul><h2 id=non-goals>Non-Goals</h2><ul><li>Create a detailed design and interface specification for each system component.</li></ul><h2 id=terminology>Terminology</h2><ul><li>Control Plane- A collection of inter-related software components for providing application gateway and routing
functionality. The control plane is implemented by Envoy Gateway and provides services for managing the data plane.
These services are detailed in the <a href=#components>components</a> section.</li><li>Data Plane- Provides intelligent application-level traffic routing and is implemented as one or more Envoy proxies.</li></ul><h2 id=architecture>Architecture</h2><p><img src=../images/architecture.png alt=Architecture></p><h2 id=configuration>Configuration</h2><p>Envoy Gateway is configured statically at startup and the managed data plane is configured dynamically through
Kubernetes resources, primarily <a href=https://gateway-api.sigs.k8s.io>Gateway API</a> objects.</p><h3 id=static-configuration>Static Configuration</h3><p>Static configuration is used to configure Envoy Gateway at startup, i.e. change the GatewayClass controllerName,
configure a Provider, etc. Currently, Envoy Gateway only supports configuration through a configuration file. If the
configuration file is not provided, Envoy Gateway starts-up with default configuration parameters.</p><h3 id=dynamic-configuration>Dynamic Configuration</h3><p>Dynamic configuration is based on the concept of a declaring the desired state of the data plane and using
reconciliation loops to drive the actual state toward the desired state. The desired state of the data plane is
defined as Kubernetes resources that provide the following services:</p><ul><li>Infrastructure Management- Manage the data plane infrastructure, i.e. deploy, upgrade, etc. This configuration is
expressed through <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#gatewayclass>GatewayClass</a> and <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#gateway>Gateway</a> resources. The <code>EnvoyProxy</code> <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>Custom Resource</a> can be
referenced by <code>gatewayclass.spec.parametersRef</code> to modify data plane infrastructure default parameters,
e.g. expose Envoy network endpoints using a <code>ClusterIP</code> service instead of a <code>LoadBalancer</code> service.</li><li>Traffic Routing- Define how to handle application-level requests to backend services. For example, route all HTTP
requests for &ldquo;<a href=https://www.example.com>www.example.com</a>&rdquo; to a backend service running a web server. This configuration is expressed through
<a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#httproute>HTTPRoute</a> and <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#tlsroute>TLSRoute</a> resources that match, filter, and route traffic to a <a href=https://gateway-api.sigs.k8s.io/v1alpha2/references/spec/#gateway.networking.k8s.io/v1alpha2.BackendObjectReference>backend</a>.
Although a backend can be any valid Kubernetes Group/Kind resource, Envoy Gateway only supports a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>
reference.</li></ul><h2 id=components>Components</h2><p>Envoy Gateway is made up of several components that communicate in-process; how this communication happens is described
in the <a href=./watching.md>Watching Components Design</a>.</p><h3 id=provider>Provider</h3><p>A Provider is an infrastructure component that Envoy Gateway calls to establish its runtime configuration, resolve
services, persist data, etc. As of v0.2, Kubernetes is the only implemented provider. A file provider is on the roadmap
via <a href=https://github.com/envoyproxy/gateway/issues/37>Issue #37</a>. Other providers can be added in the future as Envoy Gateway use cases are better understood. A
provider is configured at start up through Envoy Gateway&rsquo;s <a href=#static-configuration>static configuration</a>.</p><h4 id=kubernetes-provider>Kubernetes Provider</h4><ul><li>Uses Kubernetes-style controllers to reconcile Kubernetes resources that comprise the
<a href=#dynamic-configuration>dynamic configuration</a>.</li><li>Manages the data plane through Kubernetes API CRUD operations.</li><li>Uses Kubernetes for Service discovery.</li><li>Uses etcd (via Kubernetes API) to persist data.</li></ul><h4 id=file-provider>File Provider</h4><ul><li>Uses a file watcher to watch files in a directory that define the data plane configuration.</li><li>Manages the data plane by calling internal APIs, e.g. <code>CreateDataPlane()</code>.</li><li>Uses the host&rsquo;s DNS for Service discovery.</li><li>If needed, the local filesystem is used to persist data.</li></ul><h3 id=resource-watcher>Resource Watcher</h3><p>The Resource Watcher watches resources used to establish and maintain Envoy Gateway&rsquo;s dynamic configuration. The
mechanics for watching resources is provider-specific, e.g. informers, caches, etc. are used for the Kubernetes
provider. The Resource Watcher uses the configured provider for input and provides resources to the Resource Translator
as output.</p><h3 id=resource-translator>Resource Translator</h3><p>The Resource Translator translates external resources, e.g. GatewayClass, from the Resource Watcher to the Intermediate
Representation (IR). It is responsible for:</p><ul><li>Translating infrastructure-specific resources/fields from the Resource Watcher to the Infra IR.</li><li>Translating proxy configuration resources/fields from the Resource Watcher to the xDS IR.</li></ul><p><strong>Note:</strong> The Resource Translator is implemented as the <code>Translator</code> API type in the <code>gatewayapi</code> package.</p><h3 id=intermediate-representation-ir>Intermediate Representation (IR)</h3><p>The Intermediate Representation defines internal data models that external resources are translated into. This allows
Envoy Gateway to be decoupled from the external resources used for dynamic configuration. The IR consists of an Infra IR
used as input for the Infra Manager and an xDS IR used as input for the xDS Translator.</p><ul><li>Infra IR- Used as the internal definition of the managed data plane infrastructure.</li><li>xDS IR- Used as the internal definition of the managed data plane xDS configuration.</li></ul><h3 id=xds-translator>xDS Translator</h3><p>The xDS Translator translates the xDS IR into xDS Resources that are consumed by the xDS server.</p><h3 id=xds-server>xDS Server</h3><p>The xDS Server is a xDS gRPC Server based on <a href=https://github.com/envoyproxy/go-control-plane>Go Control Plane</a>. Go Control Plane implements the Delta xDS Server
Protocol and is responsible for using xDS to configure the data plane.</p><h3 id=infra-manager>Infra Manager</h3><p>The Infra Manager is a provider-specific component responsible for managing the following infrastructure:</p><ul><li>Data Plane - Manages all the infrastructure required to run the managed Envoy proxies. For example, CRUD Deployment,
Service, etc. resources to run Envoy in a Kubernetes cluster.</li><li>Auxiliary Control Planes - Optional infrastructure needed to implement application Gateway features that require
external integrations with the managed Envoy proxies. For example, <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global Rate Limiting</a> requires provisioning
and configuring the <a href=https://github.com/envoyproxy/ratelimit>Envoy Rate Limit Service</a> and the <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/http/ratelimit/v3/rate_limit.proto#envoy-v3-api-msg-extensions-filters-http-ratelimit-v3-ratelimit>Rate Limit filter</a>. Such features are exposed to
users through the <a href=https://gateway-api.sigs.k8s.io/v1alpha2/api-types/httproute/#filters-optional>Custom Route Filters</a> extension.</li></ul><p>The Infra Manager consumes the Infra IR as input to manage the data plane infrastructure.</p><h2 id=design-decisions>Design Decisions</h2><ul><li>Envoy Gateway consumes one <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#gatewayclass>GatewayClass</a> by comparing its configured controller name with
<code>spec.controllerName</code> of a GatewayClass. If multiple GatewayClasses exist with the same <code>spec.controllerName</code>, Envoy
Gateway follows Gateway API <a href=https://gateway-api.sigs.k8s.io/concepts/guidelines/#conflicts>guidelines</a> to resolve the conflict.
<code>gatewayclass.spec.parametersRef</code> refers to the <code>EnvoyProxy</code> custom resource for configuring the managed proxy
infrastructure. If unspecified, default configuration parameters are used for the managed proxy infrastructure.</li><li>Envoy Gateway manages <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#gateway>Gateways</a> that reference its GatewayClass.<ul><li>A Gateway resource causes Envoy Gateway to provision managed Envoy proxy infrastructure.</li><li>Envoy Gateway groups Listeners by Port and collapses each group of Listeners into a single Listener if the Listeners
in the group are compatible. Envoy Gateway considers Listeners to be compatible if all the following conditions are
met:<ul><li>Either each Listener within the group specifies the “HTTP” Protocol or each Listener within the group specifies
either the “HTTPS” or “TLS” Protocol.</li><li>Each Listener within the group specifies a unique &ldquo;Hostname&rdquo;.</li><li>As a special case, one Listener within a group may omit &ldquo;Hostname&rdquo;, in which case this Listener matches when no
other Listener matches.</li></ul></li><li>Envoy Gateway does <strong>not</strong> merge listeners across multiple Gateways.</li></ul></li><li>Envoy Gateway follows Gateway API <a href=https://gateway-api.sigs.k8s.io/concepts/guidelines/#conflicts>guidelines</a> to resolve any conflicts.<ul><li>A Gateway <code>listener</code> corresponds to an Envoy proxy <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listeners#config-listeners>Listener</a>.</li></ul></li><li>An <a href=https://gateway-api.sigs.k8s.io/concepts/api-overview/#httproute>HTTPRoute</a> resource corresponds to an Envoy proxy <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/route/v3/route_components.proto#envoy-v3-api-msg-config-route-v3-route>Route</a>.<ul><li>Each <a href=https://gateway-api.sigs.k8s.io/v1alpha2/api-types/httproute/#backendrefs-optional>backendRef</a> corresponds to an Envoy proxy <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#config-cluster-v3-cluster>Cluster</a>.</li></ul></li><li>The goal is to make Envoy Gateway components extensible in the future. See the <a href=roadmap.md>roadmap</a> for additional details.</li></ul><p>The draft for this document is <a href=https://docs.google.com/document/d/1riyTPPYuvNzIhBdrAX8dpfxTmcobWZDSYTTB5NeybuY/edit>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a8da31517fe722f791d672352baa0c35>2.16 - TCP and UDP Proxy Design</h1><h1 id=tcp-and-udp-proxy-design>TCP and UDP Proxy Design</h1><p>Even though most of the use cases for Envoy Gateway are at Layer-7, Envoy Gateway can also work at Layer-4 to proxy TCP
and UDP traffic. This document will explore the options we have when operating Envoy Gateway at Layer-4 and explain the
design decision.</p><p>Envoy can work as a non-transparent proxy or a transparent proxy for both <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/ip_transparency#arch-overview-ip-transparency-original-src-listener>TCP</a>
and <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/udp/udp_proxy/v3/udp_proxy.proto#envoy-v3-api-msg-extensions-filters-udp-udp-proxy-v3-udpproxyconfig>UDP</a>
, so ideally, Envoy Gateway should also be able to work in these two modes:</p><h2 id=non-transparent-proxy-mode>Non-transparent Proxy Mode</h2><p>For TCP, Envoy terminates the downstream connection, connects the upstream with its own IP address, and proxies the
TCP traffic from the downstream to the upstream.</p><p>For UDP, Envoy receives UDP datagrams from the downstream, and uses its own IP address as the sender IP address when
proxying the UDP datagrams to the upstream.</p><p>In this mode, the upstream will see Envoy&rsquo;s IP address and port.</p><h2 id=transparent-proxy-mode>Transparent Proxy Mode</h2><p>For TCP, Envoy terminates the downstream connection, connects the upstream with the downstream IP address, and proxies
the TCP traffic from the downstream to the upstream.</p><p>For UDP, Envoy receives UDP datagrams from the downstream, and uses the downstream IP address as the sender IP address
when proxying the UDP datagrams to the upstream.</p><p>In this mode, the upstream will see the original downstream IP address and Envoy&rsquo;s mac address.</p><p>Note: Even in transparent mode, the upstream can&rsquo;t see the port number of the downstream because Envoy doesn&rsquo;t forward
the port number.</p><h2 id=the-implications-of-transparent-proxy-mode>The Implications of Transparent Proxy Mode</h2><h3 id=escalated-privilege>Escalated Privilege</h3><p>Envoy needs to bind to the downstream IP when connecting to the upstream, which means Envoy requires escalated
CAP_NET_ADMIN privileges. This is often considered as a bad security practice and not allowed in some sensitive deployments.</p><h3 id=routing>Routing</h3><p>The upstream can see the original source IP, but the original port number won&rsquo;t be passed, so the return
traffic from the upstream must be routed back to Envoy because only Envoy knows how to send the return traffic back
to the right port number of the downstream, which requires routing at the upstream side to be set up.
In a Kubernetes cluster, Envoy Gateway will have to carefully cooperate with CNI plugins to get the routing right.</p><h2 id=the-design-decision-for-now>The Design Decision (For Now)</h2><p>The implementation will only support proxying in non-transparent mode i.e. the backend will see the source IP and
port of the deployed Envoy instance instead of the client.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-44c7518b753af0dc562cf1202b7ef661>2.17 - Watching Components Design</h1><h1 id=watching-components-design>Watching Components Design</h1><p>Envoy Gateway is made up of several components that communicate in-process. Some of them (namely Providers) watch
external resources, and &ldquo;publish&rdquo; what they see for other components to consume; others watch what another publishes and
act on it (such as the resource translator watches what the providers publish, and then publishes its own results that
are watched by another component). Some of these internally published results are consumed by multiple components.</p><p>To facilitate this communication use the <a href=https://pkg.go.dev/github.com/telepresenceio/watchable>watchable</a> library. The <code>watchable.Map</code> type is very similar to the
standard library&rsquo;s <code>sync.Map</code> type, but supports a <code>.Subscribe</code> (and <code>.SubscribeSubset</code>) method that promotes a pub/sub
pattern.</p><h2 id=pub>Pub</h2><p>Many of the things we communicate around are naturally named, either by a bare &ldquo;name&rdquo; string or by a &ldquo;name&rdquo;/&ldquo;namespace&rdquo;
tuple. And because <code>watchable.Map</code> is typed, it makes sense to have one map for each type of thing (very similar to if
we were using native Go <code>map</code>s). For example, a struct that might be written to by the Kubernetes provider, and read by
the IR translator:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ResourceTable</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// gateway classes are cluster-scoped; no namespace
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>GatewayClasses</span> <span style=color:#000>watchable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gwapiv1b1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GatewayClass</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// gateways are namespace-scoped, so use a k8s.io/apimachinery/pkg/types.NamespacedName as the map key.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>Gateways</span> <span style=color:#000>watchable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Map</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NamespacedName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gwapiv1b1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateway</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>HTTPRoutes</span> <span style=color:#000>watchable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Map</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>types</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NamespacedName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gwapiv1b1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoute</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The Kubernetes provider updates the table by calling <code>table.Thing.Store(name, val)</code> and <code>table.Thing.Delete(name)</code>;
updating a map key with a value that is deep-equal (usually <code>reflect.DeepEqual</code>, but you can implement your own <code>.Equal</code>
method) the current value is a no-op; it won&rsquo;t trigger an event for subscribers. This is handy so that the publisher
doesn&rsquo;t have as much state to keep track of; it doesn&rsquo;t need to know &ldquo;did I already publish this thing&rdquo;, it can just
<code>.Store</code> its data and <code>watchable</code> will do the right thing.</p><h2 id=sub>Sub</h2><p>Meanwhile, the translator and other interested components subscribe to it with <code>table.Thing.Subscribe</code> (or
<code>table.Thing.SubscribeSubset</code> if they only care about a few &ldquo;Thing"s). So the translator goroutine might look like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoutes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>fullState</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>irInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>           <span style=color:#000>GatewayClasses</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GatewayClasses</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAll</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>           <span style=color:#000>Gateways</span><span style=color:#000;font-weight:700>:</span>       <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateways</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAll</span><span style=color:#000;font-weight:700>(),</span>
</span></span><span style=display:flex><span>           <span style=color:#000>HTTPRoutes</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>snapshot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>translate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irInput</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Or, to watch multiple maps in the same loop:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>worker</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>classCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GatewayClasses</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>gwCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateways</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000>routeCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoutes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>arg</span> <span style=color:#000>irInput</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>classCh</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GatewayClasses</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>snapshot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>gwCh</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateways</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>snapshot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>snapshot</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>routeCh</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Routes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>snapshot</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GateWayClasses</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GatewayClasses</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GateWayClasses</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAll</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GateWays</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gateways</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GateWays</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAll</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoutes</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#000>arg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoutes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>k8sTable</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HTTPRoutes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAll</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>translate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>irInput</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>From the updates it gets from <code>.Subscribe</code>, it can get a full view of the map being subscribed to via <code>snapshot.State</code>;
but it must read the other maps explicitly. Like <code>sync.Map</code>, <code>watchable.Map</code>s are thread-safe; while <code>.Subscribe</code> is a
handy way to know when to run, <code>.Load</code> and friends can be used without subscribing.</p><p>There can be any number of subscribers. For that matter, there can be any number of publishers <code>.Store</code>ing things, but
it&rsquo;s probably wise to just have one publisher for each map.</p><p>The channel returned from <code>.Subscribe</code> <strong>is immediately readable</strong> with a snapshot of the map as it existed when
<code>.Subscribe</code> was called; and becomes readable again whenever <code>.Store</code> or <code>.Delete</code> mutates the map. If multiple
mutations happen between reads (or if mutations happen between <code>.Subscribe</code> and the first read), they are coalesced in
to one snapshot to be read; the <code>snapshot.State</code> is the most-recent full state, and <code>snapshot.Updates</code> is a listing of
each of the mutations that cause this snapshot to be different than the last-read one. This way subscribers don&rsquo;t need
to worry about a backlog accumulating if they can&rsquo;t keep up with the rate of changes from the publisher.</p><p>If the map contains anything before <code>.Subscribe</code> is called, that very first read won&rsquo;t include <code>snapshot.Updates</code>
entries for those pre-existing items; if you are working with <code>snapshot.Update</code> instead of <code>snapshot.State</code>, then you
must add special handling for your first read. We have a utility function <code>./internal/message.HandleSubscription</code> to
help with this.</p><h2 id=other-notes>Other Notes</h2><p>The common pattern will likely be that the entrypoint that launches the goroutines for each component instantiates the
map, and passes them to the appropriate publishers and subscribers; same as if they were communicating via a dumb
<code>chan</code>.</p><p>A limitation of <code>watchable.Map</code> is that in order to ensure safety between goroutines, it does require that value types
be deep-copiable; either by having a <code>DeepCopy</code> method, being a <code>proto.Message</code>, or by containing no reference types and
so can be deep-copied by naive assignment. Fortunately, we&rsquo;re using <code>controller-gen</code> anyway, and <code>controller-gen</code> can
generate <code>DeepCopy</code> methods for us: just stick a <code>// +k8s:deepcopy-gen=true</code> on the types that you want it to generate
methods for.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-225c7e5454818c24ae8c4072c5dbafb0>3 - Helm</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9f9033a5f543a5de0f6c038229505944>3.1 - Usage</h1><h1 id=gateway-helm>gateway-helm</h1><p><img src="https://img.shields.io/badge/Version-v0.0.0--latest-informational?style=flat-square" alt="Version: v0.0.0-latest"> <img src="https://img.shields.io/badge/Type-application-informational?style=flat-square" alt="Type: application"> <img src="https://img.shields.io/badge/AppVersion-latest-informational?style=flat-square" alt="AppVersion: latest"></p><p>The Helm chart for Envoy Gateway</p><p><strong>Homepage:</strong> <a href=https://gateway.envoyproxy.io/>https://gateway.envoyproxy.io/</a></p><h2 id=maintainers>Maintainers</h2><table><thead><tr><th>Name</th><th>Email</th><th>Url</th></tr></thead><tbody><tr><td>envoy-gateway-steering-committee</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md>https://github.com/envoyproxy/gateway/blob/main/GOVERNANCE.md</a></td></tr><tr><td>envoy-gateway-maintainers</td><td></td><td><a href=https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS>https://github.com/envoyproxy/gateway/blob/main/CODEOWNERS</a></td></tr></tbody></table><h2 id=source-code>Source Code</h2><ul><li><a href=https://github.com/envoyproxy/gateway>https://github.com/envoyproxy/gateway</a></li></ul><h2 id=values>Values</h2><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>config.envoyGateway.gateway.controllerName</td><td>string</td><td><code>"gateway.envoyproxy.io/gatewayclass-controller"</code></td><td></td></tr><tr><td>config.envoyGateway.logging.level.default</td><td>string</td><td><code>"info"</code></td><td></td></tr><tr><td>config.envoyGateway.provider.type</td><td>string</td><td><code>"Kubernetes"</code></td><td></td></tr><tr><td>createNamespace</td><td>bool</td><td><code>false</code></td><td></td></tr><tr><td>deployment.envoyGateway.image.repository</td><td>string</td><td><code>"${ImageRepository}"</code></td><td></td></tr><tr><td>deployment.envoyGateway.image.tag</td><td>string</td><td><code>"${ImageTag}"</code></td><td></td></tr><tr><td>deployment.envoyGateway.imagePullPolicy</td><td>string</td><td><code>"Always"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.limits.cpu</td><td>string</td><td><code>"500m"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.limits.memory</td><td>string</td><td><code>"1024Mi"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.requests.cpu</td><td>string</td><td><code>"100m"</code></td><td></td></tr><tr><td>deployment.envoyGateway.resources.requests.memory</td><td>string</td><td><code>"256Mi"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.image.repository</td><td>string</td><td><code>"gcr.io/kubebuilder/kube-rbac-proxy"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.image.tag</td><td>string</td><td><code>"v0.11.0"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.resources.limits.cpu</td><td>string</td><td><code>"500m"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.resources.limits.memory</td><td>string</td><td><code>"128Mi"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.resources.requests.cpu</td><td>string</td><td><code>"5m"</code></td><td></td></tr><tr><td>deployment.kubeRbacProxy.resources.requests.memory</td><td>string</td><td><code>"64Mi"</code></td><td></td></tr><tr><td>deployment.pod.annotations</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>deployment.pod.labels</td><td>object</td><td><code>{}</code></td><td></td></tr><tr><td>deployment.ports[0].name</td><td>string</td><td><code>"grpc"</code></td><td></td></tr><tr><td>deployment.ports[0].port</td><td>int</td><td><code>18000</code></td><td></td></tr><tr><td>deployment.ports[0].targetPort</td><td>int</td><td><code>18000</code></td><td></td></tr><tr><td>deployment.ports[1].name</td><td>string</td><td><code>"ratelimit"</code></td><td></td></tr><tr><td>deployment.ports[1].port</td><td>int</td><td><code>18001</code></td><td></td></tr><tr><td>deployment.ports[1].targetPort</td><td>int</td><td><code>18001</code></td><td></td></tr><tr><td>deployment.replicas</td><td>int</td><td><code>1</code></td><td></td></tr><tr><td>envoyGatewayMetricsService.ports[0].name</td><td>string</td><td><code>"https"</code></td><td></td></tr><tr><td>envoyGatewayMetricsService.ports[0].port</td><td>int</td><td><code>8443</code></td><td></td></tr><tr><td>envoyGatewayMetricsService.ports[0].protocol</td><td>string</td><td><code>"TCP"</code></td><td></td></tr><tr><td>envoyGatewayMetricsService.ports[0].targetPort</td><td>string</td><td><code>"https"</code></td><td></td></tr><tr><td>kubernetesClusterDomain</td><td>string</td><td><code>"cluster.local"</code></td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-a5f739a8bec034e3bccefb4740e1c6ec>4 - Introduction</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-71e4fa69375715cbc1aff93dc2363138>4.1 - Compatibility Matrix</h1><h1 id=compatibility-matrix>Compatibility Matrix</h1><p>Envoy Gateway relies on the Envoy Proxy and the Gateway API, and runs
within a Kubernetes cluster. Not all versions of each of these products
can function together for Envoy Gateway. Supported version combinations
are listed below; <strong>bold</strong> type indicates the versions of the Envoy Proxy
and the Gateway API actually compiled into each Envoy Gateway release.</p><p>+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| Envoy | Envoy | Rate | Gateway | Kubernetes |
| Gateway | Proxy | Limit | API | version |
| version | version | version | version | |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| v0.5.0 | <strong>v1.27 | > <strong>e | > * | v1.25, v1.26, |
| | -latest</strong> | 059638d</strong> | <em>v0.7.1</em>* | v1.27 |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| v0.4.0 | <strong>v1.26 | > <strong>5 | > * | v1.25, v1.26, |
| | -latest</strong> | 42a6047</strong> | <em>v0.6.2</em>* | v1.27 |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| v0.3.0 | <strong>v1.25 | > <strong>f | > * | v1.24, v1.25, |
| | -latest</strong> | 28024e3</strong> | <em>v0.6.1</em>* | v1.26 |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| v0.2.0 | <strong>v1.23 | | > * | v1.24 |
| | -latest</strong> | | <em>v0.5.1</em>* | |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+
| latest | <strong>dev | > * | > * | v1.26, v1.27, |
| | -latest</strong> | <em>master</em>* | <em>v0.8.0</em>* | v1.28 |
+&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;-+</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9662232d61bca04520940eafdc2967e8>5 - Releases</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-47b8476f450232d350df4857afebfdb3>5.1 - Announcing Envoy Gateway v0.5</h1><div class=lead>Envoy Gateway v0.5 release announcement.</div><h1 id=envoy-gateway-release-v05>Envoy Gateway Release v0.5</h1><p>We are pleased to announce the release of Envoy Gateway v0.5!</p><p>This is the third functional release of Envoy Gateway. We would like to thank the entire Envoy Gateway community for
helping publish the release.</p><table><thead><tr><th><a href=https://github.com/envoyproxy/gateway/blob/main/release-notes/v0.5.0.yaml>Release Notes</a></th><th><a href=https://gateway.envoyproxy.io/v0.5.0/index.html>Docs</a></th><th><a href=https://gateway.envoyproxy.io/v0.5.0/intro/compatibility.html>Compatibility Matrix</a></th><th><a href=https://github.com/envoyproxy/gateway/releases/tag/v0.5.0>Download</a></th></tr></thead></table><h2 id=whats-new>What&rsquo;s New</h2><p>The release adds a ton of features and functionality. Here are some highlights:</p><h3 id=upgrade-gateway-api-dependency>Upgrade Gateway API Dependency</h3><ul><li>Upgraded to Gateway API v0.7.1</li></ul><h3 id=add-data-plane-proxy-telemetry>Add Data Plane Proxy Telemetry</h3><ul><li>Added Support for Access Logging, Tracing and Metrics Telemetry</li></ul><h3 id=add-support-for-directly-configuring-xds>Add Support for directly configuring xDS</h3><ul><li>Added Support for the EnvoyPatchPolicy API</li></ul><h3 id=ratelimiting>Ratelimiting</h3><ul><li>Added Support for Distinct Ratelimiting Based On IP Addresses</li><li>Added upport for JWT Claim based Ratelimiting</li><li>Switched to Xds SOTW Server for RateLimit Service Configuration</li></ul><h3 id=api-updates>API Updates</h3><ul><li>Added Support for configuring EnvoyProxy Pod Labels</li><li>Added Support for configuring EnvoyProxy Deployment Strategy Settings, Volumes and Volume Mounts</li><li>Added Support for configuring EnvoyProxy as a NodePort Type Service</li><li>Added Admin Server for Envoy Gateway</li><li>Added Pprof Debug Support for Envoy Gateway</li><li>Added Support to Watch for Resources in Select Namespaces</li></ul><h2 id=envoy-proxy>Envoy Proxy</h2><ul><li>Added Best Practices Default Edge Settings to Xds Resources</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-920170f99d4cf5e216fa2b2dd7fc36d5>5.2 - Announcing Envoy Gateway v0.4</h1><div class=lead>Envoy Gateway v0.4 release announcement.</div><h1 id=envoy-gateway-release-v04>Envoy Gateway Release v0.4</h1><p>We are pleased to announce the release of Envoy Gateway v0.4!</p><p>This is the third functional release of Envoy Gateway. We would like to thank the entire Envoy Gateway community for
helping publish the release.</p><table><thead><tr><th><a href=https://github.com/envoyproxy/gateway/blob/main/release-notes/v0.4.0.yaml>Release Notes</a></th><th><a href=https://gateway.envoyproxy.io/v0.4.0/index.html>Docs</a></th><th><a href=https://gateway.envoyproxy.io/v0.4.0/intro/compatibility.html>Compatibility Matrix</a></th><th><a href=https://github.com/envoyproxy/gateway/releases/tag/v0.4.0>Download</a></th></tr></thead></table><h2 id=whats-new>What&rsquo;s New</h2><p>The release adds a ton of features and functionality. Here are some highlights:</p><h3 id=upgrade-gateway-api-dependency>Upgrade Gateway API Dependency</h3><ul><li>Upgraded to Gateway API v0.6.2</li></ul><h3 id=add-helm-support>Add Helm Support</h3><ul><li>Installation of Envoy Gateway can now be done through helm</li></ul><h3 id=add-egctl-cli-tool>Add egctl CLI Tool</h3><ul><li>Added egctl Support for Dry Runs of Gateway API Config</li><li>Added egctl Support for Dumping Envoy Proxy xDS Resources</li></ul><h3 id=add-support-for-extending-envoy-gateway>Add Support for extending Envoy Gateway</h3><ul><li>Added Initial Framework for Building an Extension on top of Envoy Gateway</li></ul><h3 id=ratelimiting>Ratelimiting</h3><ul><li>Added Support for Ratelimiting Based On IP Subnet</li></ul><h3 id=api-updates>API Updates</h3><ul><li>Added Support for Custom Envoy Proxy Bootstrap Config</li><li>Added Support for Configuring the Envoy Proxy Image and Service</li><li>Added Support for Configuring Annotations, Resources, and Securitycontext Settings on Ratelimit Infra and Envoy Proxy</li><li>Added Support for Using Multiple Certificates on a Single Fully Qualified Domain Name</li><li>Envoy Proxy Pod and Container SecurityContext is now Configurable</li><li>Added Support for Service Method Match in GRPCRoute</li><li>Added EDS Support</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1bd4ee2f2a6bd8dec27a3eba1ef3e578>5.3 - Announcing Envoy Gateway v0.3</h1><div class=lead>Envoy Gateway v0.3 release announcement.</div><h1 id=envoy-gateway-release-v03>Envoy Gateway Release v0.3</h1><p>We are pleased to announce the release of Envoy Gateway v0.3!</p><p>This is the second functional release of Envoy Gateway. We would like to thank the entire Envoy Gateway community for
helping publish the release.</p><table><thead><tr><th><a href=https://github.com/envoyproxy/gateway/blob/main/release-notes/v0.3.0.yaml>Release Notes</a></th><th><a href=https://gateway.envoyproxy.io/v0.3.0/index.html>Docs</a></th><th><a href=https://gateway.envoyproxy.io/v0.3.0/intro/compatibility.html>Compatibility Matrix</a></th><th><a href=https://github.com/envoyproxy/gateway/releases/tag/v0.3.0>Download</a></th></tr></thead></table><h2 id=whats-new>What&rsquo;s New</h2><p>The release adds a ton of features and functionality. Here are some highlights:</p><h3 id=add-support-for-extended-gateway-api-fields>Add Support for extended Gateway API fields</h3><ul><li>Added Support for HTTPRoute URLRewrite Filter</li><li>Added Support for HTTPRoute RequestMirror Filter</li><li>Added Support for HTTPRoute ResponseHeaderModifier Filter</li></ul><h3 id=add-support-for-experimental-gateway-apis>Add Support for experimental Gateway APIs</h3><ul><li>Added Support for the TCPRoute API</li><li>Added Support for the UDPRoute API</li><li>Added Support for the GRPCRoute API</li></ul><h3 id=add-support-for-rate-limiting>Add Support for Rate Limiting</h3><ul><li>Added Support for Global Rate Limiting</li></ul><h3 id=add-support-for-authentication>Add Support for Authentication</h3><ul><li>Added Support for Request Authentication</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-4ff68093439b2ea3685847ef01935e33>5.4 - Announcing Envoy Gateway v0.2</h1><div class=lead>Envoy Gateway v0.2 release announcement.</div><h1 id=envoy-gateway-release-v02>Envoy Gateway Release v0.2</h1><p>We are pleased to announce the release of Envoy Gateway v0.2!</p><p>This is the first functional release of Envoy Gateway. We would like to thank the entire Envoy Gateway community for
helping publish the release.</p><table><thead><tr><th><a href=https://github.com/envoyproxy/gateway/blob/main/release-notes/v0.2.0.yaml>Release Notes</a></th><th><a href=https://gateway.envoyproxy.io/index.html>Docs</a></th><th><a href=https://gateway.envoyproxy.io/intro/compatibility.html>Compatibility Matrix</a></th><th><a href=https://github.com/envoyproxy/gateway/releases/tag/v0.2.0>Download</a></th></tr></thead></table><h2 id=whats-new>What&rsquo;s New</h2><p>The release adds a ton of features and functionality. Here are some highlights:</p><h3 id=kubernetes-support>Kubernetes Support</h3><p>Run Envoy Gateway in a Kubernetes cluster. Checkout the <a href=https://gateway.envoyproxy.io/user/quickstart.html>quickstart guide</a> to get started with Envoy Gateway in a few
simple steps.</p><h3 id=gateway-api-support>Gateway API Support</h3><p>Envoy Gateway supports Gateway API resources for running and configuring a managed fleet of Envoy proxies. Envoy Gateway
passes Gateway API core <a href="https://gateway-api.sigs.k8s.io/concepts/conformance/?h=conformance">conformance tests</a> and supports GatewayClass, Gateway, HTTPRoute, and TLSRoute resources. See
the <a href=https://gateway.envoyproxy.io/index.html>documentation</a> for additional details on how to use Envoy Gateway for your edge proxy and API gateway needs.</p><h2 id=envoy-gateway-at-envoycon-na>Envoy Gateway at EnvoyCon NA</h2><p>Envoy Gateway will be at <a href=https://events.linuxfoundation.org/envoycon-north-america/program/schedule/>EnvoyCon NA</a> this October in Detroit. Don&rsquo;t miss <a href=https://sched.co/1AO5S>our talk</a> to learn more about the
release and future direction of the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e66247585908294b891834378ea3ac19>5.5 -</h1><h1 id=release-details>Release Details</h1><p>This document provides details for Envoy Gateway releases. Envoy Gateway follows the Semantic Versioning <a href=https://semver.org/spec/v2.0.0.html>v2.0.0 spec</a>
for release versioning. Since Envoy Gateway is a new project, minor releases are the only defined releases. Envoy
Gateway maintainers will establish additional release details, e.g. patch releases, at a future date.</p><h2 id=stable-releases>Stable Releases</h2><p>Stable releases of Envoy Gateway include:</p><ul><li>Minor Releases- A new release branch and corresponding tag are created from the <code>main</code> branch. A minor release
is supported for 6 months following the release date. As the project matures, Envoy Gateway maintainers will reassess
the support timeframe.</li></ul><p>Minor releases happen quarterly and follow the schedule below.</p><h2 id=release-management>Release Management</h2><p>Minor releases are handled by a designated Envoy Gateway maintainer. This maintainer is considered the Release Manager
for the release. The details for creating a release are outlined in the <a href=../dev/releasing.md>release guide</a>. The Release Manager is
responsible for coordinating the overall release. This includes identifying issues to be fixed in the release,
communications with the Envoy Gateway community, and the mechanics of the release.</p><table><thead><tr><th style=text-align:center>Quarter</th><th style=text-align:center>Release Manager</th></tr></thead><tbody><tr><td style=text-align:center>2022 Q4</td><td style=text-align:center>Daneyon Hansen (<a href=https://github.com/danehans>danehans</a>)</td></tr><tr><td style=text-align:center>2023 Q1</td><td style=text-align:center>Xunzhuo Liu (<a href=https://github.com/Xunzhuo>Xunzhuo</a>)</td></tr><tr><td style=text-align:center>2023 Q2</td><td style=text-align:center>Alice Wasko (<a href=https://github.com/AliceProxy>AliceProxy</a>)</td></tr><tr><td style=text-align:center>2023 Q3</td><td style=text-align:center>Arko Dasgupta (<a href=https://github.com/arkodg>arkodg</a>)</td></tr></tbody></table><h2 id=release-schedule>Release Schedule</h2><p>In order to align with the Envoy Proxy <a href=https://github.com/envoyproxy/envoy/blob/main/RELEASES.md#major-release-schedule>release schedule</a>, Envoy Gateway releases are produced on a fixed schedule
(the 22nd day of each quarter), with an acceptable delay of up to 2 weeks, and a hard deadline of 3 weeks.</p><table><thead><tr><th style=text-align:center>Version</th><th style=text-align:center>Expected</th><th style=text-align:center>Actual</th><th style=text-align:center>Difference</th><th style=text-align:center>End of Life</th></tr></thead><tbody><tr><td style=text-align:center>0.2.0</td><td style=text-align:center>2022/10/22</td><td style=text-align:center>2022/10/20</td><td style=text-align:center>-2 day</td><td style=text-align:center>2023/4/20</td></tr><tr><td style=text-align:center>0.3.0</td><td style=text-align:center>2023/01/22</td><td style=text-align:center>2023/02/09</td><td style=text-align:center>+17 day</td><td style=text-align:center>2023/08/09</td></tr><tr><td style=text-align:center>0.4.0</td><td style=text-align:center>2023/04/22</td><td style=text-align:center>2023/04/24</td><td style=text-align:center>+2 day</td><td style=text-align:center>2023/10/24</td></tr><tr><td style=text-align:center>0.5.0</td><td style=text-align:center>2023/07/22</td><td style=text-align:center>2023/08/02</td><td style=text-align:center>+10 day</td><td style=text-align:center>2024/01/02</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-60b58cae199073ee637865a9f60710e7>6 - User Guide</h1><div class="pageinfo pageinfo-primary"><p>This is a placeholder page that shows you how to use this template site.</p></div><p>This section is where the user documentation for your project lives - all the
information your users need to understand and successfully use your project.</p><p>For large documentation sets we recommend adding content under the headings in
this section, though if some or all of them don’t apply to your project feel
free to remove them or add your own. You can see an example of a smaller Docsy
documentation site in the <a href=https://docsy.dev/docs/>Docsy User Guide</a>, which
lives in the <a href=https://github.com/google/docsy/tree/master/userguide>Docsy theme
repo</a> if you&rsquo;d like to
copy its docs section.</p><p>Other content such as marketing material, case studies, and community updates
should live in the <a href=/about/>About</a> and <a href=/community/>Community</a> pages.</p><p>Find out how to use the Docsy theme in the <a href=https://docsy.dev/docs/>Docsy User
Guide</a>. You can learn more about how to organize your
documentation (and how we organized this site) in <a href=https://docsy.dev/docs/best-practices/organizing-content/>Organizing Your
Content</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d5bd454b857d88557b13a286e9242378>6.1 -</h1><h1 id=request-authentication>Request Authentication</h1><p>This guide provides instructions for configuring <a href=https://tools.ietf.org/html/rfc7519>JSON Web Token (JWT)</a> authentication. JWT authentication checks
if an incoming request has a valid JWT before routing the request to a backend service. Currently, Envoy Gateway only
supports validating a JWT from an HTTP header, e.g. <code>Authorization: Bearer &lt;token></code>.</p><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart</a> guide to install Envoy Gateway and the example manifest.
For GRPC - follow the steps from the <a href=grpc-routing.md>GRPC Routing</a> example.
Before proceeding, you should be able to query the example backend using HTTP or GRPC.</p><h2 id=configuration>Configuration</h2><p>Allow requests with a valid JWT by creating an <a href=https://gateway.envoyproxy.io/latest/api/extension_types.html#authenticationfilter>AuthenticationFilter</a> and referencing it from the example HTTPRoute or GRPCRoute.</p><h3 id=httproute>HTTPRoute</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/authn/jwt.yaml
</span></span></code></pre></div><p>The HTTPRoute is now updated to authenticate requests for <code>/foo</code> and allow unauthenticated requests to <code>/bar</code>. The
<code>/foo</code> route rule references an AuthenticationFilter that provides the JWT authentication configuration.</p><p>Verify the HTTPRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/backend -o yaml
</span></span></code></pre></div><p>The AuthenticationFilter is configured for JWT authentication and uses a single <a href=https://tools.ietf.org/html/rfc7517>JSON Web Key Set (JWKS)</a>
provider for authenticating the JWT.</p><p>Verify the AuthenticationFilter configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get authenticationfilter/jwt-example -o yaml
</span></span></code></pre></div><h3 id=grpcroute>GRPCRoute</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/authn/grtpc-jwt.yaml
</span></span></code></pre></div><p>The GRPCRoute is now updated to authenticate all requests to <code>yages</code> service, by referencing an AuthenticationFilter that provides the JWT authentication configuration.</p><p>Verify the GRPCRoute configuration and status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroute/yages -o yaml
</span></span></code></pre></div><p>The AuthenticationFilter is configured for JWT authentication and uses a single <a href=https://tools.ietf.org/html/rfc7517>JSON Web Key Set (JWKS)</a>
provider for authenticating the JWT.</p><p>Verify the AuthenticationFilter configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get authenticationfilter/jwt-example -o yaml
</span></span></code></pre></div><h2 id=testing>Testing</h2><p>Ensure the <code>GATEWAY_HOST</code> environment variable from the <a href=quickstart.md>Quickstart</a> guide is set. If not, follow the
Quickstart instructions to set the variable.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$GATEWAY_HOST</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute</h3><p>Verify that requests to <code>/foo</code> are denied without a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/foo
</span></span></code></pre></div><p>A <code>401</code> HTTP response code should be returned.</p><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode -
</span></span></code></pre></div><p><strong>Note:</strong> The above command decodes and returns the token&rsquo;s payload. You can replace <code>f2</code> with <code>f1</code> to view the token&rsquo;s
header.</p><p>Verify that a request to <code>/foo</code> with a valid JWT is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -H <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/foo
</span></span></code></pre></div><p>A <code>200</code> HTTP response code should be returned.</p><p>Verify that requests to <code>/bar</code> are allowed <strong>without</strong> a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -sS -o /dev/null -H <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> -w <span style=color:#4e9a06>&#34;%{http_code}\n&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/bar
</span></span></code></pre></div><h3 id=grpcroute-1>GRPCRoute</h3><p>Verify that requests to <code>yages</code>service are denied without a JWT:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Error invoking method <span style=color:#4e9a06>&#34;yages.Echo/Ping&#34;</span>: rpc error: <span style=color:#000>code</span> <span style=color:#ce5c00;font-weight:700>=</span> Unauthenticated <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> failed to query <span style=color:#204a87;font-weight:700>for</span> service descriptor <span style=color:#4e9a06>&#34;yages.Echo&#34;</span>: Jwt is missing
</span></span></code></pre></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode -
</span></span></code></pre></div><p><strong>Note:</strong> The above command decodes and returns the token&rsquo;s payload. You can replace <code>f2</code> with <code>f1</code> to view the token&rsquo;s
header.</p><p>Verify that a request to <code>yages</code> service with a valid JWT is allowed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -H <span style=color:#4e9a06>&#34;authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;text&#34;</span>: <span style=color:#4e9a06>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart</a> guide to uninstall Envoy Gateway and the example manifest.</p><p>Delete the AuthenticationFilter:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete authenticationfilter/jwt-example
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><p>Checkout the <a href=../dev/README.md>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e70a3fedc0fcaab8dfcf1abca0043f73>6.2 -</h1><h1 id=customize-envoyproxy>Customize EnvoyProxy</h1><p>Envoy Gateway provides an <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoyproxy>EnvoyProxy</a> CRD that can be linked to the ParametersRef
in GatewayClass, allowing cluster admins to customize the managed EnvoyProxy Deployment and
Service. To learn more about GatewayClass and ParametersRef, please refer to <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=add-gatewayclass-parametersref>Add GatewayClass ParametersRef</h2><p>First, you need to add ParametersRef in GatewayClass, and refer to EnvoyProxy Config:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parametersRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: config.gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=customize-envoyproxy-deployment-replicas>Customize EnvoyProxy Deployment Replicas</h2><p>You can customize the EnvoyProxy Deployment Replicas via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        replicas: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After you apply the config, you should see the replicas of envoyproxy changes to 2.
And also you can dynamically change the value.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get deployment envoy-gateway
</span></span></code></pre></div><h2 id=customize-envoyproxy-image>Customize EnvoyProxy Image</h2><p>You can customize the EnvoyProxy Image via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          image: envoyproxy/envoy:v1.25-latest
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After applying the config, you can get the deployment image, and see it has changed.</p><h2 id=customize-envoyproxy-pod-annotations>Customize EnvoyProxy Pod Annotations</h2><p>You can customize the EnvoyProxy Pod Annotations via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            custom1: deploy-annotation1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            custom2: deploy-annotation2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After applying the config, you can get the envoyproxy pods, and see new annotations has been added.</p><h2 id=customize-envoyproxy-deployment-resources>Customize EnvoyProxy Deployment Resources</h2><p>You can customize the EnvoyProxy Deployment Resources via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 150m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 640Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cpu: 500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              memory: 1Gi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=customize-envoyproxy-deployment-env>Customize EnvoyProxy Deployment Env</h2><p>You can customize the EnvoyProxy Deployment Env via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: env_a
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: env_a_value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: env_b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: env_b_value
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><blockquote><p>Envoy Gateway has provided two initial <code>env</code> <code>ENVOY_GATEWAY_NAMESPACE</code> and <code>ENVOY_POD_NAME</code> for envoyproxy container.</p></blockquote><p>After applying the config, you can get the envoyproxy deployment, and see resources has been changed.</p><h2 id=customize-envoyproxy-deployment-volumes-or-volumemounts>Customize EnvoyProxy Deployment Volumes or VolumeMounts</h2><p>You can customize the EnvoyProxy Deployment Volumes or VolumeMounts via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          volumeMounts:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - mountPath: /certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            readOnly: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          volumes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - name: certs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            secret:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              secretName: envoy-cert   
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After applying the config, you can get the envoyproxy deployment, and see resources has been changed.</p><h2 id=customize-envoyproxy-service-annotations>Customize EnvoyProxy Service Annotations</h2><p>You can customize the EnvoyProxy Service Annotations via EnvoyProxy Config like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      envoyService:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          custom1: svc-annotation1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          custom2: svc-annotation2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>After applying the config, you can get the envoyproxy service, and see annotations has been added.</p><h2 id=customize-envoyproxy-bootstrap-config>Customize EnvoyProxy Bootstrap Config</h2><p>You can customize the EnvoyProxy bootstrap config via EnvoyProxy Config.
There are two ways to customize it:</p><ul><li>Replace: the whole bootstrap config will be replaced by the config you provided.</li><li>Merge: the config you provided will be merged into the default bootstrap config.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyProxy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-proxy-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  bootstrap:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    type: Replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    bootstrap: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      admin:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        access_log:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: envoy.access_loggers.file
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            path: /dev/null
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          socket_address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            port_value: 20000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      dynamic_resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        ads_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          api_type: DELTA_GRPC
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          transport_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          grpc_services:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - envoy_grpc:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          set_node_on_first_message_only: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        lds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        cds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      static_resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        clusters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - connect_timeout: 10s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          load_assignment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - lb_endpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              - endpoint:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    socket_address:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      address: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      port_value: 18000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          typed_extension_protocol_options:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>               &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>               &#34;explicit_http_config&#34;:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                 &#34;http2_protocol_options&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: STRICT_DNS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          transport_socket:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: envoy.transport_sockets.tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            typed_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              common_tls_context:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                tls_params:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  tls_maximum_protocol_version: TLSv1_3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                tls_certificate_sds_secret_configs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                - name: xds_certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      path: &#34;/sds/xds-certificate.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                validation_context_sds_secret_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  name: xds_trusted_ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                      path: &#34;/sds/xds-trusted-ca.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      layered_runtime:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        layers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          rtds_layer:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            rtds_config:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              ads: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>You can use <a href=https://gateway.envoyproxy.io/latest/user/egctl.html#validating-gateway-api-configuration>egctl translate</a>
to get the default xDS Bootstrap configuration used by Envoy Gateway.</p><p>After applying the config, the bootstrap config will be overridden by the new config you provided.
Any errors in the configuration will be surfaced as status within the <code>GatewayClass</code> resource.
You can also validate this configuration using <a href=https://gateway.envoyproxy.io/latest/user/egctl.html#validating-gateway-api-configuration>egctl translate</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f44b560399133c52b7c07d0a48eb00f0>6.3 -</h1><h2 id=deployment-mode>Deployment Mode</h2><h3 id=one-gatewayclass-per-envoy-gateway>One GatewayClass per Envoy Gateway</h3><ul><li>Envoy Gateway can accept a single <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>
resource. If you&rsquo;ve instantiated multiple GatewayClasses, we recommend running multiple Envoy Gateway controllers
in different namespaces, linking a GatewayClass to each of them.</li><li>Support for accepting multiple GatewayClass is being tracked <a href=https://github.com/envoyproxy/gateway/issues/1231>here</a>.</li></ul><h3 id=supported-modes>Supported Modes</h3><h4 id=kubernetes>Kubernetes</h4><ul><li>The default deployment model is - Envoy Gateway <strong>watches</strong> for resources such a <code>Service</code> & <code>HTTPRoute</code> in <strong>all</strong> namespaces
and <strong>creates</strong> managed data plane resources such as EnvoyProxy <code>Deployment</code> in the <strong>namespace where Envoy Gateway is running</strong>.</li><li>Envoy Gateway also supports <strong>Namespaced</strong> deployment mode, you can watch resources in the specific namespaces by assigning
<code>EnvoyGateway.provider.kubernetes.watch.namespaces</code> and <strong>creates</strong> managed data plane resources in the <strong>namespace where Envoy Gateway is running</strong>.</li><li>Support for alternate deployment modes is being tracked <a href=https://github.com/envoyproxy/gateway/issues/1117>here</a>.</li></ul><h3 id=multi-tenancy>Multi-tenancy</h3><h4 id=kubernetes-1>Kubernetes</h4><ul><li><p>A <code>tenant</code> is a group within an organization (e.g. a team or department) who shares organizational resources. We recommend
each <code>tenant</code> deploy their own Envoy Gateway controller in their respective <code>namespace</code>. Below is an example of deploying Envoy Gateway
by the <code>marketing</code> and <code>product</code> teams in separate namespaces.</p></li><li><p>Lets deploy Envoy Gateway in the <code>marketing</code> namespace and also watch resources only in this namespace. We are also setting the controller name to a unique string here <code>gateway.envoyproxy.io/marketing-gatewayclass-controller</code>.</p></li></ul><pre tabindex=0><code>helm install --set config.envoyGateway.gateway.controllerName=gateway.envoyproxy.io/marketing-gatewayclass-controller --set config.envoyGateway.provider.kubernetes.watch.namespaces={marketing} eg-marketing oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n marketing --create-namespace
</code></pre><p>Lets create a <code>GatewayClass</code> linked to the marketing team&rsquo;s Envoy Gateway controller, and as well other resources linked to it, so the <code>backend</code> application operated by this team can be exposed to external clients.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/marketing-gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg-marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: marketing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.marketing.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Lets port forward to the generated envoy proxy service in the <code>marketing</code> namespace and send a request to it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n marketing --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>marketing,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl -n marketing port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:8080 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.marketing.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div><pre tabindex=0><code>*   Trying 127.0.0.1:8888...
* Connected to localhost (127.0.0.1) port 8888 (#0)
&gt; GET /get HTTP/1.1
&gt; Host: www.marketing.example.com
&gt; User-Agent: curl/7.86.0
&gt; Accept: */*
&gt;
Handling connection for 8888
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; content-type: application/json
&lt; x-content-type-options: nosniff
&lt; date: Thu, 20 Apr 2023 19:19:42 GMT
&lt; content-length: 521
&lt; x-envoy-upstream-service-time: 0
&lt; server: envoy
&lt;
{
 &#34;path&#34;: &#34;/get&#34;,
 &#34;host&#34;: &#34;www.marketing.example.com&#34;,
 &#34;method&#34;: &#34;GET&#34;,
 &#34;proto&#34;: &#34;HTTP/1.1&#34;,
 &#34;headers&#34;: {
  &#34;Accept&#34;: [
   &#34;*/*&#34;
  ],
  &#34;User-Agent&#34;: [
   &#34;curl/7.86.0&#34;
  ],
  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
   &#34;15000&#34;
  ],
  &#34;X-Envoy-Internal&#34;: [
   &#34;true&#34;
  ],
  &#34;X-Forwarded-For&#34;: [
   &#34;10.1.0.157&#34;
  ],
  &#34;X-Forwarded-Proto&#34;: [
   &#34;http&#34;
  ],
  &#34;X-Request-Id&#34;: [
   &#34;c637977c-458a-48ae-92b3-f8c429849322&#34;
  ]
 },
 &#34;namespace&#34;: &#34;marketing&#34;,
 &#34;ingress&#34;: &#34;&#34;,
 &#34;service&#34;: &#34;&#34;,
 &#34;pod&#34;: &#34;backend-74888f465f-bcs8f&#34;
* Connection #0 to host localhost left intact
</code></pre><ul><li>Lets deploy Envoy Gateway in the <code>product</code> namespace and also watch resources only in this namespace.</li></ul><pre tabindex=0><code>helm install --set config.envoyGateway.gateway.controllerName=gateway.envoyproxy.io/product-gatewayclass-controller --set config.envoyGateway.provider.kubernetes.watch.namespaces={product} eg-product oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n product --create-namespace
</code></pre><p>Lets create a <code>GatewayClass</code> linked to the product team&rsquo;s Envoy Gateway controller, and as well other resources linked to it, so the <code>backend</code> application operated by this team can be exposed to external clients.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg-product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/product-gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg-product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8080
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: product
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.product.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Lets port forward to the generated envoy proxy service in the <code>product</code> namespace and send a request to it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n product --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>product,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl -n product port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8889:8080 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.product.example.com&#34;</span> http://localhost:8889/get
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>*   Trying 127.0.0.1:8889...
</span></span><span style=display:flex><span>* Connected to localhost <span style=color:#ce5c00;font-weight:700>(</span>127.0.0.1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8889</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>&gt; GET /get HTTP/1.1
</span></span><span style=display:flex><span>&gt; Host: www.product.example.com
</span></span><span style=display:flex><span>&gt; User-Agent: curl/7.86.0
</span></span><span style=display:flex><span>&gt; Accept: */*
</span></span><span style=display:flex><span>&gt; 
</span></span><span style=display:flex><span>Handling connection <span style=color:#204a87;font-weight:700>for</span> <span style=color:#0000cf;font-weight:700>8889</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>&lt; content-type: application/json
</span></span><span style=display:flex><span>&lt; x-content-type-options: nosniff
</span></span><span style=display:flex><span>&lt; date: Thu, <span style=color:#0000cf;font-weight:700>20</span> Apr <span style=color:#0000cf;font-weight:700>2023</span> 19:20:17 GMT
</span></span><span style=display:flex><span>&lt; content-length: <span style=color:#0000cf;font-weight:700>517</span>
</span></span><span style=display:flex><span>&lt; x-envoy-upstream-service-time: <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>&lt; server: envoy
</span></span><span style=display:flex><span>&lt; 
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/get&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;www.product.example.com&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.86.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;15000&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Envoy-Internal&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-For&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;10.1.0.156&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Forwarded-Proto&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;http&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;X-Request-Id&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;39196453-2250-4331-b756-54003b2853c2&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;product&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-74888f465f-64fjs&#34;</span>
</span></span><span style=display:flex><span>* Connection <span style=color:#8f5902;font-style:italic>#0 to host localhost left intact</span>
</span></span></code></pre></div><p>With the below command you can ensure that you are no able to access the marketing team&rsquo;s backend exposed using the <code>www.marketing.example.com</code> hostname
and the product team&rsquo;s data plane.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.marketing.example.com&#34;</span> http://localhost:8889/get
</span></span></code></pre></div><pre tabindex=0><code>*   Trying 127.0.0.1:8889...
* Connected to localhost (127.0.0.1) port 8889 (#0)
&gt; GET /get HTTP/1.1
&gt; Host: www.marketing.example.com
&gt; User-Agent: curl/7.86.0
&gt; Accept: */*
&gt;
Handling connection for 8889
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 404 Not Found
&lt; date: Thu, 20 Apr 2023 19:22:13 GMT
&lt; server: envoy
&lt; content-length: 0
&lt;
* Connection #0 to host localhost left intact
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-cf30c4df7d9e1861913182fa02c656f6>6.4 -</h1><h1 id=egctl>egctl</h1><p><code>egctl</code> is a command line tool to provide additional functionality for Envoy Gateway users.</p><h2 id=installing-egctl>Installing egctl</h2><p>This guide shows how to install the egctl CLI. egctl can be installed either from source, or from pre-built binary releases.</p><h3 id=from-the-envoy-gateway-project>From The Envoy Gateway Project</h3><p>The Envoy Gateway project provides two ways to fetch and install egctl. These are the official methods to get egctl releases. Installation through those methods can be found below the official methods.</p><h3 id=from-the-binary-releases>From the Binary Releases</h3><p>Every <a href=https://github.com/envoyproxy/gateway/releases>release</a> of egctl provides binary releases for a variety of OSes. These binary versions can be manually downloaded and installed.</p><ol><li>Download your <a href=https://github.com/envoyproxy/gateway/releases>desired version</a></li><li>Unpack it (tar -zxvf egctl_latest_linux_amd64.tar.gz)</li><li>Find the egctl binary in the unpacked directory, and move it to its desired destination (mv bin/linux/amd64/egctl /usr/local/bin/egctl)</li></ol><p>From there, you should be able to run: <code>egctl help</code>.</p><h3 id=from-script>From Script</h3><p><code>egctl</code> now has an installer script that will automatically grab the latest release version of egctl and install it locally.</p><p>You can fetch that script, and then execute it locally. It&rsquo;s well documented so that you can read through it and understand what it is doing before you run it.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -fsSL -o get-egctl.sh https://gateway.envoyproxy.io/get-egctl.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>chmod +x get-egctl.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># get help info of the </span>
</span></span><span style=display:flex><span>bash get-egctl.sh --help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># install the latest development version of egctl</span>
</span></span><span style=display:flex><span>bash <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>latest get-egctl.sh
</span></span></code></pre></div><p>Yes, you can just use the below command if you want to live on the edge.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl https://gateway.envoyproxy.io/get-egctl.sh <span style=color:#000;font-weight:700>|</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>latest bash 
</span></span></code></pre></div><h2 id=egctl-experimental-translate>egctl experimental translate</h2><p>This subcommand allows users to translate from an input configuration type to an output configuration type.</p><p>In the below example, we will translate the Kubernetes resources (including the Gateway API resources) into xDS
resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --to xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clusterIP: &#34;1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: ClusterIP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>configKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.BootstrapConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>19000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>dynamicResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>cdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ldsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>layeredRuntime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>layers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>rtdsLayer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>rtdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>staticResources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>connectTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>loadAssignment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>lbEndpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>transportSocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.transport_sockets.tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>commonTlsContext</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>tlsCertificateSdsSecretConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_certificate</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>pathConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/sds/xds-certificate.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>tlsParams</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>tlsMaximumProtocolVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLSv1_3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>validationContextSdsSecretConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_trusted_ca</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>sdsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>pathConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/sds/xds-trusted-ca.json</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STRICT_DNS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>typedExtensionProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>explicitHttpConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>http2ProtocolOptions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.ClustersConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicActiveClusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.cluster.v3.Cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>commonLbConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>localityWeightedLbConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>connectTimeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10s</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>dnsLookupFamily</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V4_ONLY</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>loadAssignment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>lbEndpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1.1.1.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>loadBalancingWeight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>loadBalancingWeight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>locality</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>outlierDetection</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>STATIC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.ListenersConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicListeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>activeState</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>listener</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.listener.v3.Listener</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>filter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>responseFlagFilter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>flags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#000>NR</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>socketAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.0.0.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>portValue</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10080</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>defaultFilterChain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>filters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.network.http_connection_manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>accessLog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.access_loggers.file</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/stdout</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>httpFilters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy.filters.http.router</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>typedConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>rds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>configSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>apiConfigSource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>apiType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DELTA_GRPC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>grpcServices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span>- <span style=color:#204a87;font-weight:700>envoyGrpc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                        </span><span style=color:#204a87;font-weight:700>clusterName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xds_cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>setNodeOnFirstMessageOnly</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>transportApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                  </span><span style=color:#204a87;font-weight:700>resourceApiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>V3</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>routeConfigName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>statPrefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>upgradeConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span>- <span style=color:#204a87;font-weight:700>upgradeType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>websocket</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>useRemoteAddress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dynamicRouteConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>routeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>virtualHosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>routes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>resourceType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>all</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You can also use the <code>--type</code>/<code>-t</code> flag to retrieve specific output types. In the below example, we will translate the Kubernetes resources (including the Gateway API resources) into xDS <code>route</code> resources.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --to xds -t route -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: default 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clusterIP: &#34;1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: ClusterIP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>configKey</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>dynamicRouteConfigs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>routeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.config.route.v3.RouteConfiguration</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>virtualHosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-eg-http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>routes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>match</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>route</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-backend-rule-0-match-0-www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>resourceType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=add-missing-resources>Add Missing Resources</h3><p>You can pass the <code>--add-missing-resources</code> flag to use dummy non Gateway API resources instead of specifying them explicitly.</p><p>For example, this will provide the similar result as the above:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --add-missing-resources --from gateway-api --to gateway-api -t route -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;www.example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>You can see the output contains a <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoyproxy>EnvoyProxy</a> resource that
can be used as a starting point to modify the xDS bootstrap resource for the managed Envoy Proxy fleet.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>envoyProxy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-envoy-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>bootstrap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      admin:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        access_log:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: envoy.access_loggers.file
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            path: /dev/null
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            address: 127.0.0.1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            port_value: 19000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      dynamic_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        ads_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          api_type: DELTA_GRPC
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          grpc_services:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          - envoy_grpc:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          set_node_on_first_message_only: true
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        lds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        cds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      static_resources:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        clusters:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - connect_timeout: 10s
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          load_assignment:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            cluster_name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            - lb_endpoints:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              - endpoint:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    socket_address:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      address: envoy-gateway
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      port_value: 18000
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          typed_extension_protocol_options:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            &#34;envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;@type&#34;: &#34;type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>               &#34;explicit_http_config&#34;:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                 &#34;http2_protocol_options&#34;: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          name: xds_cluster
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          type: STRICT_DNS
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          transport_socket:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: envoy.transport_sockets.tls
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            typed_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              common_tls_context:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_params:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  tls_maximum_protocol_version: TLSv1_3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                tls_certificate_sds_secret_configs:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                - name: xds_certificate
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-certificate.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                validation_context_sds_secret_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  name: xds_trusted_ca
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                  sds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    path_config_source:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                      path: &#34;/sds/xds-trusted-ca.json&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>                    resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      layered_runtime:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        layers:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        - name: runtime-0
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          rtds_layer:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            rtds_config:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              ads: {}
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>              resource_api_version: V3
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            name: runtime-0</span><span style=color:#f8f8f8;text-decoration:underline>      
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gatewayClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parametersRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>config.gateway.envoyproxy.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnvoyProxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default-envoy-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Valid GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateways</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>attachedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Sending translated listener configuration to the data plane</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Listener has been successfully translated</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>supportedKinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>HTTPRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GRPCRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>httpRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hostnames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>www.example.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parents</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Route is accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:30:46Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resolved all the Object references for the Route</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>parentRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Sometimes you might find that egctl doesn&rsquo;t provide an expected result. For example, the following example provides an empty route resource:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --type route --to xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>xds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway-system-eg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=validating-gateway-api-configuration>Validating Gateway API Configuration</h3><p>You can add an additional target <code>gateway-api</code> to show the processed Gateway API resources. For example, translating the above resources with the new argument shows that the HTTPRoute is rejected because there is no ready listener for it:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | egctl x translate --from gateway-api --type route --to gateway-api,xds -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      protocol: TLS
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 8443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>gatewayClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Valid GatewayClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;True&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>gateways</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>gatewayClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8443</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>attachedRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Listener must have TLS set when protocol is TLS.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Invalid</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Programmed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>supportedKinds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.networking.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TLSRoute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>httpRoutes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>creationTimestamp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>envoy-gateway-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>backendRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>backend</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>matches</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PathPrefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>parents</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>conditions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>There are no ready listeners for this parent ref</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NoReadyListeners</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Accepted</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>lastTransitionTime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-04-19T20:54:52Z&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Service envoy-gateway-system/backend not found</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>reason</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BackendNotFound</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;False&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ResolvedRefs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>controllerName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>gateway.envoyproxy.io/gatewayclass-controller</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>parentRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>eg</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>xds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoy-gateway-system-eg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#39;@type&#39;</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>type.googleapis.com/envoy.admin.v3.RoutesConfigDump</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-79fbf0081ff9c3448d19524f90b4aa41>6.5 -</h1><h1 id=envoy-patch-policy>Envoy Patch Policy</h1><p>This guide explains the usage of the <a href=https://gateway.envoyproxy.io/latest/api/extension_types.html#envoypatchpolicy>EnvoyPatchPolicy</a> API.
<strong>Note:</strong> This API is meant for users extremely familiar with Envoy <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration>xDS</a> semantics.
Also before considering this API for production use cases, please be aware that this API
is unstable and the outcome may change across versions. Use at your own risk.</p><h2 id=introduction>Introduction</h2><p>The <a href=https://gateway.envoyproxy.io/latest/api/extension_types.html#envoypatchpolicy>EnvoyPatchPolicy</a> API allows user to modify the output <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/operations/dynamic_configuration>xDS</a>
configuration generated by Envoy Gateway intended for EnvoyProxy,
using <a href=https://datatracker.ietf.org/doc/html/rfc6902>JSON Patch</a> semantics.</p><h2 id=motivation>Motivation</h2><p>This API was introduced to allow advanced users to be able to leverage Envoy Proxy functionality
not exposed by Envoy Gateway APIs today.</p><h2 id=quickstart>Quickstart</h2><h3 id=prerequistes>Prerequistes</h3><ul><li>Follow the steps from the <a href=quickstart.md>Quickstart</a> guide to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</li></ul><h3 id=enable-envoypatchpolicy>Enable EnvoyPatchPolicy</h3><ul><li><p>By default EnvoyPatchPolicy][] is disabled. Lets enable it in the <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoygateway>EnvoyGateway</a> startup configuration</p></li><li><p>The default installation of Envoy Gateway installs a default <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable EnvoyPatchPolicy.</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    extensionApis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      enableEnvoyPatchPolicy: true
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>After updating the <code>ConfigMap</code>, you will need to restart the <code>envoy-gateway</code> deployment so the configuration kicks in</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div><h2 id=testing>Testing</h2><h3 id=customize-response>Customize Response</h3><ul><li><p>Lets use EnvoyProxy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/local_reply>Local Reply Modification</a> feature to return a custom response back to the client when
the status code is <code>404</code></p></li><li><p>Lets apply the configuration</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: EnvoyPatchPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: custom-response-patch-policy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  targetRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JSONPatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jsonPatches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: &#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      # The listener name is of the form &lt;GatewayNamespace&gt;/&lt;GatewayName&gt;/&lt;GatewayListenerName&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: default/eg/http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      operation:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        op: add
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        path: &#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          mappers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          - filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              status_code_filter:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                comparison:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                 op: EQ
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                 value:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                   default_value: 404
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                   runtime_key: key_b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            status_code: 406
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            body:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              inline_string: &#34;could not find what you are looking for&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>Lets edit the HTTPRoute resource from the Quickstart to only match on paths with value <code>/get</code></li></ul><pre tabindex=0><code>kubectl patch httproute backend --type=json --patch &#39;[{
   &#34;op&#34;: &#34;add&#34;,
   &#34;path&#34;: &#34;/spec/rules/0/matches/0/path/value&#34;,
   &#34;value&#34;: &#34;/get&#34;,
}]&#39;
</code></pre><ul><li>Lets test it out by specifying a path apart from <code>/get</code></li></ul><pre tabindex=0><code>$ curl --header &#34;Host: www.example.com&#34; http://localhost:8888/find
Handling connection for 8888
could not find what you are looking for
</code></pre><h2 id=debugging>Debugging</h2><h3 id=runtime>Runtime</h3><ul><li>The <code>Status</code> subresource should have information about the status of the resource. Make sure
<code>Accepted=True</code> and <code>Programmed=True</code> conditions are set to ensure that the policy has been
applied to Envoy Proxy.</li></ul><pre tabindex=0><code>apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {&#34;apiVersion&#34;:&#34;gateway.envoyproxy.io/v1alpha1&#34;,&#34;kind&#34;:&#34;EnvoyPatchPolicy&#34;,&#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;custom-response-patch-policy&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;spec&#34;:{&#34;jsonPatches&#34;:[{&#34;name&#34;:&#34;default/eg/http&#34;,&#34;operation&#34;:{&#34;op&#34;:&#34;add&#34;,&#34;path&#34;:&#34;/default_filter_chain/filters/0/typed_config/local_reply_config&#34;,&#34;value&#34;:{&#34;mappers&#34;:[{&#34;body&#34;:{&#34;inline_string&#34;:&#34;could not find what you are looking for&#34;},&#34;filter&#34;:{&#34;status_code_filter&#34;:{&#34;comparison&#34;:{&#34;op&#34;:&#34;EQ&#34;,&#34;value&#34;:{&#34;default_value&#34;:404}}}}}]}},&#34;type&#34;:&#34;type.googleapis.com/envoy.config.listener.v3.Listener&#34;}],&#34;priority&#34;:0,&#34;targetRef&#34;:{&#34;group&#34;:&#34;gateway.networking.k8s.io&#34;,&#34;kind&#34;:&#34;Gateway&#34;,&#34;name&#34;:&#34;eg&#34;,&#34;namespace&#34;:&#34;default&#34;},&#34;type&#34;:&#34;JSONPatch&#34;}}
  creationTimestamp: &#34;2023-07-31T21:47:53Z&#34;
  generation: 1
  name: custom-response-patch-policy
  namespace: default
  resourceVersion: &#34;10265&#34;
  uid: a35bda6e-a0cc-46d7-a63a-cee765174bc3
spec:
  jsonPatches:
  - name: default/eg/http
    operation:
      op: add
      path: /default_filter_chain/filters/0/typed_config/local_reply_config
      value:
        mappers:
        - body:
            inline_string: could not find what you are looking for
          filter:
            status_code_filter:
              comparison:
                op: EQ
                value:
                  default_value: 404
    type: type.googleapis.com/envoy.config.listener.v3.Listener
  priority: 0
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: eg
    namespace: default
  type: JSONPatch
status:
  conditions:
  - lastTransitionTime: &#34;2023-07-31T21:48:19Z&#34;
    message: EnvoyPatchPolicy has been accepted.
    observedGeneration: 1
    reason: Accepted
    status: &#34;True&#34;
    type: Accepted
  - lastTransitionTime: &#34;2023-07-31T21:48:19Z&#34;
    message: successfully applied patches.
    reason: Programmed
    status: &#34;True&#34;
    type: Programmed
</code></pre><h3 id=offline>Offline</h3><ul><li>You can use <a href=https://gateway.envoyproxy.io/latest/user/egctl.html#egctl-experimental-translate>egctl x translate</a> to validate the translated xds output.</li></ul><h2 id=caveats>Caveats</h2><p>This API will always be an unstable API and the same outcome cannot be garunteed
across versions for these reasons</p><ul><li>The Envoy Proxy API might deprecate and remove API fields</li><li>Envoy Gateway might alter the xDS translation creating a different xDS output
such as changing the <code>name</code> field of resources.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f991774fb350e8e0ee3aa2f63e9365d3>6.6 -</h1><h1 id=gateway-address>Gateway Address</h1><p>The Gateway API provides an optional <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.GatewayAddress>Addresses</a> field through which Envoy Gateway can set addresses for Envoy Proxy Service. The currently supported addresses are:</p><ul><li><a href=#External-IPs>External IPs</a></li></ul><h2 id=installation>Installation</h2><p>Install Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><h2 id=external-ips>External IPs</h2><p>Using the addresses in <code>Gateway.Spec.Addresses</code> as the <a href=https://kubernetes.io/docs/concepts/services-networking/service/#external-ips>External IPs</a> of Envoy Proxy Service, this will <strong>require</strong> the address to be of type <code>IPAddress</code>.</p><p>Install the GatewayClass, Gateway from quickstart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml -n default
</span></span></code></pre></div><p>Set the address of the Gateway, the address settings here are for reference only:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/addresses&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: [{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;type&#34;: &#34;IPAddress&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;value&#34;: &#34;1.2.3.4&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   }]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME   CLASS   ADDRESS   PROGRAMMED   AGE
</span></span><span style=display:flex><span>eg     eg      1.2.3.4   True         14m
</span></span></code></pre></div><p>Verify the Envoy Proxy Service status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get service -n envoy-gateway-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>        AGE
</span></span><span style=display:flex><span>envoy-default-eg-64656661       LoadBalancer   10.96.236.219   1.2.3.4       80:31017/TCP   15m
</span></span><span style=display:flex><span>envoy-gateway                   ClusterIP      10.96.192.76    &lt;none&gt;        18000/TCP      15m
</span></span><span style=display:flex><span>envoy-gateway-metrics-service   ClusterIP      10.96.124.73    &lt;none&gt;        8443/TCP       15m
</span></span></code></pre></div><p><strong>Note:</strong> If the <code>Gateway.Spec.Addresses</code> is explicitly set, it will be the only addresses that populates the Gateway status.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-894b9ef799cf8f008c86fb040f693dcb>6.7 -</h1><h1 id=gateway-api-support>Gateway API Support</h1><p>As mentioned in the <a href=https://gateway.envoyproxy.io/latest/design/system-design.html>system design</a> document, Envoy Gateway&rsquo;s managed data plane is configured dynamically through
Kubernetes resources, primarily <a href=https://gateway-api.sigs.k8s.io/>Gateway API</a> objects. Envoy Gateway supports configuration using the following Gateway API resources.</p><h2 id=gatewayclass>GatewayClass</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.GatewayClass>GatewayClass</a> represents a &ldquo;class&rdquo; of gateways, i.e. which Gateways should be managed by Envoy Gateway.
Envoy Gateway supports managing <strong>a single</strong> GatewayClass resource that matches its configured <code>controllerName</code> and
follows Gateway API guidelines for <a href="https://gateway-api.sigs.k8s.io/concepts/guidelines/?h=conflict#conflicts">resolving conflicts</a> when multiple GatewayClasses exist with a matching
<code>controllerName</code>.</p><p><strong>Note:</strong> If specifying GatewayClass <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.ParametersReference>parameters reference</a>, it must refer to an <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoyproxy>EnvoyProxy</a> resource.</p><h2 id=gateway>Gateway</h2><p>When a <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.Gateway>Gateway</a> resource is created that references the managed GatewayClass, Envoy Gateway will create and manage a
new Envoy Proxy deployment. Gateway API resources that reference this Gateway will configure this managed Envoy Proxy
deployment.</p><h2 id=httproute>HTTPRoute</h2><p>An <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRoute>HTTPRoute</a> configures routing of HTTP traffic through one or more Gateways. The following HTTPRoute filters are
supported by Envoy Gateway:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li><li><code>requestRedirect</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>RequestRedirects</a>
configure policied for how requests that match the HTTPRoute should be modified and then redirected.</li><li><code>urlRewrite</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>UrlRewrites</a>
allow for modification of the request&rsquo;s hostname and path before it is proxied to its destination.</li><li><code>extensionRef</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilterType>ExtensionRefs</a> are used by Envoy Gateway to implement extended filters. Currently, Envoy Gateway
supports rate limiting and request authentication filters. For more information about these filters, refer to the
<a href=https://gateway.envoyproxy.io/latest/user/rate-limit.html>rate limiting</a> and <a href=https://gateway.envoyproxy.io/latest/user/authn.html>request authentication</a> documentation.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other destinations such
as arbitrary URLs is not possible.</li><li>The <code>filters</code> field within <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPBackendRef>HTTPBackendRef</a> is not supported.</li></ul><h2 id=tcproute>TCPRoute</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> configures routing of raw TCP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a TCP port number.</p><p><strong>Note:</strong> A TCPRoute only supports proxying in non-transparent mode, i.e. the backend will see the source IP and port of
the Envoy Proxy instance instead of the client.</p><h2 id=udproute>UDPRoute</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> configures routing of raw UDP traffic through one or more Gateways. Traffic can be forwarded to the
desired BackendRefs based on a UDP port number.</p><p><strong>Note:</strong> Similar to TCPRoutes, UDPRoutes only support proxying in non-transparent mode i.e. the backend will see the
source IP and port of the Envoy Proxy instance instead of the client.</p><h2 id=grpcroute>GRPCRoute</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRoute>GRPCRoute</a> configures routing of <a href=https://grpc.io/>gRPC</a> requests through one or more Gateways. They offer request matching by
hostname, gRPC service, gRPC method, or HTTP/2 Header. Envoy Gateway supports the following filters on GRPCRoutes to
provide additional traffic processing:</p><ul><li><code>requestHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestHeaderModifiers</a>
can be used to modify or add request headers before the request is proxied to its destination.</li><li><code>responseHeaderModifier</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>ResponseHeaderModifiers</a>
can be used to modify or add response headers before the response is sent back to the client.</li><li><code>requestMirror</code>: <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>RequestMirrors</a>
configure destinations where the requests should also be mirrored to. Responses to mirrored requests will be ignored.</li></ul><p><strong>Notes:</strong></p><ul><li>The only <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.GRPCRouteFilter>BackendRef</a> kind supported by Envoy Gateway is a <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>. Routing traffic to other
destinations such as arbitrary URLs is not currently possible.</li><li>The <code>filters</code> field within <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPBackendRef>HTTPBackendRef</a> is not supported.</li></ul><h2 id=tlsroute>TLSRoute</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.TLSRoute>TLSRoute</a> configures routing of TCP traffic through one or more Gateways. However, unlike TCPRoutes, TLSRoutes
can match against TLS-specific metadata.</p><h2 id=referencegrant>ReferenceGrant</h2><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io%2fv1beta1.ReferenceGrant>ReferenceGrant</a> is used to allow a resource to reference another resource in a different namespace. Normally an
HTTPRoute created in namespace <code>foo</code> is not allowed to reference a Service in namespace <code>bar</code>. A ReferenceGrant permits
these types of cross-namespace references. Envoy Gateway supports the following ReferenceGrant use-cases:</p><ul><li>Allowing an HTTPRoute, GRPCRoute, TLSRoute, UDPRoute, or TCPRoute to reference a Service in a different namespace.</li><li>Allowing an HTTPRoute&rsquo;s <code>requestMirror</code> filter to include a BackendRef that references a Service in a different
namespace.</li><li>Allowing a Gateway&rsquo;s <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.SecretObjectReference>SecretObjectReference</a> to reference a secret in a different namespace.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8563abe38555100b3562a843144b5df2>6.8 -</h1><h1 id=grpc-routing>GRPC Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource allows users to configure gRPC routing by matching HTTP/2 traffic and forwarding it to backend gRPC servers.
To learn more about gRPC routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>Install Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><h2 id=installation>Installation</h2><p>Install the gRPC routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/grpc-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, a Deployment, a Service, and a GRPCRoute resource.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification</h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later in the guide to test connectivity to proxied backend
services.</p><p>Check the status of the GRPCRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>The status for the GRPCRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;grpc-example.com&rdquo; and forwards it to the &ldquo;yages&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration</h2><p>Before testing GRPC routing to the <code>yages</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><p>You should see the below response</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;text&#34;</span>: <span style=color:#4e9a06>&#34;pong&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>Envoy Gateway also supports <a href=https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2>gRPC-Web</a> requests for this configuration. The below <code>curl</code> command can be used to send a grpc-Web request with over HTTP/2. You should receive the same response seen in the previous command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --http2-prior-knowledge -s <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80/yages.Echo/Ping -H <span style=color:#4e9a06>&#39;Host: grpc-example.com&#39;</span>   -H <span style=color:#4e9a06>&#39;Content-Type: application/grpc-web-text&#39;</span>   -H <span style=color:#4e9a06>&#39;Accept: application/grpc-web-text&#39;</span> -XPOST -d<span style=color:#4e9a06>&#39;AAAAAAA=&#39;</span> <span style=color:#000;font-weight:700>|</span> base64 -d
</span></span></code></pre></div><h2 id=grpcroute-match>GRPCRoute Match</h2><p>The <code>matches</code> field can be used to restrict the route to a specific set of requests based on GRPC&rsquo;s service and/or method names.
It supports two match types: <code>Exact</code> and <code>RegularExpression</code>.</p><h3 id=exact>Exact</h3><p><code>Exact</code> match is the default match type.</p><p>The following example shows how to match a request based on the service and method names for <code>grpc.reflection.v1alpha.ServerReflection/ServerReflectionInfo</code>,
as well as a match for all services with a method name <code>Ping</code> which matches <code>yages.Echo/Ping</code> in our deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div><h3 id=regularexpression>RegularExpression</h3><p>The following example shows how to match a request based on the service and method names
with match type <code>RegularExpression</code>. It matches all the services and methods with pattern
<code>/.*.Echo/Pin.+</code>, which matches <code>yages.Echo/Ping</code> in our deployment.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          method: &#34;Pin.+&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          service: &#34;.*.Echo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: RegularExpression
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the GRPCRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>grpc-routing -o yaml
</span></span></code></pre></div><p>Test GRPC routing to the <code>yages</code> backend using the <a href=https://github.com/fullstorydev/grpcurl>grpcurl</a> command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0065b883d3771bbee12c3729343cedb5>6.9 -</h1><h1 id=http-redirects>HTTP Redirects</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can issue redirects to clients or rewrite paths sent upstream using filters. Note that
HTTPRoute rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong>
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>HTTPRoute filters</a> which consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To
learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps from the <a href=secure-gateways.md>Secure Gateways</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTPS.</p><h2 id=redirects>Redirects</h2><p>Redirects return HTTP 3XX responses to a client, instructing it to retrieve a different resource. A
<a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRequestRedirectFilter><code>RequestRedirect</code> filter</a> instructs Gateways to emit a redirect response to requests that match the rule.
For example, to issue a permanent redirect (301) from HTTP to HTTPS, configure <code>requestRedirect.statusCode=301</code> and
<code>requestRedirect.scheme="https"</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-to-https-filter-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          scheme: https
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 301
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 443
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p><strong>Note:</strong> <code>301</code> (default) and <code>302</code> are the only supported statusCodes.</p><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-to-https-filter-redirect -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>redirect.example/get</code> should result in a <code>301</code> response from the example Gateway and redirecting to the
configured redirect hostname.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 301 Moved Permanently
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; location: https://www.example.com/get
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>If you followed the steps in the <a href=secure-gateways.md>Secure Gateways</a> guide, you should be able to curl the redirect
location.</p><h2 id=path-redirects>Path Redirects</h2><p>Path redirects use an HTTP Path Modifier to replace either entire paths or path prefixes. For example, the HTTPRoute
below will issue a 302 redirect to all <code>path.redirect.example</code> requests whose path begins with <code>/get</code> to <code>/status/200</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-path-redirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.redirect.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: /get
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: RequestRedirect
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requestRedirect:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /status/200
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          statusCode: 302
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-path-redirect -o yaml
</span></span></code></pre></div><p>Querying <code>path.redirect.example</code> should result in a <code>302</code> response from the example Gateway and a redirect location
containing the configured redirect path.</p><p>Query the <code>path.redirect.example</code> host:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: path.redirect.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span></code></pre></div><p>You should receive a <code>302</code> with a redirect location of <code>http://path.redirect.example/status/200</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-18fc6726bfbca0af0e301a1b238a462a>6.10 -</h1><h1 id=http-request-headers>HTTP Request Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a request before forwarding it to the upstream service. HTTPRoute
rules cannot use both filter types at once. Currently, Envoy Gateway only supports <strong>core</strong> <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteFilter>HTTPRoute filters</a> which
consist of <code>RequestRedirect</code> and <code>RequestHeaderModifier</code> at the time of this writing. To learn more about HTTP routing,
refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPHeaderFilter><code>RequestHeaderModifier</code> filter</a> instructs Gateways to modify the headers in requests that match the rule
before forwarding the request upstream. Note that the <code>RequestHeaderModifier</code> filter will only modify headers before the
request is sent from Envoy to the upstream service and will not affect response headers returned to the downstream
client.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=adding-request-headers>Adding Request Headers</h2><p>The <code>RequestHeaderModifier</code> filter can add new headers to a request before it is sent to the upstream. If the request
does not have the header configured by the filter, then that header will be added to the request. If the request already
has the header configured by the filter, then the value of the header in the filter will be appended to the value of the
header in the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the value:
<code>something,foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-request-headers>Setting Request Headers</h2><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code> with the original value
<code>something</code> replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;set-header: something&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-request-headers>Removing Request Headers</h2><p>Headers can be removed from a request by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the request does not have the header configured by the filter, then it
will be added, but unlike <a href=#adding-request-headers>adding request headers</a> which will append the value of the header if
the request already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the upstream example app received the header <code>add-header</code>, but the header
<code>remove-header</code> that was sent by curl was removed before the upstream received the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> --header <span style=color:#4e9a06>&#34;add-header: something&#34;</span> --header <span style=color:#4e9a06>&#34;remove-header: foo&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Add-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;something&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters</h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-526c2363197d6fc4c61100d884f89db8>6.11 -</h1><h1 id=httproute-request-mirroring>HTTPRoute Request Mirroring</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams. It is possible to divide the traffic between these backends using <a href=http-traffic-splitting.md>Traffic Splitting</a>, but it is also possible to mirror requests to another Service instead. Request mirroring is accomplished using Gateway API&rsquo;s <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRequestMirrorFilter>HTTPRequestMirrorFilter</a> on the <code>HTTPRoute</code>.</p><p>When requests are made to a <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code>, the response will never come from the <code>backendRef</code> defined in the filter. Responses from the mirror <code>backendRef</code> are always ignored.</p><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=mirroring-the-traffic>Mirroring the Traffic</h2><p>Next, create a new <code>Deployment</code> and <code>Service</code> to mirror requests to. The following example will use
a second instance of the application deployed in the quickstart.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Then create an <code>HTTPRoute</code> that uses a <code>HTTPRequestMirrorFilter</code> to send requests to the original
service from the quickstart, and mirror request to the service that was just deployed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f - <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-mirror -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Check the logs of the pods and you will see that the original deployment and the new deployment each got a request:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ kubectl logs deploy/backend <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> kubectl logs deploy/backend-2
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:41566<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Starting server, listening on port <span style=color:#0000cf;font-weight:700>3000</span> <span style=color:#ce5c00;font-weight:700>(</span>http<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Echoing back request made to /get to client <span style=color:#ce5c00;font-weight:700>(</span>10.42.0.10:45096<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple BackendRefs</h2><p>When an <code>HTTPRoute</code> has multiple <code>backendRefs</code> and an <code>HTTPRequestMirrorFilter</code>, traffic splitting will still behave the same as it normally would for the main <code>backendRefs</code> while the <code>backendRef</code> of the <code>HTTPRequestMirrorFilter</code> will continue receiving mirrored copies of the incoming requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=multiple-httprequestmirrorfilters>Multiple HTTPRequestMirrorFilters</h2><p>Multiple <code>HTTPRequestMirrorFilters</code> are not supported on the same <code>HTTPRoute</code> <code>rule</code>. When attempting to do so, the admission webhook will reject the configuration.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-mirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: RequestMirror
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      requestMirror:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        backendRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Error from server: error when creating &#34;STDIN&#34;: admission webhook &#34;validate.gateway.networking.k8s.io&#34; denied the request: spec.rules[0].filters: Invalid value: &#34;RequestMirror&#34;: cannot be used multiple times in the same rule
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7e057f84803b3e18612397301b8086a0>6.12 -</h1><h1 id=http-response-headers>HTTP Response Headers</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource can modify the headers of a response before responding it to the downstream service. To learn
more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><p>A <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPHeaderFilter><code>ResponseHeaderModifier</code> filter</a> instructs Gateways to modify the headers in responses that match the
rule before responding to the downstream. Note that the <code>ResponseHeaderModifier</code> filter will only modify headers before
the response is returned from Envoy to the downstream client and will not affect request headers forwarding to the
upstream service.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=adding-response-headers>Adding Response Headers</h2><p>The <code>ResponseHeaderModifier</code> filter can add new headers to a response before it is sent to the upstream. If the response
does not have the header configured by the filter, then that header will be added to the response. If the response
already has the header configured by the filter, then the value of the header in the filter will be appended to the
value of the header in the response.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>add-header</code> with the value: <code>foo</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: X-Foo: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: X-Foo: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-foo: value1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; add-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;X-Foo: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=setting-response-headers>Setting Response Headers</h2><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the downstream client received the header <code>set-header</code> with the original value <code>value1</code>
replaced by <code>foo</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: set-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: set-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; set-header: foo
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;set-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=removing-response-headers>Removing Response Headers</h2><p>Headers can be removed from a response by simply supplying a list of header names.</p><p>Setting headers is similar to adding headers. If the response does not have the header configured by the filter, then it
will be added, but unlike <a href=#adding-response-headers>adding response headers</a> which will append the value of the header
if the response already contains it, setting a header will cause the value to be replaced by the value configured in the
filter.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;remove-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>headers.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate that the header <code>remove-header</code> that was sent by curl was removed before the upstream
received the response.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: headers.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span> -H <span style=color:#4e9a06>&#39;X-Echo-Set-Header: remove-header: value1&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: headers.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> X-Echo-Set-Header: remove-header: value1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Echo-Set-Header&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    &#34;remove-header&#34;: value1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=combining-filters>Combining Filters</h2><p>Headers can be added/set/removed in a single filter on the same HTTPRoute and they will all perform as expected</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - headers.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ResponseHeaderModifier
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      responseHeaderModifier:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        add:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;add-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;foo&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        set:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: &#34;set-header-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;bar&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        remove:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - &#34;removed-header&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9b9b6c7f848d76cec306e87849a6ddbb>6.13 -</h1><h1 id=http-routing>HTTP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows users to configure HTTP routing by matching HTTP traffic and forwarding it to
Kubernetes backends. Currently, the only supported backend supported by Envoy Gateway is a Service resource. This guide
shows how to route traffic based on host, header, and path fields and forward the traffic to different Kubernetes
Services. To learn more about HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>Install Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><h2 id=installation>Installation</h2><p>Install the HTTP routing example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/http-routing.yaml
</span></span></code></pre></div><p>The manifest installs a <a href=https://gateway-api.sigs.k8s.io/api-types/gatewayclass/>GatewayClass</a>, <a href=https://gateway-api.sigs.k8s.io/api-types/gateway/>Gateway</a>, four Deployments, four Services, and three HTTPRoute resources.
The GatewayClass is a cluster-scoped resource that represents a class of Gateways that can be instantiated.</p><p><strong>Note:</strong> Envoy Gateway is configured by default to manage a GatewayClass with
<code>controllerName: gateway.envoyproxy.io/gatewayclass-controller</code>.</p><h2 id=verification>Verification</h2><p>Check the status of the GatewayClass:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gc --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Accepted=True&rdquo;, indicating Envoy Gateway is managing the GatewayClass.</p><p>A Gateway represents configuration of infrastructure. When a Gateway is created, <a href=https://www.envoyproxy.io/>Envoy proxy</a> infrastructure is
provisioned or configured by Envoy Gateway. The <code>gatewayClassName</code> defines the name of a GatewayClass used by this
Gateway. Check the status of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateways --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing
</span></span></code></pre></div><p>The status should reflect &ldquo;Ready=True&rdquo;, indicating the Envoy proxy infrastructure has been provisioned. The status also
provides the address of the Gateway. This address is used later in the guide to test connectivity to proxied backend
services.</p><p>The three HTTPRoute resources create routing rules on the Gateway. In order to receive traffic from a Gateway,
an HTTPRoute must be configured with <code>parentRefs</code> which reference the parent Gateway(s) that it should be attached to.
An HTTPRoute can match against a <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPRouteSpec>single set of hostnames</a>. These hostnames are matched before any other matching
within the HTTPRoute takes place. Since <code>example.com</code>, <code>foo.example.com</code>, and <code>bar.example.com</code> are separate hosts with
different routing requirements, each is deployed as its own HTTPRoute - <code>example-route, ``foo-route</code>, and <code>bar-route</code>.</p><p>Check the status of the HTTPRoutes:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproutes --selector<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>=</span>http-routing -o yaml
</span></span></code></pre></div><p>The status for each HTTPRoute should surface &ldquo;Accepted=True&rdquo; and a <code>parentRef</code> that references the example Gateway.
The <code>example-route</code> matches any traffic for &ldquo;example.com&rdquo; and forwards it to the &ldquo;example-svc&rdquo; Service.</p><h2 id=testing-the-configuration>Testing the Configuration</h2><p>Before testing HTTP routing to the <code>example-svc</code> backend, get the Gateway&rsquo;s address.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Test HTTP routing to the <code>example-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "example-backend-*"</code> indicating the traffic
was routed to the example backend service. If you change the hostname to a hostname not represented in any of the
HTTPRoutes, e.g. &ldquo;<a href=https://www.example.com>www.example.com</a>&rdquo;, the HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>The <code>foo-route</code> matches any traffic for <code>foo.example.com</code> and applies its routing rules to forward the traffic to the
&ldquo;foo-svc&rdquo; Service. Since there is only one path prefix match for <code>/login</code>, only <code>foo.example.com/login/*</code> traffic will
be forwarded. Test HTTP routing to the <code>foo-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/login&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "foo-backend-*"</code> indicating the traffic
was routed to the foo backend service. Traffic to any other paths that do not begin with <code>/login</code> will not be matched by
this HTTPRoute. Test this by removing <code>/login</code> from the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: foo.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>The HTTP traffic will not be routed and a <code>404</code> should be returned.</p><p>Similarly, the <code>bar-route</code> HTTPRoute matches traffic for <code>bar.example.com</code>. All traffic for this hostname will be
evaluated against the routing rules. The most specific match will take precedence which means that any traffic with the
<code>env:canary</code> header will be forwarded to <code>bar-svc-canary</code> and if the header is missing or not <code>canary</code> then it&rsquo;ll be
forwarded to <code>bar-svc</code>. Test HTTP routing to the <code>bar-svc</code> backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-backend-*"</code> indicating the traffic
was routed to the foo backend service.</p><p>Test HTTP routing to the <code>bar-canary-svc</code> backend by adding the <code>env: canary</code> header to the request.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -vvv --header <span style=color:#4e9a06>&#34;Host: bar.example.com&#34;</span> --header <span style=color:#4e9a06>&#34;env: canary&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/&#34;</span>
</span></span></code></pre></div><p>A <code>200</code> status code should be returned and the body should include <code>"pod": "bar-canary-backend-*"</code> indicating the
traffic was routed to the foo backend service.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad54cbd9f25034c25a4b39533d9b82b7>6.14 -</h1><h1 id=httproute-traffic-splitting>HTTPRoute Traffic Splitting</h1><p>The <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> resource allows one or more <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef>backendRefs</a> to be provided. Requests will be routed to these upstreams
if they match the rules of the HTTPRoute. If an invalid backendRef is configured, then HTTP responses will be returned
with status code <code>500</code> for all requests that would have been sent to that backend.</p><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=single-backendref>Single backendRef</h2><p>When a single backendRef is configured in a HTTPRoute, it will receive 100% of the traffic.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-headers -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in a <code>200</code> response from the example Gateway and the output from the
example app should indicate which pod handled the request. There is only one pod in the deployment for the example app
from the quickstart, so it will be the same on all subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-79665566f5-s589f&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=multiple-backendrefs>Multiple backendRefs</h2><p>If multiple backendRefs are configured, then traffic will be split between the backendRefs equally unless a weight is
configured.</p><p>First, create a second instance of the example app from the quickstart:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ServiceAccount
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    service: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      serviceAccountName: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Then create an HTTPRoute that uses both the app from the quickstart and the second instance that was just created</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses from the example Gateway and the output from the
example app that indicates which pod handled the request should switch between the first pod and the second one from the
new deployment on subsequent requests.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> add-header: something
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 474
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-75bcd4c969-lsxpz&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=weighted-backendrefs>Weighted backendRefs</h2><p>If multiple backendRefs are configured and an un-even traffic split between the backends is desired, then the <code>weight</code>
field can be used to control the weight of requests to each backend. If weight is not configured for a backendRef it is
assumed to be <code>1</code>.</p><p>The <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.BackendRef>weight field in a backendRef</a> controls the distribution of the traffic split. The proportion of
requests to a single backendRef is calculated by dividing its <code>weight</code> by the sum of all backendRef weights in the
HTTPRoute. The weight is not a percentage and the sum of all weights does not need to add up to 100.</p><p>The HTTPRoute below will configure the gateway to send 80% of the traffic to the backend service, and 20% to the
backend-2 service.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=invalid-backendrefs>Invalid backendRefs</h2><p>backendRefs can be considered invalid for the following reasons:</p><ul><li>The <code>group</code> field is configured to something other than <code>""</code>. Currently, only the core API group (specified by
omitting the group field or setting it to an empty string) is supported</li><li>The <code>kind</code> field is configured to anything other than <code>Service</code>. Envoy Gateway currently only supports Kubernetes
Service backendRefs</li><li>The backendRef configures a service with a <code>namespace</code> not permitted by any existing ReferenceGrants</li><li>The <code>port</code> field is not configured or is configured to a port that does not exist on the Service</li><li>The named Service configured by the backendRef cannot be found</li></ul><p>Modifying the above example to make the backend-2 backendRef invalid by using a port that does not exist on the Service
will result in 80% of the traffic being sent to the backend service, and 20% of the traffic receiving an HTTP response
with status code <code>500</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-headers
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backends.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 8
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Querying <code>backends.example/get</code> should result in <code>200</code> responses 80% of the time, and <code>500</code> responses 20% of the time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -vvv --header <span style=color:#4e9a06>&#34;Host: backends.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: backends.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.81.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 500 Internal Server Error
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d4306dd0cf2e17b9fd55dad08c4ff981>6.15 -</h1><h1 id=http-url-rewrite>HTTP URL Rewrite</h1><p><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1beta1.HTTPURLRewriteFilter>HTTPURLRewriteFilter</a> defines a filter that modifies a request during forwarding. At most one of these filters may be
used on a Route rule. This MUST NOT be used on the same Route rule as a HTTPRequestRedirect filter.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=rewrite-url-prefix-path>Rewrite URL Prefix Path</h2><p>You can configure to rewrite the prefix in the url like below. In this example, any curls to
<code>http://${GATEWAY_HOST}/get/xxx</code> will be rewritten to <code>http://${GATEWAY_HOST}/replace/xxx</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplacePrefixMatch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replacePrefixMatch: /replace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path</code> should rewrite to
<code>http://${GATEWAY_HOST}/replace/origin/path</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt; HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:03:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 503
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/replace/origin/path&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;fd84b842-9937-4fb5-83c7-61470d854b90&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path</code>, but the actual path is <code>/replace/origin/path</code>.</p><h2 id=rewrite-url-full-path>Rewrite URL Full Path</h2><p>You can configure to rewrite the fullpath in the url like below. In this example, any request sent to
<code>http://${GATEWAY_HOST}/get/origin/path/xxxx</code> will be rewritten to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get/origin/path&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            type: ReplaceFullPath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            replaceFullPath: /force/replace/fullpath
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get/origin/path/extra</code> should rewrite the request to
<code>http://${GATEWAY_HOST}/force/replace/fullpath</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get/origin/path/extra&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get/origin/path/extra HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:09:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/force/replace/fullpath&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;path.rewrite.example&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Original-Path&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;/get/origin/path/extra&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;8ab774d6-9ffa-4faa-abbb-f45b0db00895&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Envoy-Original-Path</code> is <code>/get/origin/path/extra</code>, but the actual path is
<code>/force/replace/fullpath</code>.</p><h2 id=rewrite-host-name>Rewrite Host Name</h2><p>You can configure to rewrite the hostname like below. In this example, any requests sent to
<code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into <code>envoygateway.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-filter-url-rewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path.rewrite.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: &#34;/get&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - type: URLRewrite
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        urlRewrite:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          hostname: &#34;envoygateway.io&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-filter-url-rewrite -o yaml
</span></span></code></pre></div><p>Querying <code>http://${GATEWAY_HOST}/get</code> with <code>--header "Host: path.rewrite.example"</code> will rewrite host into
<code>envoygateway.io</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -L -vvv --header <span style=color:#4e9a06>&#34;Host: path.rewrite.example&#34;</span> <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/get&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#8f5902>&gt;</span> GET /get HTTP/1.1
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Host: path.rewrite.example
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> User-Agent: curl/7.85.0
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span> Accept: */*
</span></span><span style=display:flex><span><span style=color:#8f5902>&gt;</span>
</span></span><span style=display:flex><span>* Mark bundle as not supporting multiuse
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; date: Wed, 21 Dec 2022 11:15:15 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; content-length: 481
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;path&#34;: &#34;/get&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;host&#34;: &#34;envoygateway.io&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;method&#34;: &#34;GET&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;proto&#34;: &#34;HTTP/1.1&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;headers&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;Accept&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;*/*&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;User-Agent&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;curl/7.85.0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Envoy-Expected-Rq-Timeout-Ms&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;15000&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Host&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;path.rewrite.example&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Forwarded-Proto&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;http&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ],
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;X-Request-Id&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>   &#34;39aa447c-97b9-45a3-a675-9fb266ab1af0&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ]
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> },
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;namespace&#34;: &#34;default&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;ingress&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;service&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic> &#34;pod&#34;: &#34;backend-6fdd4b9bd8-8vlc5&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>You can see that the <code>X-Forwarded-Host</code> is <code>path.rewrite.example</code>, but the actual host is <code>envoygateway.io</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-66c616300865bef62c1b8456505ac2db>6.16 -</h1><h1 id=installation>Installation</h1><h2 id=prerequisites>Prerequisites</h2><p>A Kubernetes cluster.</p><p><strong>Note:</strong> Refer to the <a href=../intro/compatibility.rst>Compatibility Matrix</a> for supported Kubernetes versions.</p><h2 id=installation-1>Installation</h2><p>Install the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Install the GatewayClass, Gateway, HTTPRoute and example app:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml -n default
</span></span></code></pre></div><p><strong>Note</strong>: <a href=https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml><code>quickstart.yaml</code></a> defines that Envoy Gateway will listen for
traffic on port 80 on its globally-routable IP address, to make it easy to use
browsers to test Envoy Gateway. When Envoy Gateway sees that its Listener is
using a privileged port (&lt;1024), it will map this internally to an
unprivileged port, so that Envoy Gateway doesn&rsquo;t need additional privileges.
It&rsquo;s important to be aware of this mapping, since you may need to take it into
consideration when debugging.</p><h2 id=helm-chart-customizations>Helm chart customizations</h2><p>Some of the quick ways of using the helm install command for envoy gateway installation are below.</p><h3 id=increase-the-replicas>Increase the replicas</h3><pre tabindex=0><code>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace --set deployment.replicas=2
</code></pre><h3 id=change-the-kubernetesclusterdomain-name>Change the kubernetesClusterDomain name</h3><p>If you have installed your cluster with different domain name you can use below command.</p><pre tabindex=0><code>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace --set kubernetesClusterDomain=&lt;domain name&gt;
</code></pre><p><strong>Note</strong>: Above are some of the ways we can directly use for customization of our installation. But if you are looking for more complex changes <a href=https://helm.sh/docs/chart_template_guide/values_files/>values.yaml</a> comes to rescue.</p><h3 id=using-valuesyaml-file-for-complex-installation>Using values.yaml file for complex installation.</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deployment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoyGateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>700m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>128Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>10m</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>64Mi</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grpc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18005</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ratelimit</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18006</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>18001</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>envoyGateway</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>debug</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Here we have made three changes to our values.yaml file. Increase the resources limit for cpu to <code>700m</code>, changed the port for grpc to <code>18005</code> and for ratelimit to <code>18006</code> and also updated the logging level to <code>debug</code>.</p><p>You can use the below command to install the envoy gateway using values.yaml file.</p><pre tabindex=0><code>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace -f values.yaml
</code></pre><p>If you want to know all the available fields inside the values.yaml file checkout the <code>helm</code> section <a href=../helm/api.md>here</a></p><h2 id=open-ports>Open Ports</h2><p>These are the ports used by Envoy Gateway and the managed Envoy Proxy.</p><table><thead><tr><th style=text-align:center>Envoy Gateway</th><th style=text-align:center>Address</th><th style=text-align:center>Port</th></tr></thead><tbody><tr><td style=text-align:center>Xds EnvoyProxy Server</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>18000</td></tr><tr><td style=text-align:center>Xds RateLimit Server</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>18001</td></tr><tr><td style=text-align:center>Admin Server</td><td style=text-align:center>127.0.0.1</td><td style=text-align:center>19000</td></tr></tbody></table><table><thead><tr><th style=text-align:center>Envoy Proxy</th><th style=text-align:center>Address</th><th style=text-align:center>Port</th></tr></thead><tbody><tr><td style=text-align:center>Admin Server</td><td style=text-align:center>127.0.0.1</td><td style=text-align:center>19000</td></tr><tr><td style=text-align:center>Heath Check Listener</td><td style=text-align:center>0.0.0.0</td><td style=text-align:center>19001</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-21d4065290fe2ac3baca1e8011739c93>6.17 -</h1><h1 id=multicluster-service-routing>Multicluster Service Routing</h1><p>The Multicluster Service API ServiceImport object can be used as part of the GatewayAPI backendRef for configuring routes. For more information about multicluster service API follow <a href=https://multicluster.sigs.k8s.io/concepts/multicluster-services-api/>sig documentation</a>.</p><p>We will use <a href=https://github.com/submariner-io/submariner>Submariner project</a> for setting up the multicluster environment for exporting the service to be routed from peer clusters.</p><h2 id=setting-kind-clusters-and-installing-submariner>Setting KIND clusters and installing Submariner.</h2><ul><li>We will be using KIND clusters to demonstrate this example.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/submariner-io/submariner-operator
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> submariner-operator
</span></span><span style=display:flex><span>make clusters
</span></span></code></pre></div><p>Note: remain in submariner-operator directory for the rest of the steps in this section</p><ul><li>Install subctl:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -Ls https://get.submariner.io  <span style=color:#000;font-weight:700>|</span> <span style=color:#000>VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v0.14.6 bash
</span></span></code></pre></div><ul><li>Set up multicluster service API and submariner for cross cluster traffic using ServiceImport</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>subctl deploy-broker --kubeconfig output/kubeconfigs/kind-config-cluster1 --globalnet
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster1 broker-info.subm --clusterid cluster1 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>subctl join --kubeconfig output/kubeconfigs/kind-config-cluster2 broker-info.subm --clusterid cluster2 --natt<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>Once the above steps are done and all the pods are up in both the clusters. We are ready for installing envoy gateway.</p><h2 id=install-envoygateway>Install EnvoyGateway</h2><p>Install the Gateway API CRDs and Envoy Gateway in cluster1:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=install-application>Install Application</h2><p>Install the backend application in cluster2 and export it through subctl command.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/application.yaml --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span><span style=display:flex><span>subctl <span style=color:#204a87>export</span> service backend --namespace default --kubeconfig output/kubeconfigs/kind-config-cluster2
</span></span></code></pre></div><h2 id=create-gateway-api-objects>Create Gateway API Objects</h2><p>Create the Gateway API objects GatewayClass, Gateway and HTTPRoute in cluster1 to set up the routing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/multicluster-service.yaml --kubeconfig output/kubeconfigs/kind-config-cluster1
</span></span></code></pre></div><h2 id=testing-the-configuration>Testing the Configuration</h2><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9a253aa6ff69db8dd67cfa17628f4a59>6.18 -</h1><h1 id=proxy-observability>Proxy Observability</h1><p>Envoy Gateway provides observability for the ControlPlane and the underlying EnvoyProxy instances.
This guide show you how to config proxy observability, includes metrics, logs, and traces.</p><h2 id=prerequisites>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p><a href=https://fluentbit.io/>FluentBit</a> is used to collect logs from the EnvoyProxy instances and forward them to Loki. Install FluentBit:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm repo add fluent https://fluent.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm upgrade --install fluent-bit fluent/fluent-bit -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/fluent-bit/helm-values.yaml -n monitoring --create-namespace --version 0.30.4
</span></span></code></pre></div><p><a href=https://grafana.com/oss/loki/>Loki</a> is used to store logs. Install Loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/loki/loki.yaml -n monitoring 
</span></span></code></pre></div><p><a href=https://grafana.com/oss/tempo/>Tempo</a> is used to store traces. Install Tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm upgrade --install tempo grafana/tempo -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/tempo/helm-values.yaml -n monitoring --create-namespace --version 1.3.1
</span></span></code></pre></div><p><a href=https://opentelemetry.io/docs/collector/>OpenTelemetry Collector</a> offers a vendor-agnostic implementation of how to receive, process and export telemetry data.
Install OTel-Collector:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
</span></span><span style=display:flex><span>helm repo update
</span></span><span style=display:flex><span>helm upgrade --install otel-collector open-telemetry/opentelemetry-collector -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/otel-collector/helm-values.yaml -n monitoring --create-namespace --version 0.60.0
</span></span></code></pre></div><p>Expose endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>LOKI_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc loki -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>TEMPO_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc tempo -n monitoring -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=metrics>Metrics</h2><p>By default, Envoy Gateway doesn&rsquo;t expose metrics of the EnvoyProxy instances.
You can enable metrics by setting the <code>telemetry.metrics.prometheus</code> in the <code>EnvoyProxy</code> CRD.</p><p>Expose prometheus metrics endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/prometheus.yaml
</span></span></code></pre></div><p>Verify metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$ENVOY_POD_NAME</span> -n envoy-gateway-system 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/stats/prometheus  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0/match/0-www&#34;</span>
</span></span></code></pre></div><p>Envoy Gateway can send metrics to OpenTelemetry Sink.
Send metrics to OTel-Collector:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/metric/otel-sink.yaml
</span></span></code></pre></div><p>Verify OTel-Collector metrics:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>OTEL_POD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get pod -n monitoring --selector<span style=color:#ce5c00;font-weight:700>=</span>app.kubernetes.io/name<span style=color:#ce5c00;font-weight:700>=</span>opentelemetry-collector -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>kubectl port-forward pod/<span style=color:#000>$OTEL_POD_NAME</span> -n monitoring 19001:19001
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># check metrics </span>
</span></span><span style=display:flex><span>curl localhost:19001/metrics  <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;default/backend/rule/0/match/0-www&#34;</span>
</span></span></code></pre></div><h2 id=logs>Logs</h2><p>By default, Envoy Gateway send logs to stdout in <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage.html#default-format-string>default text format</a>.
Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={job=\&#34;fluentbit\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><p>If you want to disable it, set the <code>telemetry.accesslog.disable</code> to <code>true</code> in the <code>EnvoyProxy</code> CRD.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/accesslog/disable-accesslog.yaml
</span></span></code></pre></div><p>Envoy Gateway can send logs to OpenTelemetry Sink.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/accesslog/otel-accesslog.yaml
</span></span></code></pre></div><p>Verify logs from loki:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$LOKI_IP</span><span style=color:#4e9a06>:3100/loki/api/v1/query_range&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;query={exporter=\&#34;OTLP\&#34;}&#34;</span> <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data.result[0].values&#39;</span>
</span></span></code></pre></div><h2 id=traces>Traces</h2><p>By default, Envoy Gateway doesn&rsquo;t send traces to OpenTelemetry Sink.
You can enable traces by setting the <code>telemetry.tracing</code> in the <code>EnvoyProxy</code> CRD.</p><p><em><strong>Note:</strong></em> Envoy Gateway use 100% sample rate, which means all requests will be traced. This may cause performance issues.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/tracing/default.yaml
</span></span></code></pre></div><p>Verify traces from tempo:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/search&#34;</span> --data-urlencode <span style=color:#4e9a06>&#34;q={ component=envoy }&#34;</span> <span style=color:#000;font-weight:700>|</span> jq .traces
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -s <span style=color:#4e9a06>&#34;http://</span><span style=color:#000>$TEMPO_IP</span><span style=color:#4e9a06>:3100/api/traces/&lt;trace_id&gt;&#34;</span> <span style=color:#000;font-weight:700>|</span> jq
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e62114c29f995b23e2fa6acc5f391326>6.19 -</h1><h1 id=quickstart>Quickstart</h1><p>This guide will help you get started with Envoy Gateway in a few simple steps.</p><h2 id=prerequisites>Prerequisites</h2><p>A Kubernetes cluster.</p><p><strong>Note:</strong> Refer to the <a href=../intro/compatibility.rst>Compatibility Matrix</a> for supported Kubernetes versions.</p><p><strong>Note:</strong> In case your Kubernetes cluster, does not have a LoadBalancer implementation, we recommend installing one
so the <code>Gateway</code> resource has an Address associated with it. We recommend using <a href=https://metallb.universe.tf/installation/>MetalLB</a>.</p><h2 id=installation>Installation</h2><p>Install the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Install the GatewayClass, Gateway, HTTPRoute and example app:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml -n default
</span></span></code></pre></div><p><strong>Note</strong>: <a href=https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml><code>quickstart.yaml</code></a> defines that Envoy Gateway will listen for
traffic on port 80 on its globally-routable IP address, to make it easy to use
browsers to test Envoy Gateway. When Envoy Gateway sees that its Listener is
using a privileged port (&lt;1024), it will map this internally to an
unprivileged port, so that Envoy Gateway doesn&rsquo;t need additional privileges.
It&rsquo;s important to be aware of this mapping, since you may need to take it into
consideration when debugging.</p><h2 id=testing-the-configuration>Testing the Configuration</h2><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8888:80 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://localhost:8888/get
</span></span></code></pre></div><h3 id=external-loadbalancer-support>External LoadBalancer Support</h3><p>You can also test the same functionality by sending traffic to the External IP. To get the external IP of the
Envoy service, run:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> -n envoy-gateway-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>In certain environments, the load balancer may be exposed using a hostname, instead of an IP address. If so, replace
<code>ip</code> in the above command with <code>hostname</code>.</p><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl --verbose --header <span style=color:#4e9a06>&#34;Host: www.example.com&#34;</span> http://<span style=color:#000>$GATEWAY_HOST</span>/get
</span></span></code></pre></div><h2 id=clean-up>Clean-Up</h2><p>Use the steps in this section to uninstall everything from the quickstart guide.</p><p>Delete the GatewayClass, Gateway, HTTPRoute and Example App:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete -f https://github.com/envoyproxy/gateway/releases/download/latest/quickstart.yaml --ignore-not-found<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>Delete the Gateway API CRDs and Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm uninstall eg -n envoy-gateway-system
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><p>Checkout the <a href=../dev/README.md>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a52e3c47a260e6eeffbb6eee27a7cb1>6.20 -</h1><h1 id=rate-limit>Rate Limit</h1><p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p><p>Here are some reasons why you may want to implement Rate limits</p><ul><li>To prevent malicious activity such as DDoS attacks.</li><li>To prevent applications and its resources (such as a database) from getting overloaded.</li><li>To create API limits based on user entitlements.</li></ul><p>Envoy Gateway supports <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting>Global rate limiting</a>, where the rate limit is common across all the instances of Envoy proxies where its applied
i.e. if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, this limit is common and will be hit
if 5 requests pass through the first replica and 5 requests pass through the second replica within the same second.</p><p>Envoy Gateway introduces a new CRD called <a href=https://gateway.envoyproxy.io/latest/api/extension_types.html#ratelimitfilter>RateLimitFilter</a> that allows the user to describe their rate limit intent. This instantiated resource
can be linked to a <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a> or <a href=https://gateway-api.sigs.k8s.io/api-types/grpcroute/>GRPCRoute</a> resource using an <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io%2fv1beta1.HTTPRouteFilter>ExtensionRef</a> filter.</p><h2 id=prerequisites>Prerequisites</h2><h3 id=install-envoy-gateway>Install Envoy Gateway</h3><ul><li>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the HTTPRoute example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</li></ul><h3 id=install-redis>Install Redis</h3><ul><li>The global rate limit feature is based on <a href=https://github.com/envoyproxy/ratelimit>Envoy Ratelimit</a> which requires a Redis instance as its caching layer.
Lets install a Redis deployment in the <code>redis-system</code> namespce.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - image: redis:6.0.6
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          limits:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 1500m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            cpu: 200m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            memory: 256Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: redis-system 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    targetPort: 6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=enable-global-rate-limit-in-envoy-gateway>Enable Global Rate limit in Envoy Gateway</h3><ul><li>The default installation of Envoy Gateway installs a default <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoygateway>EnvoyGateway</a> configuration and attaches it
using a <code>ConfigMap</code>. In the next step, we will update this resource to enable rate limit in Envoy Gateway
as well as configure the URL for the Redis instance used for Global rate limiting.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>After updating the <code>ConfigMap</code>, you will need to restart the <code>envoy-gateway</code> deployment so the configuration kicks in</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div><h2 id=rate-limit-specific-user>Rate Limit Specific User</h2><p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code>x-user-id</code> header
with a value set to <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ratelimit-specific-user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: one
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute>HTTPRoute</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-specific-user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get httproute/http-ratelimit -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Lets query <code>ratelimit.example/get</code> 4 times. We should receive a <code>200</code> response from the example Gateway for the first 3 requests
and then receive a <code>429</code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:38 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:34:39 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h3 id=grpcroute>GRPCRoute</h3><p>Before proceeding, you should install the GRPCRoute example from <a href=grpc-routing.md>GRPC Routing</a>,
and be able to query the example backend using GRPC.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-specific-user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The GRPCRoute status should indicate that it has been accepted and is bound to the example Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get grpcroute/yages -o yaml
</span></span></code></pre></div><p>Get the Gateway&rsquo;s address:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/example-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Lets query <code>grpc-example.com</code> with <code>yages.Echo/Ping</code> 4 times. We should receive a <code>pong</code> response from the example Gateway for the first 3 requests
and then receive a rpc error for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code>x-user-id</code>
and value <code>one</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com -H <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span></code></pre></div><p>You should be able to send requests with the <code>x-user-id</code> header and a different value and receive successful responses from the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com -H <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span></code></pre></div><h2 id=rate-limit-distinct-users>Rate Limit Distinct Users</h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the
value in the <code>x-user-id</code> header. Here, user <code>one</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>one</code>) will be rate limited at 3 requests/hour
and so will user <code>two</code> (recognised from the traffic flow using the header <code>x-user-id</code> and value <code>two</code>).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ratelimit-distinct-users
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - type: Distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: x-user-id
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute-1>HTTPRoute</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-distinct-users
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Lets run the same command again with the header <code>x-user-id</code> and value <code>one</code> set in the request. We should the first 3 requests succeeding and
the 4th request being rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><p>You should see the same behavior when the value for header <code>x-user-id</code> is set to <code>two</code> and 4 requests are sent.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h3 id=grpcroute-1>GRPCRoute</h3><p>Before proceeding, you should install the GRPCRoute example from <a href=grpc-routing.md>GRPC Routing</a>,
and be able to query the example backend using GRPC.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-distinct-users
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Lets run the same command again with the header <code>x-user-id</code> and value <code>one</code> set in the request. We should the first 3 requests succeeding and
the 4th request being rate limited.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com -H <span style=color:#4e9a06>&#34;x-user-id: one&#34;</span> <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span></code></pre></div><p>You should see the same behavior when the value for header <code>x-user-id</code> is set to <code>two</code> and 4 requests are sent.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com -H <span style=color:#4e9a06>&#34;x-user-id: two&#34;</span> <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>{
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  &#34;text&#34;: &#34;pong&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span></code></pre></div><h2 id=rate-limit-all-requests>Rate Limit All Requests</h2><p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code>clientSelectors</code> field unset.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ratelimit-all-requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=httproute-2>HTTPRoute</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-all-requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:31 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 4
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:32 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:33 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 460
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Wed, 08 Feb 2023 02:33:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h3 id=grpcroute-2>GRPCRoute</h3><p>Before proceeding, you should install the GRPCRoute example from <a href=grpc-routing.md>GRPC Routing</a>,
and be able to query the example backend using GRPC.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GRPCRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    example: grpc-routing
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - &#34;grpc-example.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: ServerReflectionInfo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        service: grpc.reflection.v1alpha.ServerReflection
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - method:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        method: Ping
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-all-requests
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: yages
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 9000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> grpcurl -plaintext -authority<span style=color:#ce5c00;font-weight:700>=</span>grpc-example.com <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>:80 yages.Echo/Ping <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>Error invoking method &#34;yages.Echo/Ping&#34;: rpc error: code = Unavailable desc = failed to query for service descriptor &#34;yages.Echo&#34;:
</span></span></span></code></pre></div><h2 id=rate-limit-client-ip-addresses>Rate Limit Client IP Addresses</h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on their
IP address (also reflected in the <code>X-Forwarded-For</code> header).</p><p>Note: EG supports two kinds of rate limit for the IP address: exact and distinct.</p><ul><li>exact means that all IP addresses within the specified Source IP CIDR share the same rate limit bucket.</li><li>distinct means that each IP address within the specified Source IP CIDR has its own rate limit bucket.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ratelimit-all-ips
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - sourceCIDR: 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: 0.0.0.0/0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          type: distinct
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: http-ratelimit
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-all-ips
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/get <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:45 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:46 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 512
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Tue, 28 Mar 2023 08:28:48 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h2 id=rate-limit-jwt-claims>Rate Limit Jwt Claims</h2><p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the value of the Jwt claims carried.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: AuthenticationFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: JWT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  jwtProviders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    remoteJWKS:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      uri: https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/jwks.json
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    claimToHeaders:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - claim: name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      header: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: ratelimit-specific-user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  type: Global
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  global:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - clientSelectors:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - headers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: x-claim-name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          value: John Doe
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      limit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        requests: 3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        unit: Hour
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: HTTPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  hostnames:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - ratelimit.example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      name: backend
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      weight: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    filters:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: AuthenticationFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: jwt-example
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - type: ExtensionRef
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      extensionRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        group: gateway.envoyproxy.io
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        kind: RateLimitFilter
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        name: ratelimit-specific-user
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matches:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - path:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: PathPrefix
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        value: /foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Get the JWT used for testing request authentication:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/test.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode -
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#000>TOKEN1</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>curl https://raw.githubusercontent.com/envoyproxy/gateway/main/examples/kubernetes/authn/with-different-claim.jwt -s<span style=color:#204a87;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> <span style=color:#000;font-weight:700>|</span> cut -d <span style=color:#4e9a06>&#39;.&#39;</span> -f2 - <span style=color:#000;font-weight:700>|</span> base64 --decode -
</span></span></code></pre></div><h3 id=rate-limit-by-carrying-token>Rate limit by carrying <code>TOKEN</code></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:25 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:26 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:27 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 561
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 429 Too Many Requests
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-ratelimited: true
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:00:28 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>transfer-encoding: chunked
</span></span></span></code></pre></div><h3 id=no-rate-limit-by-carrying-token1>No Rate Limit by carrying <code>TOKEN1</code></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> i in <span style=color:#ce5c00;font-weight:700>{</span>1..4<span style=color:#ce5c00;font-weight:700>}</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> curl -I --header <span style=color:#4e9a06>&#34;Host: ratelimit.example&#34;</span> --header <span style=color:#4e9a06>&#34;Authorization: Bearer </span><span style=color:#000>$TOKEN1</span><span style=color:#4e9a06>&#34;</span> http://<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span>/foo <span style=color:#000;font-weight:700>;</span> sleep 1<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:34 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:35 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:36 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-style:italic>HTTP/1.1 200 OK
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-type: application/json
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-content-type-options: nosniff
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>date: Mon, 12 Jun 2023 12:02:37 GMT
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>content-length: 556
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>x-envoy-upstream-service-time: 0
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>server: envoy
</span></span></span></code></pre></div><h3 id=optional-editing-kubernetes-resources-settings-for-the-rate-limit-service>(Optional) Editing Kubernetes Resources settings for the Rate Limit Service</h3><ul><li><p>The default installation of Envoy Gateway installs a default <a href=https://gateway.envoyproxy.io/latest/api/config_types.html#envoygateway>EnvoyGateway</a> configuration and provides the initial rate
limit kubernetes resources settings. such as <code>replicas</code> is 1, requests resources cpu is <code>100m</code>, memory is <code>512Mi</code>. the others
like container <code>image</code>, <code>securityContext</code>, <code>env</code> and pod <code>annotations</code> and <code>securityContext</code> can be modified by modifying the <code>ConfigMap</code>.</p></li><li><p><code>tls.certificateRef</code> set the client certificate for redis server TLS connections.</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ConfigMap
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: envoy-gateway-config
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  envoy-gateway.yaml: |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    apiVersion: config.gateway.envoyproxy.io/v1alpha1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: EnvoyGateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    provider:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      type: Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kubernetes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        rateLimitDeployment:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          container:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            image: envoyproxy/ratelimit:master
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: CACHE_KEY_PREFIX
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: &#34;eg:rl:&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            resources:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              requests:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                cpu: 100m
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                memory: 512Mi
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              allowPrivilegeEscalation: false
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          pod:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            annotations:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key1: val1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              key2: val2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            securityContext:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsUser: 1000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              runAsGroup: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroup: 2000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              fsGroupChangePolicy: &#34;OnRootMismatch&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    gateway:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    rateLimit:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      backend:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        type: Redis
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        redis:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          url: redis.redis-system.svc.cluster.local:6379
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          tls:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            certificateRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              name: ratelimit-cert
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><ul><li>After updating the <code>ConfigMap</code>, you will need to restart the <code>envoy-gateway</code> deployment so the configuration kicks in</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl rollout restart deployment envoy-gateway -n envoy-gateway-system
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c54214b1e943ca6b3a21b07767d41fdb>6.21 -</h1><h1 id=secure-gateways>Secure Gateways</h1><p>This guide will help you get started using secure Gateways. The guide uses a self-signed CA, so it should be used for
testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=tls-certificates>TLS Certificates</h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway from the Quickstart guide to include an HTTPS listener that listens on port <code>443</code> and references the
<code>example-cert</code> Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;https&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;port&#34;: 443,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;tls&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;mode&#34;: &#34;Terminate&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;certificateRefs&#34;: [{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;kind&#34;: &#34;Secret&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;group&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;name&#34;: &#34;example-cert&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        }],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing</h2><h3 id=clusters-without-external-loadbalancer-support>Clusters without External LoadBalancer Support</h3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get
</span></span></code></pre></div><h3 id=clusters-with-external-loadbalancer-support>Clusters with External LoadBalancer Support</h3><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div><h2 id=multiple-https-listeners>Multiple HTTPS Listeners</h2><p>Create a TLS cert/key for the additional HTTPS listener:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out foo.example.com.csr -newkey rsa:2048 -nodes -keyout foo.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=foo.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in foo.example.com.csr -out foo.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls foo-cert --key<span style=color:#ce5c00;font-weight:700>=</span>foo.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>foo.example.com.crt
</span></span></code></pre></div><p>Create another HTTPS listener on the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;https-foo&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;protocol&#34;: &#34;HTTPS&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;port&#34;: 443,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;hostname&#34;: &#34;foo.example.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;tls&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;mode&#34;: &#34;Terminate&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        &#34;certificateRefs&#34;: [{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;kind&#34;: &#34;Secret&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;group&#34;: &#34;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          &#34;name&#34;: &#34;foo-cert&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        }],
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Update the HTTPRoute to route traffic for hostname <code>foo.example.com</code> to the example backend service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch httproute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/hostnames/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: &#34;foo.example.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Follow the steps in the <a href=#testing>Testing section</a> to test connectivity to the backend app through both Gateway
listeners. Replace <code>www.example.com</code> with <code>foo.example.com</code> to test the new HTTPS listener.</p><h2 id=cross-namespace-certificate-references>Cross Namespace Certificate References</h2><p>A Gateway can be configured to reference a certificate in a different namespace. This is allowed by a <a href=https://gateway-api.sigs.k8s.io/api-types/referencegrant/>ReferenceGrant</a>
created in the target namespace. Without the ReferenceGrant, a cross-namespace reference is invalid.</p><p>Before proceeding, ensure you can query the HTTPS backend service from the <a href=#testing>Testing section</a>.</p><p>To demonstrate cross namespace certificate references, create a ReferenceGrant that allows Gateways from the &ldquo;default&rdquo;
namespace to reference Secrets in the &ldquo;envoy-gateway-system&rdquo; namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> cat &lt;&lt;EOF <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ReferenceGrant
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: example
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  from:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  - group: gateway.networking.k8s.io
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    namespace: default
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  to:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  - group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><p>Delete the previously created Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/example-cert
</span></span></code></pre></div><p>The Gateway HTTPS listener should now surface the <code>Ready: False</code> status condition and the example HTTPS backend should
no longer be reachable through the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><p>Recreate the example Secret in the <code>envoy-gateway-system</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert -n envoy-gateway-system --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Update the Gateway HTTPS listener with <code>namespace: envoy-gateway-system</code>, for example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> cat &lt;&lt;EOF <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      protocol: HTTP
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      port: 80
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - name: https
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      port: 443
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      tls:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            group: &#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            name: example-cert
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            namespace: envoy-gateway-system
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><p>The Gateway HTTPS listener status should now surface the <code>Ready: True</code> condition and you should once again be able to
query the HTTPS backend through the Gateway.</p><p>Lastly, test connectivity using the above <a href=#testing>Testing section</a>.</p><h2 id=clean-up>Clean-Up</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the Secrets:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/example-cert
</span></span><span style=display:flex><span>kubectl delete secret/foo-cert
</span></span></code></pre></div><h1 id=rsa--ecdsa-dual-stack-certificates>RSA + ECDSA Dual stack certificates</h1><p>This section gives a walkthrough to generate RSA and ECDSA derived certificates and keys for the Server, which can then be configured in the Gateway listener, to terminate TLS traffic.</p><h2 id=prerequisites-1>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Follow the steps in the <a href=secure-gateways.md#tls-certificates>TLS Certificates</a> section in the guide to generate self-signed RSA derived Server certificate and private key, and configure those in the Gateway listener configuration to terminate HTTPS traffic.</p><h2 id=pre-checks>Pre-checks</h2><p>While testing in <a href=secure-gateways.md#clusters-without-external-loadbalancer-support>Cluster without External LoadBalancer Support</a>, we can query the example app through Envoy proxy while enforcing an RSA cipher, as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-RSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><p>Since the Secret configured at this point is an RSA based Secret, if we enforce the usage of an ECDSA cipher, the call should fail as follows</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-ECDSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>* Added www.example.com:8443:127.0.0.1 to DNS cache
</span></span><span style=display:flex><span>* Hostname www.example.com was found in DNS cache
</span></span><span style=display:flex><span>*   Trying 127.0.0.1:8443...
</span></span><span style=display:flex><span>* Connected to www.example.com <span style=color:#ce5c00;font-weight:700>(</span>127.0.0.1<span style=color:#ce5c00;font-weight:700>)</span> port <span style=color:#0000cf;font-weight:700>8443</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>#0)</span>
</span></span><span style=display:flex><span>* ALPN: offers h2
</span></span><span style=display:flex><span>* ALPN: offers http/1.1
</span></span><span style=display:flex><span>* Cipher selection: ECDHE-ECDSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>*  CAfile: example.com.crt
</span></span><span style=display:flex><span>*  CApath: none
</span></span><span style=display:flex><span>* <span style=color:#ce5c00;font-weight:700>(</span>304<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>OUT<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Client hello <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* error:1404B410:SSL routines:ST_CONNECT:sslv3 alert handshake failure
</span></span><span style=display:flex><span>* Closing connection <span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>Moving forward in the doc, we will be configuring the existing Gateway listener to accept both kinds of ciphers.</p><h2 id=tls-certificates-1>TLS Certificates</h2><p>Reuse the the CA certificate and key pair generated in the <a href=secure-gateways.md#tls-certificates>Secure Gateways</a> guide and use this CA to sign both RSA and ECDSA Server certificates.
Note the CA certificate and key names are <code>example.com.crt</code> and <code>example.com.key</code> respectively.</p><p>Create an ECDSA certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl ecparam -noout -genkey -name prime256v1 -out www.example.com.ecdsa.key
</span></span><span style=display:flex><span>openssl req -new -SHA384 -key www.example.com.ecdsa.key -nodes -out www.example.com.ecdsa.csr -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -SHA384  -days <span style=color:#0000cf;font-weight:700>365</span> -in www.example.com.ecdsa.csr -CA example.com.crt -CAkey example.com.key -CAcreateserial -out www.example.com.ecdsa.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert-ecdsa --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.ecdsa.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.ecdsa.crt
</span></span></code></pre></div><p>Patch the Gateway with this additional ECDSA Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/1/tls/certificateRefs/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;example-cert-ecdsa&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing-1>Testing</h2><p>Again, while testing in Cluster without External LoadBalancer Support, we can query the example app through Envoy proxy while enforcing an RSA cipher, which should work as it did before:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-RSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS change cipher, Change cipher spec <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Finished <span style=color:#ce5c00;font-weight:700>(</span>20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* SSL connection using TLSv1.2 / ECDHE-RSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Additionally, querying the example app while enforcing an ECDSA cipher should also work now:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get  -Isv --ciphers ECDHE-ECDSA-CHACHA20-POLY1305 --tlsv1.2 --tls-max 1.2
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS change cipher, Change cipher spec <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* TLSv1.2 <span style=color:#ce5c00;font-weight:700>(</span>IN<span style=color:#ce5c00;font-weight:700>)</span>, TLS handshake, Finished <span style=color:#ce5c00;font-weight:700>(</span>20<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>* SSL connection using TLSv1.2 / ECDHE-ECDSA-CHACHA20-POLY1305
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h1 id=sni-based-certificate-selection>SNI based Certificate selection</h1><p>This sections gives a walkthrough to generate multiple certificates corresponding to different FQDNs. The same Gateway listener can then be configured to terminate TLS traffic for multiple FQDNs based on the SNI matching.</p><h2 id=prerequisites-2>Prerequisites</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><p>Follow the steps in the <a href=secure-gateways.md#tls-certificates>TLS Certificates</a> section in the guide to generate self-signed RSA derived Server certificate and private key, and configure those in the Gateway listener configuration to terminate HTTPS traffic.</p><h2 id=additional-configurations>Additional Configurations</h2><p>Using the <a href=secure-gateways.md#tls-certificates>TLS Certificates</a> section in the guide we first generate additional Secret for another Host <code>www.sample.com</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=sample Inc./CN=sample.com&#39;</span> -keyout sample.com.key -out sample.com.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl req -out www.sample.com.csr -newkey rsa:2048 -nodes -keyout www.sample.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.sample.com/O=sample organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA sample.com.crt -CAkey sample.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.sample.com.csr -out www.sample.com.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl create secret tls sample-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.sample.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.sample.com.crt
</span></span></code></pre></div><p>Note that all occurrences of <code>example.com</code> were just replaced with <code>sample.com</code></p><p>Next we update the <code>Gateway</code> configuration to accommodate the new Certificate which will be used to Terminate TLS traffic:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/1/tls/certificateRefs/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;sample-cert&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Finally, we update the HTTPRoute to route traffic for hostname <code>www.sample.com</code> to the example backend service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch httproute backend --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;path&#34;: &#34;/spec/hostnames/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  &#34;value&#34;: &#34;www.sample.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><h2 id=testing-2>Testing</h2><h3 id=clusters-without-external-loadbalancer-support-1>Clusters without External LoadBalancer Support</h3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get -I
</span></span></code></pre></div><p>Similarly, query the sample app through the same Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.sample.com --resolve <span style=color:#4e9a06>&#34;www.sample.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert sample.com.crt https://www.sample.com:8443/get -I
</span></span></code></pre></div><p>Since the multiple certificates are configured on the same Gateway listener, Envoy was able to provide the client with appropriate certificate based on the SNI in the client request.</p><h3 id=clusters-with-external-loadbalancer-support-1>Clusters with External LoadBalancer Support</h3><p>Refer to the steps mentioned earlier in the guide under <a href=secure-gateways.md#clusters-with-external-loadbalancer-support>Testing in clusters with External LoadBalancer Support</a></p><h2 id=next-steps>Next Steps</h2><p>Checkout the <a href=../dev/README.md>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f234061010e2f904c0c0e87e38a46d80>6.22 -</h1><h1 id=tcp-routing>TCP Routing</h1><p><a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.TCPRoute>TCPRoute</a> provides a way to route TCP requests. When combined with a Gateway listener, it can be used to forward
connections on the port specified by the listener to a set of backends specified by the TCPRoute. To learn more about
HTTP routing, refer to the <a href=https://gateway-api.sigs.k8s.io/>Gateway API documentation</a>.</p><h2 id=installation>Installation</h2><p>Install Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><h2 id=configuration>Configuration</h2><p>In this example, we have one Gateway resource and two TCPRoute resources that distribute the traffic with the following
rules:</p><p>All TCP streams on port <code>8088</code> of the Gateway are forwarded to port 3001 of <code>foo</code> Kubernetes Service.
All TCP streams on port <code>8089</code> of the Gateway are forwarded to port 3002 of <code>bar</code> Kubernetes Service.
In this example two TCP listeners will be applied to the Gateway in order to route them to two separate backend
TCPRoutes, note that the protocol set for the listeners on the Gateway is TCP:</p><p>Install the GatewayClass and a <code>tcp-gateway</code> Gateway first.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GatewayClass
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  controllerName: gateway.envoyproxy.io/gatewayclass-controller
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1beta1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  gatewayClassName: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8088
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    protocol: TCP
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    port: 8089
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allowedRoutes:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      kinds:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      - kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Install two services <code>foo</code> and <code>bar</code>, which are binded to <code>backend-1</code> and <code>backend-2</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Service
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: http
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      targetPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: apps/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Deployment
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  replicas: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selector:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    matchLabels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  template:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      labels:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        app: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        version: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      containers:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - image: gcr.io/k8s-staging-ingressconformance/echoserver:v20221109-7ee2f3e
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          imagePullPolicy: IfNotPresent
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          name: backend-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          ports:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - containerPort: 3000
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          env:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: POD_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.name
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: NAMESPACE
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              valueFrom:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                fieldRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>                  fieldPath: metadata.namespace
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            - name: SERVICE_NAME
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>              value: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Install two TCPRoutes <code>tcp-app-1</code> and <code>tcp-app-2</code> with different <code>sectionName</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: foo
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3001
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>---
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: TCPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: tcp-app-2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - name: tcp-gateway
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    sectionName: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: bar
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      port: 3002
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>In the above example we separate the traffic for the two separate backend TCP Services by using the sectionName field in
the parentRefs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>parentRefs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>tcp-gateway</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>sectionName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This corresponds directly with the name in the listeners in the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>listeners</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8088</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>protocol</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TCP</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8089</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>In this way each TCPRoute &ldquo;attaches&rdquo; itself to a different port on the Gateway so that the <code>foo</code> service
is taking traffic for port <code>8088</code> from outside the cluster and <code>bar</code> service takes the port <code>8089</code> traffic.</p><p>Before testing, please get the tcp-gateway Gateway&rsquo;s address first:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/tcp-gateway -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>You can try to use nc to test the TCP connections of envoy gateway with different ports, and you can see them succeeded:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8088</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nc -zv <span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> <span style=color:#0000cf;font-weight:700>8089</span>
</span></span></code></pre></div><p>You can also try to send requests to envoy gateway and get responses as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8088&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:18:36 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8088&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;foo&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-1-c6c5fb958-dl8vl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>You can see that the traffic routing to <code>foo</code> service when sending request to <code>8088</code> port.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -i <span style=color:#4e9a06>&#34;http://</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>:8089&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>X-Content-Type-Options: nosniff
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#0000cf;font-weight:700>03</span> Jan <span style=color:#0000cf;font-weight:700>2023</span> 10:19:28 GMT
</span></span><span style=display:flex><span>Content-Length: <span style=color:#0000cf;font-weight:700>267</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;path&#34;</span>: <span style=color:#4e9a06>&#34;/&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;host&#34;</span>: <span style=color:#4e9a06>&#34;xxx.xxx.xxx.xxx:8089&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;method&#34;</span>: <span style=color:#4e9a06>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;proto&#34;</span>: <span style=color:#4e9a06>&#34;HTTP/1.1&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;headers&#34;</span>: <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;Accept&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;*/*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;User-Agent&#34;</span>: <span style=color:#ce5c00;font-weight:700>[</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;curl/7.85.0&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span> <span style=color:#ce5c00;font-weight:700>}</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;namespace&#34;</span>: <span style=color:#4e9a06>&#34;default&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;ingress&#34;</span>: <span style=color:#4e9a06>&#34;&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;service&#34;</span>: <span style=color:#4e9a06>&#34;bar&#34;</span>,
</span></span><span style=display:flex><span> <span style=color:#4e9a06>&#34;pod&#34;</span>: <span style=color:#4e9a06>&#34;backend-2-98fcff498-hcmgb&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>                                            
</span></span></code></pre></div><p>You can see that the traffic routing to <code>bar</code> service when sending request to <code>8089</code> port.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-909f112ee4921602d610f2121d35774d>6.23 -</h1><h1 id=using-cert-manager-for-tls-termination>Using cert-manager For TLS Termination</h1><p>This guide shows how to set up <a href=https://cert-manager.io/>cert-manager</a> to automatically create certificates and secrets for use by Envoy Gateway.
It will first show how to enable the self-sign issuer, which is useful to test that cert-manager and Envoy Gateway can talk to each other.
Then it shows how to use <a href=https://letsencrypt.org/docs/staging-environment/>Let&rsquo;s Encrypt&rsquo;s staging environment</a>.
Changing to the Let&rsquo;s Encrypt production environment is straight-forward after that.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>A Kubernetes cluster and a configured <code>kubectl</code>.</li><li>The <code>helm</code> command.</li><li>The <code>curl</code> command or similar for testing HTTPS requests.</li><li>For the ACME HTTP-01 challenge to work<ul><li>your Gateway must be reachable on the public Internet.</li><li>the domain name you use (we use <code>www.example.com</code>) must point to the Gateway&rsquo;s external IP(s).</li></ul></li></ul><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=deploying-cert-manager>Deploying cert-manager</h2><p><em>This is a summary of <a href=https://cert-manager.io/docs/installation/helm/>cert-manager Installation with Helm</a>.</em></p><p>Installing cert-manager is straight-forward, but currently (v1.12) requires setting a feature gate to enable the Gateway API support.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> helm repo add jetstack https://charts.jetstack.io
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> helm upgrade --install --create-namespace --namespace cert-manager --set <span style=color:#000>installCRDs</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --set <span style=color:#000>featureGates</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ExperimentalGatewayAPISupport</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> cert-manager jetstack/cert-manager
</span></span></code></pre></div><p>You should now have <code>cert-manager</code> running with nothing to do:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available deployment -n cert-manager --all
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager-cainjector condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>deployment.apps/cert-manager-webhook condition met
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> kubectl get -n cert-manager deployment
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager              1/1     1            1           42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager-cainjector   1/1     1            1           42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>cert-manager-webhook      1/1     1            1           42m
</span></span></span></code></pre></div><h2 id=a-self-signing-issuer>A Self-Signing Issuer</h2><p>cert-manager can have any number of <em>issuer</em> configurations.
The simplest issuer type is <a href=https://cert-manager.io/docs/configuration/selfsigned/>SelfSigned</a>.
It simply takes the certificate request and signs it with the private key it generates for the TLS Secret.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Self-signed certificates don<span style=color:#a40000>&#39;</span>t provide any <span style=color:#204a87>help</span> in establishing trust between certificates.
</span></span><span style=display:flex><span>However, they are great <span style=color:#204a87;font-weight:700>for</span> initial testing, due to their simplicity.
</span></span></code></pre></div><p>To install self-signing, run</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  selfSigned: {}
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><h2 id=creating-a-tls-gateway-listener>Creating a TLS Gateway Listener</h2><p>We now have to patch the example Gateway to reference cert-manager:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl patch gateway/eg --patch-file - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  annotations:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    cert-manager.io/clusterissuer: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    cert-manager.io/common-name: &#34;Hello World!&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  listeners:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  - name: https
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    protocol: HTTPS
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    hostname: www.example.com
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    port: 443
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    tls:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      mode: Terminate
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      certificateRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      - kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        name: eg-https
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>EOF
</span></span></span></code></pre></div><p>You could instead create a new Gateway serving HTTPS, if you&rsquo;d prefer.
cert-manager doesn&rsquo;t care, but we&rsquo;ll keep it all together in this guide.</p><p>Nowadays, X.509 certificates don&rsquo;t use the subject Common Name for hostname matching, so you can set it to whatever you want, or leave it empty.
The important parts here are</p><ul><li>the annotation referencing the &ldquo;selfsigned&rdquo; ClusterIssuer we created above,</li><li>the <code>hostname</code>, which is required (but see <a href=https://github.com/cert-manager/cert-manager/issues/6051>#6051</a> for computing it based on attached HTTPRoutes), and</li><li>the named Secret, which is what cert-manager will create for us.</li></ul><p>The annotations are documented in <a href=https://cert-manager.io/docs/usage/gateway/#supported-annotations>Supported Annotations</a>.</p><p>Patching the Gateway makes cert-manager create a self-signed certificate within a few seconds.
Eventually, the Gateway becomes <code>Programmed</code> again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Programmed gateway/eg
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>gateway.gateway.networking.k8s.io/eg condition met
</span></span></span></code></pre></div><h3 id=testing-the-gateway>Testing The Gateway</h3><p>See <a href=secure-gateways.md#testing>Testing in Secure Gateways</a> for the general idea.</p><p>Since we have a self-signed certificate, <code>curl</code> will by default reject it, requiring the <code>-k</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -kv -HHost:www.example.com https://127.0.0.1/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h3 id=how-cert-manager-and-envoy-gateway-interact>How cert-manager and Envoy Gateway Interact</h3><p><em>This explains <a href=https://cert-manager.io/docs/concepts/>cert-manager Concepts</a> in an Envoy Gateway context.</em></p><p>In the interaction between the two, cert-manager does all the heavy lifting.
It subscribes to changes to Gateway resources (using the <a href=https://github.com/cert-manager/cert-manager/tree/master/pkg/controller/certificate-shim/gateways><code>gateway-shim</code> component</a>.)
For any Gateway it finds, it looks for any <a href=https://gateway-api.sigs.k8s.io/guides/tls/#listeners-and-tls>TLS listeners</a>, and the associated <code>tls.certificateRefs</code>.
Note that while Gateway API supports multiple refs here, Envoy Gateway only uses one.
cert-manager also looks at the <code>hostname</code> of the listener to figure out which hosts the certificate is expected to cover.
More than one listener can use the same certificate Secret, which means cert-manager needs to find all listeners using the same Secret before deciding what to do.
If the <code>certificatRef</code> points to a valid certificate, given the hostnames found in listeners, cert-manager has nothing to do.</p><p>If there is no valid certificate, or it is about to expire, cert-manager&rsquo;s <code>gateway-shim</code> creates a Certificate resource, or updates the existing one.
cert-manager then follows the <a href=https://cert-manager.io/docs/concepts/certificate/#certificate-lifecycle>Certificate Lifecycle</a>.
To know how to issue the certificate, an ClusterIssuer is configured, and referenced through annotations on the Gateway resource, which you did above.
Once a matching ClusterIssuer is found, that plugin does what needs to be done to acquire a signed certificate.</p><p>In the case of the ACME protocol (used by Let&rsquo;s Encrypt,) cert-manager can also use an HTTP Gateway to solve the HTTP-01 challenge type.
This is the other side of cert-manager&rsquo;s Gateway API support:
the <a href=https://github.com/cert-manager/cert-manager/tree/master/pkg/issuer/acme/http/httproute.go>ACME issuer</a> creates a temporary <a href=https://gateway-api.sigs.k8s.io/api-types/httproute/>HTTPRoute</a>, lets the ACME server(s) query it, and deletes it again.</p><p>cert-manager then updates the Secret that the Gateway&rsquo;s listener points to in <code>tls.certificateRefs</code>.
Envoy Gateway picks up that the Secret has changed, and reloads the corresponding Envoy Proxy Deployments with the new private key and certificate.</p><p>As you can imagine, cert-manager requires quite broad permissions to update Secrets in any namespace, so the security-minded reader may want to look at the RBAC resources the Helm chart creates.</p><h2 id=using-the-acme-issuer-with-lets-encrypt-and-http-01>Using the ACME Issuer With Let&rsquo;s Encrypt and HTTP-01</h2><p>We will start using the Let&rsquo;s Encrypt staging environment, to spare their production environment.
Our Gateway already contains an HTTP listener, so we will use that for the HTTP-01 challenges.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> <span style=color:#000>CERT_MANAGER_CONTACT_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>git config user.email<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Or whatever...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: letsencrypt-staging
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    server: https://acme-staging-v02.api.letsencrypt.org/directory
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    email: &#34;$CERT_MANAGER_CONTACT_EMAIL&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    privateKeySecretRef:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      name: letsencrypt-staging-account-key
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    solvers:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - http01:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        gatewayHTTPRoute:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          - kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            name: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            namespace: default
</span></span></span></code></pre></div><p>The important parts are</p><ul><li>using <code>spec.acme</code> with a server URI and contact email address, and</li><li>referencing our plain HTTP gateway so the challenge HTTPRoute is attached to the right place.</li></ul><p>Check the account registration process using the Ready condition:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl <span style=color:#204a87>wait</span> --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Ready clusterissuer/letsencrypt-staging
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl describe clusterissuer/letsencrypt-staging
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Status:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Uri:                   https://acme-staging-v02.api.letsencrypt.org/acme/acct/123456789
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Conditions:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Message:               The ACME account was registered with the ACME server
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Reason:                ACMEAccountRegistered
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Status:                True
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Type:                  Ready
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Now we&rsquo;re ready to update the Gateway annotation to use this issuer instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl annotate --overwrite gateway/eg cert-manager.io/clusterissuer<span style=color:#ce5c00;font-weight:700>=</span>letsencrypt-staging
</span></span></code></pre></div><p>The Gateway should be picked up by cert-manager, which will create a new certificate for you, and replace the Secret.</p><p>You should see a new CertificateRequest to track:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificaterequest
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME             APPROVED   DENIED   READY   ISSUER                REQUESTOR                                         AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https-xxxxx   True                True    selfsigned            system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https-xxxxx   True                True    letsencrypt-staging   system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span></code></pre></div><h3 id=testing-the-gateway-1>Testing The Gateway</h3><p>We still require the <code>-k</code> flag, since the Let&rsquo;s Encrypt staging environment CA is not widely trusted.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -kv -HHost:www.example.com https://127.0.0.1/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  issuer: C=US; O=(STAGING) Let&#39;s Encrypt; CN=(STAGING) Ersatz Edamame E1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=using-the-lets-encrypt-production-environment>Using The Let&rsquo;s Encrypt Production Environment</h2><p>Changing to the production environment is just a matter of replacing the server URI:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> <span style=color:#000>CERT_MANAGER_CONTACT_EMAIL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>git config user.email<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># Or whatever...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl apply -f - &lt;&lt;EOF
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>metadata:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  name: letsencrypt
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>spec:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  acme:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    server: https://acme-v02.api.letsencrypt.org/directory  # Removed &#34;-staging&#34;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    email: &#34;$CERT_MANAGER_CONTACT_EMAIL&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    privateKeySecretRef:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      name: letsencrypt-account-key                         # Removed &#34;-staging&#34;.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    solvers:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    - http01:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>        gatewayHTTPRoute:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>          - kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            name: eg
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>            namespace: default
</span></span></span></code></pre></div><p>And now you can update the Gateway listener to point to <code>letsencrypt</code> instead:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl annotate --overwrite gateway/eg cert-manager.io/clusterissuer<span style=color:#ce5c00;font-weight:700>=</span>letsencrypt
</span></span></code></pre></div><p>As before, track it by looking at CertificateRequests.</p><h3 id=testing-the-gateway-2>Testing The Gateway</h3><p>Once the certificate has been replaced, we should finally be able to get rid of the <code>-k</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> curl -v -HHost:www.example.com --resolve www.example.com:127.0.0.1 https://www.example.com/get
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>* Server certificate:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  subject: CN=Hello World!
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>*  issuer: C=US; O=Let&#39;s Encrypt; CN=R3
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>&lt; HTTP/2 200
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><h2 id=collecting-garbage>Collecting Garbage</h2><p>You probably want to set the <code>cert-manager.io/revision-history-limit</code> annotation on your Gateway to make cert-manager prune the CertificateRequest history.</p><p>cert-manager <a href=https://github.com/cert-manager/cert-manager/blob/c5e6bf39d688d202592318eaf91988466a7ee37b/pkg/controller/certificate-shim/sync.go#L171>deletes unused Certificate resources</a>, and they are updated in-place when possible, so there should be no need for cleaning up Certificate resources.
The deletion is based on whether a Gateway still holds a <code>tls.certificateRefs</code> that requires the Certificate.</p><p>If you remove a TLS listener from a Gateway, you may still have a Secret lingering.
cert-manager can clean it up using <a href=https://cert-manager.io/docs/usage/certificate/#cleaning-up-secrets-when-certificates-are-deleted>a flag</a>.</p><h2 id=issuer-namespaces>Issuer Namespaces</h2><p>We have used ClusterIssuer resources in this tutorial.
They are not bound to any namespace, and will read annotations from Gateways in any namespace.
You could also use <a href=https://cert-manager.io/docs/concepts/issuer/>Issuer</a>, which is bound to a namespace.
This is useful e.g. if you want to use different ACME accounts for different namespaces.</p><p>If you change the issuer kind, you also need to change the annotation key from <code>cert-manager.io/clusterissuer</code> to <code>cert-manager.io/issuer</code>.</p><h2 id=using-externaldns>Using ExternalDNS</h2><p>The <a href=https://kubernetes-sigs.github.io/external-dns/latest/>ExternalDNS</a> controller maintains DNS records based on Kubernetes resources.
Together with cert-manager, this can be used to fully automate hostname management.
It can use various source resources, among them Gateway Routes.
Just specify a Gateway Route resource, let ExternalDNS create the domain records, and then cert-manager the TLS certificate.</p><p><a href=https://kubernetes-sigs.github.io/external-dns/latest/tutorials/gateway-api/>The tutorial on Gateway API</a> uses kubectl.
They also have a <a href=https://github.com/kubernetes-sigs/external-dns/blob/master/charts/external-dns/README.md>Helm chart</a>, which is easier to customize.
The only thing relevant to Envoy Gateway is to set the sources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># values.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>sources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-httproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-grpcroute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-tcproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-tlsroute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>gateway-udproute</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=monitoring-progress--troubleshooting>Monitoring Progress / Troubleshooting</h2><p>You can monitor progress in several ways:</p><p>The Issuer has a Ready condition (though this is rather <a href=https://github.com/cert-manager/cert-manager/blob/c5e6bf39d688d202592318eaf91988466a7ee37b/pkg/issuer/selfsigned/setup.go#L32>boring</a> for the <code>selfSigned</code> type):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get issuer --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME         READY   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     selfsigned   True    42m
</span></span></span></code></pre></div><p>The Gateway will say when it has an invalid certificate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl describe gateway/eg
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>    Conditions:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Message:               Secret default/eg-https does not exist.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Reason:                InvalidCertificateRef
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Status:                False
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Type:                  ResolvedRefs
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Message:               Listener is invalid, see other Conditions for details.
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Reason:                Invalid
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Status:                False
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>      Type:                  Programmed
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>Events:
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Type     Reason     Age    From                       Message
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  ----     ------     ----   ----                       -------
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>  Warning  BadConfig  42m    cert-manager-gateway-shim  Skipped a listener block: spec.listeners[1].hostname: Required value: the hostname cannot be empty
</span></span></span></code></pre></div><p>The main question is if cert-manager has picked up on the Gateway.
I.e., has it created a Certificate for it?
The above <code>describe</code> contains an event from <code>cert-manager-gateway-shim</code> telling you of one such issue.
Be aware that if you have a non-TLS listener in the Gateway, like we did, there will be events saying it is not eligible, which is of course expected.</p><p>Another option is looking at Deployment logs.
The cert-manager logs are not very verbose by default, but setting the Helm value <code>global.logLevel</code> to 6 will enable all debug logs (the default is 2.)
This will make them verbose enough to say why a Gateway wasn&rsquo;t considered (e.g. missing <code>hostname</code>, or <code>tls.mode</code> is not <code>Terminate</code>.)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl logs -n cert-manager deployment/cert-manager
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>...
</span></span></span></code></pre></div><p>Simply listing Certificate resources may be useful, even if it just gives a yes/no answer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificate --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME       READY   SECRET     AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     eg-https   True    eg-https   42m
</span></span></span></code></pre></div><p>If there is a Certificate, then the <code>gateway-shim</code> has recognized the Gateway.
But is there a CertificateRequest for it?
(BTW, don&rsquo;t confuse this with a CertificateSigningRequest, which is a Kubernetes core resource type representing the same thing.)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get certificaterequest --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAMESPACE   NAME             APPROVED   DENIED   READY   ISSUER       REQUESTOR                                         AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>default     eg-https-xxxxx   True                True    selfsigned   system:serviceaccount:cert-manager:cert-manager   42m
</span></span></span></code></pre></div><p>The ACME issuer also has <code>Order</code> and <code>Challenge</code> resources to watch:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get order --all-namespaces -o wide
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                     STATE     ISSUER                REASON   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>order.acme.cert-manager.io/envoy-https-xxxxx-123456789   pending   letsencrypt-staging            42m
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902>$</span> kubectl get challenge --all-namespaces
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                                    STATE     DOMAIN            AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>challenge.acme.cert-manager.io/envoy-https-xxxxx-123456789-1234567890   pending   www.example.com   42m
</span></span></span></code></pre></div><p>Using <code>kubetctl get -o wide</code> or <code>kubectl describe</code> on the Challenge will explain its state more.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get order --all-namespaces -o wide
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME                                                     STATE   ISSUER                REASON   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>order.acme.cert-manager.io/envoy-https-xxxxx-123456789   valid   letsencrypt-staging            42m
</span></span></span></code></pre></div><p>Finally, since cert-manager creates the Secret referenced by the Gateway listener as its last step, we can also look for that:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#8f5902>$</span> kubectl get secret secret/eg-https
</span></span><span style=display:flex><span><span style=color:#000;font-style:italic>NAME       TYPE                DATA   AGE
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>eg-https   kubernetes.io/tls   3      42m
</span></span></span></code></pre></div><h2 id=clean-up>Clean Up</h2><ul><li>Uninstall cert-manager: <code>helm uninstall --namespace cert-manager cert-manager</code></li><li>Delete the <code>cert-manager</code> namespace: <code>kubectl delete namespace/cert-manager</code></li><li>Delete the <code>https</code> listener from <code>gateway/eg</code>.</li><li>Delete <code>secret/eg-https</code>.</li></ul><h2 id=see-also>See Also</h2><ul><li><a href=secure-gateways.md>Secure Gateways</a></li><li><a href=https://cert-manager.io/docs/usage/gateway/>Securing gateway.networking.k8s.io Gateway Resources</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff91cb685ccd7cc62af7de11a3c6b299>6.24 -</h1><h1 id=tls-passthrough>TLS Passthrough</h1><p>This guide will walk through the steps required to configure TLS Passthrough via Envoy Gateway. Unlike configuring
Secure Gateways, where the Gateway terminates the client TLS connection, TLS Passthrough allows the application itself
to terminate the TLS connection, while the Gateway routes the requests to the application based on SNI headers.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p><h2 id=tls-certificates>TLS Certificates</h2><p>Generate the certificates and keys used by the Service to terminate client TLS connections.
For the application, we&rsquo;ll deploy a sample echoserver app, with the certificates loaded in the application Pod.</p><p><strong>Note:</strong> These certificates will not be used by the Gateway, but will remain in the application scope.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>passthrough.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out passthrough.example.com.csr -newkey rsa:2048 -nodes -keyout passthrough.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=passthrough.example.com/O=some organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -sha256 -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in passthrough.example.com.csr -out passthrough.example.com.crt
</span></span></code></pre></div><p>Store the cert/keys in A Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls server-certs --key<span style=color:#ce5c00;font-weight:700>=</span>passthrough.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>passthrough.example.com.crt
</span></span></code></pre></div><h2 id=deployment>Deployment</h2><p>Deploy TLS Passthrough application Deployment, Service and TLSRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/tls-passthrough.yaml
</span></span></code></pre></div><p>Patch the Gateway from the Quickstart guide to include a TLS listener that listens on port <code>6443</code> and is configured for
TLS mode Passthrough:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;tls&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;protocol&#34;: &#34;TLS&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;hostname&#34;: &#34;passthrough.example.com&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;tls&#34;: {&#34;mode&#34;: &#34;Passthrough&#34;}, 
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;port&#34;: 6443,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><h2 id=testing>Testing</h2><h3 id=clusters-without-external-loadbalancer-support>Clusters without External LoadBalancer Support</h3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 6043:6443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Curl the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v --resolve <span style=color:#4e9a06>&#34;passthrough.example.com:6043:127.0.0.1&#34;</span> https://passthrough.example.com:6043 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert passthrough.example.com.crt
</span></span></code></pre></div><h3 id=clusters-with-external-loadbalancer-support>Clusters with External LoadBalancer Support</h3><p>You can also test the same functionality by sending traffic to the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Curl the example app through the Gateway, e.g. Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:passthrough.example.com --resolve <span style=color:#4e9a06>&#34;passthrough.example.com:6443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://passthrough.example.com:6443/get
</span></span></code></pre></div><h2 id=clean-up>Clean-Up</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to uninstall Envoy Gateway and the example manifest.</p><p>Delete the Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete secret/server-certs
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><p>Checkout the <a href=../dev/README.md>Developer Guide</a> to get involved in the project.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b6105b58120b01aad817fd8d1eee631>6.25 -</h1><h1 id=tls-termination-for-tcp>TLS Termination for TCP</h1><p>This guide will walk through the steps required to configure TLS Terminate mode for TCP traffic via Envoy Gateway. The guide uses a self-signed CA, so it should be used for testing and demonstration purposes only.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>OpenSSL to generate TLS assets.</li></ul><h2 id=installation>Installation</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to install Envoy Gateway.</p><h2 id=tls-certificates>TLS Certificates</h2><p>Generate the certificates and keys used by the Gateway to terminate client TLS connections.</p><p>Create a root certificate and private key to sign certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -x509 -sha256 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -subj <span style=color:#4e9a06>&#39;/O=example Inc./CN=example.com&#39;</span> -keyout example.com.key -out example.com.crt
</span></span></code></pre></div><p>Create a certificate and a private key for <code>www.example.com</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>openssl req -out www.example.com.csr -newkey rsa:2048 -nodes -keyout www.example.com.key -subj <span style=color:#4e9a06>&#34;/CN=www.example.com/O=example organization&#34;</span>
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#0000cf;font-weight:700>365</span> -CA example.com.crt -CAkey example.com.key -set_serial <span style=color:#0000cf;font-weight:700>0</span> -in www.example.com.csr -out www.example.com.crt
</span></span></code></pre></div><p>Store the cert/key in a Secret:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl create secret tls example-cert --key<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.key --cert<span style=color:#ce5c00;font-weight:700>=</span>www.example.com.crt
</span></span></code></pre></div><p>Install the TLS Termination for TCP example resources:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/tls-termination.yaml
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=testing>Testing</h2><h3 id=clusters-without-external-loadbalancer-support>Clusters without External LoadBalancer Support</h3><p>Get the name of the Envoy service created the by the example Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ENVOY_SERVICE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get svc -n envoy-gateway-system --selector<span style=color:#ce5c00;font-weight:700>=</span>gateway.envoyproxy.io/owning-gateway-namespace<span style=color:#ce5c00;font-weight:700>=</span>default,gateway.envoyproxy.io/owning-gateway-name<span style=color:#ce5c00;font-weight:700>=</span>eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.items[0].metadata.name}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Port forward to the Envoy service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl -n envoy-gateway-system port-forward service/<span style=color:#4e9a06>${</span><span style=color:#000>ENVOY_SERVICE</span><span style=color:#4e9a06>}</span> 8443:443 <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Query the example app through Envoy proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:8443:127.0.0.1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com:8443/get
</span></span></code></pre></div><h3 id=clusters-with-external-loadbalancer-support>Clusters with External LoadBalancer Support</h3><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Query the example app through the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>curl -v -HHost:www.example.com --resolve <span style=color:#4e9a06>&#34;www.example.com:443:</span><span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>--cacert example.com.crt https://www.example.com/get
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-58b87202a450ea245964ef56ac3d2af1>6.26 -</h1><h1 id=udp-routing>UDP Routing</h1><p>The <a href=https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io/v1alpha2.UDPRoute>UDPRoute</a> resource allows users to configure UDP routing by matching UDP traffic and forwarding it to Kubernetes
backends. This guide will use CoreDNS example to walk you through the steps required to configure UDPRoute on Envoy
Gateway.</p><p><strong>Note:</strong> UDPRoute allows Envoy Gateway to operate as a non-transparent proxy between a UDP client and server. The lack
of transparency means that the upstream server will see the source IP and port of the Gateway instead of the client.
For additional information, refer to Envoy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/udp_filters/udp_proxy>UDP proxy documentation</a>.</p><h2 id=prerequisites>Prerequisites</h2><p>Install Envoy Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>helm install eg oci://docker.io/envoyproxy/gateway-helm --version v0.0.0-latest -n envoy-gateway-system --create-namespace
</span></span></code></pre></div><p>Wait for Envoy Gateway to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m -n envoy-gateway-system deployment/envoy-gateway --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><h2 id=installation>Installation</h2><p>Install CoreDNS in the Kubernetes cluster as the example backend. The installed CoreDNS is listening on
UDP port 53 for DNS lookups.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/envoyproxy/gateway/latest/examples/kubernetes/udp-routing-example-backend.yaml
</span></span></code></pre></div><p>Wait for the CoreDNS deployment to become available:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl <span style=color:#204a87>wait</span> --timeout<span style=color:#ce5c00;font-weight:700>=</span>5m deployment/coredns --for<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>condition</span><span style=color:#ce5c00;font-weight:700>=</span>Available
</span></span></code></pre></div><p>Update the Gateway from the Quickstart guide to include a UDP listener that listens on UDP port <code>5300</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl patch gateway eg --type<span style=color:#ce5c00;font-weight:700>=</span>json --patch <span style=color:#4e9a06>&#39;[{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;op&#34;: &#34;add&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;path&#34;: &#34;/spec/listeners/-&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>   &#34;value&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;name&#34;: &#34;coredns&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;protocol&#34;: &#34;UDP&#34;,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;port&#34;: 5300,
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      &#34;allowedRoutes&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>         &#34;kinds&#34;: [{
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>            &#34;kind&#34;: &#34;UDPRoute&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          }]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      }
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    },
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>}]&#39;</span>
</span></span></code></pre></div><p>Verify the Gateway status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get gateway/eg -o yaml
</span></span></code></pre></div><h2 id=configuration>Configuration</h2><p>Create a UDPRoute resource to route UDP traffic received on Gateway port 5300 to the CoredDNS backend.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: UDPRoute
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  parentRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - name: eg
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>      sectionName: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  rules:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - backendRefs:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>        - name: coredns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>          port: 53
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>Verify the UDPRoute status:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl get udproute/coredns -o yaml
</span></span></code></pre></div><h2 id=testing>Testing</h2><p>Get the External IP of the Gateway:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GATEWAY_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get gateway/eg -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.addresses[0].value}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><p>Use <code>dig</code> command to query the dns entry foo.bar.com through the Gateway.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>dig @<span style=color:#4e9a06>${</span><span style=color:#000>GATEWAY_HOST</span><span style=color:#4e9a06>}</span> -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span></code></pre></div><p>You should see the result of the dns query as the below output, which means that the dns query has been successfully
routed to the backend CoreDNS.</p><p>Note: 49.51.177.138 is the resolved address of GATEWAY_HOST.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> &lt;&lt;&gt;&gt; DiG 9.18.1-1ubuntu1.1-Ubuntu &lt;&lt;&gt;&gt; @49.51.177.138 -p <span style=color:#0000cf;font-weight:700>5300</span> foo.bar.com
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> server found<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> global options: +cmd
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Got answer:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> -&gt;&gt;HEADER<span style=color:#4e9a06>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style=color:#0000cf;font-weight:700>58125</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> flags: qr aa rd<span style=color:#000;font-weight:700>;</span> QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: <span style=color:#0000cf;font-weight:700>3</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WARNING: recursion requested but not available
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> OPT PSEUDOSECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> EDNS: version: 0, flags:<span style=color:#000;font-weight:700>;</span> udp: <span style=color:#0000cf;font-weight:700>1232</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span> COOKIE: 24fb86eba96ebf62 <span style=color:#ce5c00;font-weight:700>(</span>echoed<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> QUESTION SECTION:
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;</span>foo.bar.com.			IN	A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> ADDITIONAL SECTION:
</span></span><span style=display:flex><span>foo.bar.com.		0	IN	A	10.244.0.19
</span></span><span style=display:flex><span>_udp.foo.bar.com.	0	IN	SRV	<span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>42376</span> .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> Query time: <span style=color:#0000cf;font-weight:700>1</span> msec
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> SERVER: 49.51.177.138#5300<span style=color:#ce5c00;font-weight:700>(</span>49.51.177.138<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span>UDP<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> WHEN: Fri Jan <span style=color:#0000cf;font-weight:700>13</span> 10:20:34 UTC <span style=color:#0000cf;font-weight:700>2023</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>;;</span> MSG SIZE  rcvd: <span style=color:#0000cf;font-weight:700>114</span>
</span></span></code></pre></div><h2 id=clean-up>Clean-Up</h2><p>Follow the steps from the <a href=quickstart.md>Quickstart Guide</a> to uninstall Envoy Gateway.</p><p>Delete the CoreDNS example manifest and the UDPRoute:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>kubectl delete deploy/coredns
</span></span><span style=display:flex><span>kubectl delete service/coredns
</span></span><span style=display:flex><span>kubectl delete cm/coredns
</span></span><span style=display:flex><span>kubectl delete udproute/coredns
</span></span></code></pre></div><h2 id=next-steps>Next Steps</h2><p>Checkout the <a href=../dev/README.md>Developer Guide</a> to get involved in the project.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=mailto:envoy-users@googlegroups.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Twitter aria-label=Twitter><a target=_blank rel=noopener href=https://twitter.com/EnvoyProxy aria-label=Twitter><i class="fab fa-twitter"></i></a></li></ul></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/envoyproxy/gateway aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Slack aria-label=Slack><a target=_blank rel=noopener href=https://envoyproxy.slack.com/archives/C03E6NHLESV aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2023 The Envoy Gateway Authors All Rights Reserved</span>
<span class=ms-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span><p class="td-footer__about mt-2"><a href=/about/>About Goldydocs</a></p></div></div></div></footer></div><script src=/js/main.min.7c61052b3140e141bdd8468f9521f29a18b7823e8ae447bd506913b6beb037d8.js integrity="sha256-fGEFKzFA4UG92EaPlSHymhi3gj6K5Ee9UGkTtr6wN9g=" crossorigin=anonymous></script>
<script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>