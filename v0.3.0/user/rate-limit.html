
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Rate limit &#8212; Envoy Gateway  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Design Docs" href="../design_docs.html" />
    <link rel="prev" title="Request Authentication" href="authn.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="rate-limit">
<h1>Rate limit<a class="headerlink" href="#rate-limit" title="Permalink to this heading">¶</a></h1>
<p>Rate limit is a feature that allows the user to limit the number of incoming requests to a predefined value based on attributes within the traffic flow.</p>
<p>Here are some reasons why you may want to implements Rate limits</p>
<ul class="simple">
<li><p>To prevent malicious activity such as DDoS attacks.</p></li>
<li><p>To prevent applications and its resources (such as a database) from getting overloaded.</p></li>
<li><p>To create API limits based on user entitlements.</p></li>
</ul>
<p>Envoy Gateway supports <a class="reference external" href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting">Global rate limiting</a>, where the rate limit is common across all the instances of Envoy proxies where its applied
i.e. if the data plane has 2 replicas of Envoy running, and the rate limit is 10 requests/second, this limit is common and will be hit
if 5 requests pass through the first replica and 5 requests pass through the second replica within the same second.</p>
<p>Envoy Gateway introduces a new CRD called <a class="reference external" href="https://gateway.envoyproxy.io/v0.3.0/api/extension_types.html#ratelimitfilter">RateLimitFilter</a> that allows the user to describe their rate limit intent. This instantiated resource
can be linked to a <a class="reference external" href="https://gateway-api.sigs.k8s.io/api-types/httproute/">HTTPRoute</a> resource using an <a class="reference external" href="https://gateway-api.sigs.k8s.io/references/spec/#gateway.networking.k8s.io%2fv1beta1.HTTPRouteFilter">ExtensionRef</a> filter.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h2>
<section id="install-envoy-gateway">
<h3>Install Envoy Gateway<a class="headerlink" href="#install-envoy-gateway" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Follow the steps from the <a class="reference internal" href="quickstart.html"><span class="doc std std-doc">Quickstart Guide</span></a> to install Envoy Gateway and the example manifest.
Before proceeding, you should be able to query the example backend using HTTP.</p></li>
</ul>
</section>
<section id="install-redis">
<h3>Install Redis<a class="headerlink" href="#install-redis" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>The global rate limit feature is based on <a class="reference external" href="https://github.com/envoyproxy/ratelimit">Envoy Ratelimit</a> which requires a Redis instance as its caching layer.
Lets install a Redis deployment in the <code class="docutils literal notranslate"><span class="pre">redis-system</span></code> namespce.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">kind: Namespace</span>
<span class="s">apiVersion: v1</span>
<span class="s">metadata:</span>
<span class="s">  name: redis-system </span>
<span class="s">---</span>
<span class="s">apiVersion: apps/v1</span>
<span class="s">kind: Deployment</span>
<span class="s">metadata:</span>
<span class="s">  name: redis</span>
<span class="s">  namespace: redis-system</span>
<span class="s">  labels:</span>
<span class="s">    app: redis</span>
<span class="s">spec:</span>
<span class="s">  replicas: 1</span>
<span class="s">  selector:</span>
<span class="s">    matchLabels:</span>
<span class="s">      app: redis</span>
<span class="s">  template:</span>
<span class="s">    metadata:</span>
<span class="s">      labels:</span>
<span class="s">        app: redis</span>
<span class="s">    spec:</span>
<span class="s">      containers:</span>
<span class="s">      - image: redis:6.0.6</span>
<span class="s">        imagePullPolicy: IfNotPresent</span>
<span class="s">        name: redis</span>
<span class="s">        resources:</span>
<span class="s">          limits:</span>
<span class="s">            cpu: 1500m</span>
<span class="s">            memory: 512Mi</span>
<span class="s">          requests:</span>
<span class="s">            cpu: 200m</span>
<span class="s">            memory: 256Mi</span>
<span class="s">---</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Service</span>
<span class="s">metadata:</span>
<span class="s">  name: redis</span>
<span class="s">  namespace: redis-system </span>
<span class="s">  labels:</span>
<span class="s">    app: redis</span>
<span class="s">  annotations:</span>
<span class="s">spec:</span>
<span class="s">  ports:</span>
<span class="s">  - name: redis</span>
<span class="s">    port: 6379</span>
<span class="s">    protocol: TCP</span>
<span class="s">    targetPort: 6379</span>
<span class="s">  selector:</span>
<span class="s">    app: redis</span>
<span class="s">---</span>

<span class="s">EOF</span>
</pre></div>
</div>
</section>
<section id="enable-global-rate-limit-in-envoy-gateway">
<h3>Enable Global Rate limit in Envoy Gateway<a class="headerlink" href="#enable-global-rate-limit-in-envoy-gateway" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>The default installation of Envoy Gateway installs a default <a class="reference external" href="https://gateway.envoyproxy.io/v0.3.0/api/config_types.html#envoygateway">EnvoyGateway</a> configuration and attaches it
using a <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>. In the next step, we will update this resource to enable rate limit in Envoy Gateway
as well as configure the URL for the Redis instance used for Global rate limiting.</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: ConfigMap</span>
<span class="s">metadata:</span>
<span class="s">  name: envoy-gateway-config</span>
<span class="s">  namespace: envoy-gateway-system</span>
<span class="s">data:</span>
<span class="s">  envoy-gateway.yaml: |</span>
<span class="s">    apiVersion: config.gateway.envoyproxy.io/v1alpha1</span>
<span class="s">    kind: EnvoyGateway</span>
<span class="s">    provider:</span>
<span class="s">      type: Kubernetes</span>
<span class="s">    gateway:</span>
<span class="s">      controllerName: gateway.envoyproxy.io/gatewayclass-controller</span>
<span class="s">    rateLimit:</span>
<span class="s">      backend:</span>
<span class="s">        type: Redis</span>
<span class="s">        redis:</span>
<span class="s">          url: redis.redis-system.svc.cluster.local:6379</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>After updating the <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>, you will need to restart the <code class="docutils literal notranslate"><span class="pre">envoy-gateway</span></code> deployment so the configuration kicks in</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>rollout<span class="w"> </span>restart<span class="w"> </span>deployment<span class="w"> </span>envoy-gateway<span class="w"> </span>-n<span class="w"> </span>envoy-gateway-system
</pre></div>
</div>
</section>
</section>
<section id="rate-limit-specific-user">
<h2>Rate limit specific user<a class="headerlink" href="#rate-limit-specific-user" title="Permalink to this heading">¶</a></h2>
<p>Here is an example of a rate limit implemented by the application developer to limit a specific user by matching on a custom <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> header
with a value set to <code class="docutils literal notranslate"><span class="pre">one</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.envoyproxy.io/v1alpha1</span>
<span class="s">kind: RateLimitFilter</span>
<span class="s">metadata:</span>
<span class="s">  name: ratelimit-specific-user</span>
<span class="s">spec:</span>
<span class="s">  type: Global</span>
<span class="s">  global:</span>
<span class="s">    rules:</span>
<span class="s">    - clientSelectors:</span>
<span class="s">      - headers:</span>
<span class="s">        - name: x-user-id</span>
<span class="s">          value: one</span>
<span class="s">      limit:</span>
<span class="s">        requests: 3</span>
<span class="s">        unit: Hour</span>
<span class="s">---</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-ratelimit</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - ratelimit.example </span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    filters:</span>
<span class="s">    - type: ExtensionRef</span>
<span class="s">      extensionRef:</span>
<span class="s">        group: gateway.envoyproxy.io</span>
<span class="s">        kind: RateLimitFilter</span>
<span class="s">        name: ratelimit-specific-user</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>The HTTPRoute status should indicate that it has been accepted and is bound to the example Gateway.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>httproute/http-ratelimit<span class="w"> </span>-o<span class="w"> </span>yaml
</pre></div>
</div>
<p>Get the Gateway’s address:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">GATEWAY_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl<span class="w"> </span>get<span class="w"> </span>gateway/eg<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.addresses[0].value}&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Lets query <code class="docutils literal notranslate"><span class="pre">ratelimit.example/get</span></code> 4 times. We should receive a <code class="docutils literal notranslate"><span class="pre">200</span></code> response from the example Gateway for the first 3 requests
and then receive a <code class="docutils literal notranslate"><span class="pre">429</span></code> status code for the 4th request since the limit is set at 3 requests/Hour for the request which contains the header <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code>
and value <code class="docutils literal notranslate"><span class="pre">one</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>-I<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: ratelimit.example&quot;</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;x-user-id: one&quot;</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span>/get<span class="w"> </span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:31 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 4</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:32 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 2</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:33 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 429 Too Many Requests</span>
<span class="go">x-envoy-ratelimited: true</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:34 GMT</span>
<span class="go">server: envoy</span>
<span class="go">transfer-encoding: chunked</span>
</pre></div>
</div>
<p>You should be able to send requests with the <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> header and a different value and receive successful responses from the server.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>-I<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: ratelimit.example&quot;</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;x-user-id: two&quot;</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span>/get<span class="w"> </span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:34:36 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:34:37 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:34:38 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:34:39 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>
</pre></div>
</div>
</section>
<section id="rate-limit-distinct-users">
<h2>Rate limit distinct users<a class="headerlink" href="#rate-limit-distinct-users" title="Permalink to this heading">¶</a></h2>
<p>Here is an example of a rate limit implemented by the application developer to limit distinct users who can be differentiated based on the
value in the <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> header. Here, user <code class="docutils literal notranslate"><span class="pre">one</span></code> (recognised from the traffic flow using the header <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> and value <code class="docutils literal notranslate"><span class="pre">one</span></code>) will be rate limited at 3 requests/hour
and so will user <code class="docutils literal notranslate"><span class="pre">two</span></code> (recognised from the traffic flow using the header <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> and value <code class="docutils literal notranslate"><span class="pre">two</span></code>).</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.envoyproxy.io/v1alpha1</span>
<span class="s">kind: RateLimitFilter</span>
<span class="s">metadata:</span>
<span class="s">  name: ratelimit-distinct-users</span>
<span class="s">spec:</span>
<span class="s">  type: Global</span>
<span class="s">  global:</span>
<span class="s">    rules:</span>
<span class="s">    - clientSelectors:</span>
<span class="s">      - headers:</span>
<span class="s">        - type: Distinct</span>
<span class="s">          name: x-user-id</span>
<span class="s">      limit:</span>
<span class="s">        requests: 3</span>
<span class="s">        unit: Hour</span>
<span class="s">---</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-ratelimit</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - ratelimit.example </span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    filters:</span>
<span class="s">    - type: ExtensionRef</span>
<span class="s">      extensionRef:</span>
<span class="s">        group: gateway.envoyproxy.io</span>
<span class="s">        kind: RateLimitFilter</span>
<span class="s">        name: ratelimit-distinct-users</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Lets run the same command again with the header <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> and value <code class="docutils literal notranslate"><span class="pre">one</span></code> set in the request. We should the first 3 requests succeeding and
the 4th request being rate limited.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>-I<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: ratelimit.example&quot;</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;x-user-id: one&quot;</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span>/get<span class="w"> </span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:31 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 4</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:32 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 2</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:33 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 429 Too Many Requests</span>
<span class="go">x-envoy-ratelimited: true</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:34 GMT</span>
<span class="go">server: envoy</span>
<span class="go">transfer-encoding: chunked</span>
</pre></div>
</div>
<p>You should see the same behavior when the value for header <code class="docutils literal notranslate"><span class="pre">x-user-id</span></code> is set to <code class="docutils literal notranslate"><span class="pre">two</span></code> and 4 requests are sent.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>-I<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: ratelimit.example&quot;</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;x-user-id: two&quot;</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span>/get<span class="w"> </span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:31 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 4</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:32 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 2</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:33 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 429 Too Many Requests</span>
<span class="go">x-envoy-ratelimited: true</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:34 GMT</span>
<span class="go">server: envoy</span>
<span class="go">transfer-encoding: chunked</span>
</pre></div>
</div>
</section>
<section id="rate-limit-all-requests">
<h2>Rate limit all requests<a class="headerlink" href="#rate-limit-all-requests" title="Permalink to this heading">¶</a></h2>
<p>This example shows you how to rate limit all requests matching the HTTPRoute rule at 3 requests/Hour by leaving the <code class="docutils literal notranslate"><span class="pre">clientSelectors</span></code> field unset.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
<span class="s">apiVersion: gateway.envoyproxy.io/v1alpha1</span>
<span class="s">kind: RateLimitFilter</span>
<span class="s">metadata:</span>
<span class="s">  name: ratelimit-all-requests</span>
<span class="s">spec:</span>
<span class="s">  type: Global</span>
<span class="s">  global:</span>
<span class="s">    rules:</span>
<span class="s">    - limit:</span>
<span class="s">        requests: 3</span>
<span class="s">        unit: Hour</span>
<span class="s">---</span>
<span class="s">apiVersion: gateway.networking.k8s.io/v1beta1</span>
<span class="s">kind: HTTPRoute</span>
<span class="s">metadata:</span>
<span class="s">  name: http-ratelimit</span>
<span class="s">spec:</span>
<span class="s">  parentRefs:</span>
<span class="s">  - name: eg</span>
<span class="s">  hostnames:</span>
<span class="s">  - ratelimit.example </span>
<span class="s">  rules:</span>
<span class="s">  - matches:</span>
<span class="s">    - path:</span>
<span class="s">        type: PathPrefix</span>
<span class="s">        value: /</span>
<span class="s">    filters:</span>
<span class="s">    - type: ExtensionRef</span>
<span class="s">      extensionRef:</span>
<span class="s">        group: gateway.envoyproxy.io</span>
<span class="s">        kind: RateLimitFilter</span>
<span class="s">        name: ratelimit-all-requests</span>
<span class="s">    backendRefs:</span>
<span class="s">    - group: &quot;&quot;</span>
<span class="s">      kind: Service</span>
<span class="s">      name: backend</span>
<span class="s">      port: 3000</span>
<span class="s">EOF</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>i<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">{</span><span class="m">1</span>..4<span class="o">}</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>curl<span class="w"> </span>-I<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Host: ratelimit.example&quot;</span><span class="w"> </span>http://<span class="si">${</span><span class="nv">GATEWAY_HOST</span><span class="si">}</span>/get<span class="w"> </span><span class="p">;</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:31 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 4</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:32 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 2</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 200 OK</span>
<span class="go">content-type: application/json</span>
<span class="go">x-content-type-options: nosniff</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:33 GMT</span>
<span class="go">content-length: 460</span>
<span class="go">x-envoy-upstream-service-time: 0</span>
<span class="go">server: envoy</span>

<span class="go">HTTP/1.1 429 Too Many Requests</span>
<span class="go">x-envoy-ratelimited: true</span>
<span class="go">date: Wed, 08 Feb 2023 02:33:34 GMT</span>
<span class="go">server: envoy</span>
<span class="go">transfer-encoding: chunked</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Envoy Gateway</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/compatibility.html">Compatibility Matrix</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../user_docs.html">User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs.html">Design Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_docs.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_docs.html">About the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_involved.html">Getting Involved</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../user_docs.html">User Guides</a><ul>
      <li>Previous: <a href="authn.html" title="previous chapter">Request Authentication</a></li>
      <li>Next: <a href="../design_docs.html" title="next chapter">Design Docs</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Envoy Gateway Project Authors | <a href="https://github.com/envoyproxy/gateway">GitHub</a> | <a href="/latest">Latest Docs</a>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/user/rate-limit.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>