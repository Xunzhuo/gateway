
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Watching Components Design &#8212; Envoy Gateway  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Configuration API Design" href="config-api.html" />
    <link rel="prev" title="Gateway API Translator Design" href="gatewayapi-translator.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="watching-components-design">
<h1>Watching Components Design<a class="headerlink" href="#watching-components-design" title="Permalink to this heading">¶</a></h1>
<p>Envoy Gateway is made up of several components that communicate in-process.  Some of them (namely Providers) watch
external resources, and “publish” what they see for other components to consume; others watch what another publishes and
act on it (such as the resource translator watches what the providers publish, and then publishes its own results that
are watched by another component).  Some of these internally published results are consumed by multiple components.</p>
<p>To facilitate this communication use the <a class="reference external" href="https://pkg.go.dev/github.com/telepresenceio/watchable">watchable</a> library.  The <code class="docutils literal notranslate"><span class="pre">watchable.Map</span></code> type is very similar to the
standard library’s <code class="docutils literal notranslate"><span class="pre">sync.Map</span></code> type, but supports a <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> (and <code class="docutils literal notranslate"><span class="pre">.SubscribeSubset</span></code>) method that promotes a pub/sub
pattern.</p>
<section id="pub">
<h2>Pub<a class="headerlink" href="#pub" title="Permalink to this heading">¶</a></h2>
<p>Many of the things we communicate around are naturally named, either by a bare “name” string or by a “name”/”namespace”
tuple.  And because <code class="docutils literal notranslate"><span class="pre">watchable.Map</span></code> is typed, it makes sense to have one map for each type of thing (very similar to if
we were using native Go <code class="docutils literal notranslate"><span class="pre">map</span></code>s).  For example, a struct that might be written to by the Kubernetes provider, and read by
the IR translator:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">ResourceTable</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// gateway classes are cluster-scoped; no namespace</span>
<span class="w">    </span><span class="nx">GatewayClasses</span><span class="w"> </span><span class="nx">watchable</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">gwapiv1b1</span><span class="p">.</span><span class="nx">GatewayClass</span><span class="p">]</span>

<span class="w">    </span><span class="c1">// gateways are namespace-scoped, so use a k8s.io/apimachinery/pkg/types.NamespacedName as the map key.</span>
<span class="w">    </span><span class="nx">Gateways</span><span class="w"> </span><span class="nx">watchable</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">gwapiv1b1</span><span class="p">.</span><span class="nx">Gateway</span><span class="p">]</span>

<span class="w">    </span><span class="nx">HTTPRoutes</span><span class="w"> </span><span class="nx">watchable</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="nx">types</span><span class="p">.</span><span class="nx">NamespacedName</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">gwapiv1b1</span><span class="p">.</span><span class="nx">HTTPRoute</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Kubernetes provider updates the table by calling <code class="docutils literal notranslate"><span class="pre">table.Thing.Store(name,</span> <span class="pre">val)</span></code> and <code class="docutils literal notranslate"><span class="pre">table.Thing.Delete(name)</span></code>;
updating a map key with a value that is deep-equal (usually <code class="docutils literal notranslate"><span class="pre">reflect.DeepEqual</span></code>, but you can implement your own <code class="docutils literal notranslate"><span class="pre">.Equal</span></code>
method) the current value is a no-op; it won’t trigger an event for subscribers.  This is handy so that the publisher
doesn’t have as much state to keep track of; it doesn’t need to know “did I already publish this thing”, it can just
<code class="docutils literal notranslate"><span class="pre">.Store</span></code> its data and <code class="docutils literal notranslate"><span class="pre">watchable</span></code> will do the right thing.</p>
</section>
<section id="sub">
<h2>Sub<a class="headerlink" href="#sub" title="Permalink to this heading">¶</a></h2>
<p>Meanwhile, the translator and other interested components subscribe to it with <code class="docutils literal notranslate"><span class="pre">table.Thing.Subscribe</span></code> (or
<code class="docutils literal notranslate"><span class="pre">table.Thing.SubscribeSubset</span></code> if they only care about a few “Thing”s).  So the translator goroutine might look like:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">HTTPRoutes</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fullState</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">irInput</span><span class="p">{</span>
<span class="w">           </span><span class="nx">GatewayClasses</span><span class="p">:</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">GatewayClasses</span><span class="p">.</span><span class="nx">LoadAll</span><span class="p">(),</span>
<span class="w">           </span><span class="nx">Gateways</span><span class="p">:</span><span class="w">       </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">Gateways</span><span class="p">.</span><span class="nx">LoadAll</span><span class="p">(),</span>
<span class="w">           </span><span class="nx">HTTPRoutes</span><span class="p">:</span><span class="w">     </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">translate</span><span class="p">(</span><span class="nx">irInput</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or, to watch multiple maps in the same loop:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">classCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">GatewayClasses</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="nx">gwCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">Gateways</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="nx">routeCh</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">HTTPRoutes</span><span class="p">.</span><span class="nx">Subscribe</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">arg</span><span class="w"> </span><span class="nx">irInput</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">classCh</span><span class="p">:</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">GatewayClasses</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">State</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">gwCh</span><span class="p">:</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Gateways</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">State</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">snapshot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">routeCh</span><span class="p">:</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Routes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">State</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">GateWayClasses</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">GatewayClasses</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">GateWayClasses</span><span class="p">.</span><span class="nx">LoadAll</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">GateWays</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">Gateways</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">GateWays</span><span class="p">.</span><span class="nx">LoadAll</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">arg</span><span class="p">.</span><span class="nx">HTTPRoutes</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">arg</span><span class="p">.</span><span class="nx">HTTPRoutes</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">k8sTable</span><span class="p">.</span><span class="nx">HTTPRoutes</span><span class="p">.</span><span class="nx">LoadAll</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">translate</span><span class="p">(</span><span class="nx">irInput</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From the updates it gets from <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code>, it can get a full view of the map being subscribed to via <code class="docutils literal notranslate"><span class="pre">snapshot.State</span></code>;
but it must read the other maps explicitly.  Like <code class="docutils literal notranslate"><span class="pre">sync.Map</span></code>, <code class="docutils literal notranslate"><span class="pre">watchable.Map</span></code>s are thread-safe; while <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> is a
handy way to know when to run, <code class="docutils literal notranslate"><span class="pre">.Load</span></code> and friends can be used without subscribing.</p>
<p>There can be any number of subscribers.  For that matter, there can be any number of publishers <code class="docutils literal notranslate"><span class="pre">.Store</span></code>ing things, but
it’s probably wise to just have one publisher for each map.</p>
<p>The channel returned from <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> <strong>is immediately readable</strong> with a snapshot of the map as it existed when
<code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> was called; and becomes readable again whenever <code class="docutils literal notranslate"><span class="pre">.Store</span></code> or <code class="docutils literal notranslate"><span class="pre">.Delete</span></code> mutates the map.  If multiple
mutations happen between reads (or if mutations happen between <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> and the first read), they are coalesced in
to one snapshot to be read; the <code class="docutils literal notranslate"><span class="pre">snapshot.State</span></code> is the most-recent full state, and <code class="docutils literal notranslate"><span class="pre">snapshot.Updates</span></code> is a listing of
each of the mutations that cause this snapshot to be different than the last-read one.  This way subscribers don’t need
to worry about a backlog accumulating if they can’t keep up with the rate of changes from the publisher.</p>
<p>If the map contains anything before <code class="docutils literal notranslate"><span class="pre">.Subscribe</span></code> is called, that very first read won’t include <code class="docutils literal notranslate"><span class="pre">snapshot.Updates</span></code>
entries for those pre-existing items; if you are working with <code class="docutils literal notranslate"><span class="pre">snapshot.Update</span></code> instead of <code class="docutils literal notranslate"><span class="pre">snapshot.State</span></code>, then you
must add special handling for your first read.  We have a utility function <code class="docutils literal notranslate"><span class="pre">./internal/message.HandleSubscription</span></code> to
help with this.</p>
</section>
<section id="other-notes">
<h2>Other Notes<a class="headerlink" href="#other-notes" title="Permalink to this heading">¶</a></h2>
<p>The common pattern will likely be that the entrypoint that launches the goroutines for each component instantiates the
map, and passes them to the appropriate publishers and subscribers; same as if they were communicating via a dumb
<code class="docutils literal notranslate"><span class="pre">chan</span></code>.</p>
<p>A limitation of <code class="docutils literal notranslate"><span class="pre">watchable.Map</span></code> is that in order to ensure safety between goroutines, it does require that value types
be deep-copiable; either by having a <code class="docutils literal notranslate"><span class="pre">DeepCopy</span></code> method, being a <code class="docutils literal notranslate"><span class="pre">proto.Message</span></code>, or by containing no reference types and
so can be deep-copied by naive assignment.  Fortunately, we’re using <code class="docutils literal notranslate"><span class="pre">controller-gen</span></code> anyway, and <code class="docutils literal notranslate"><span class="pre">controller-gen</span></code> can
generate <code class="docutils literal notranslate"><span class="pre">DeepCopy</span></code> methods for us: just stick a <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">+k8s:deepcopy-gen=true</span></code> on the types that you want it to generate
methods for.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Envoy Gateway</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/compatibility.html">Compatibility Matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_docs.html">User Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../design_docs.html">Design Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_docs.html">Developer Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_docs.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about_docs.html">About the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../get_involved.html">Getting Involved</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../design_docs.html">Design Docs</a><ul>
      <li>Previous: <a href="gatewayapi-translator.html" title="previous chapter">Gateway API Translator Design</a></li>
      <li>Next: <a href="config-api.html" title="next chapter">Configuration API Design</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Envoy Gateway Project Authors | <a href="https://github.com/envoyproxy/gateway">GitHub</a> | <a href="/latest">Latest Docs</a>.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../_sources/design/watching.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>